<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Easy Log v25.12</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Engines (Using cdnjs for better stability) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
        body { overscroll-behavior-y: contain; -webkit-tap-highlight-color: transparent; }
        button { touch-action: manipulation; }
        
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #f3f4f6; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 9999;
            font-family: sans-serif; transition: opacity 0.5s;
        }
        
        #error-message {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #fee2e2; color: #7f1d1d; padding: 20px; z-index: 10000;
            font-family: monospace; white-space: pre-wrap; overflow: auto;
            display: none; /* Initially hidden */
        }

        .spinner {
            width: 50px; height: 50px; border: 5px solid #e5e7eb;
            border-top: 5px solid #3b82f6; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .radio-label input:checked + div {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }
        /* Screen Reader Only Class */
        .sr-only {
            position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
            overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans pb-20">
    
    <div id="loading-screen" role="alert" aria-live="assertive">
        <div class="spinner" aria-hidden="true"></div>
        <h1 class="text-xl font-bold text-gray-700">Loading Easy Log...</h1>
    </div>

    <div id="error-message"></div>
    <div id="root"></div>

    <!-- FAILSAFE: If React fails to load, remove spinner and show error -->
    <script>
        window.onerror = function(msg, url, line) {
            const loader = document.getElementById('loading-screen');
            const errDiv = document.getElementById('error-message');
            if (loader) loader.style.display = 'none';
            if (errDiv) {
                errDiv.style.display = 'block';
                errDiv.innerHTML = "<strong>Error Loading App:</strong>\n" + msg + "\nLine: " + line;
            }
        };
        
        // Timeout check
        setTimeout(function() {
            const root = document.getElementById('root');
            if (!root || root.innerHTML.trim() === '') {
                const loader = document.getElementById('loading-screen');
                if (loader && loader.style.display !== 'none') {
                    // Try to hide it anyway so user isn't stuck
                    loader.style.display = 'none';
                    const errDiv = document.getElementById('error-message');
                    if (errDiv && errDiv.style.display === 'none') {
                        errDiv.style.display = 'block';
                        errDiv.innerHTML = "<strong>Timeout:</strong> The app is taking too long to start. Please try refreshing.";
                    }
                }
            }
        }, 5000);
    </script>

    <script type="text/babel">
        // Use a safer way to get React hooks in case destructuring fails
        const useState = React.useState;
        const useEffect = React.useEffect;
        const useRef = React.useRef;
        const useMemo = React.useMemo;

        // --- AUDIO ENGINE ---
        const audioCtxRef = { current: null };
        const playSound = (type) => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                if (!audioCtxRef.current) audioCtxRef.current = new AudioContext();
                if (audioCtxRef.current.state === 'suspended') audioCtxRef.current.resume().catch(e => console.log(e));
                const ctx = audioCtxRef.current;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                const now = ctx.currentTime;
                if (type === 'success') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(880, now); 
                    osc.frequency.exponentialRampToValueAtTime(1760, now + 0.1); 
                    gain.gain.setValueAtTime(0.3, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                    osc.start(now); osc.stop(now + 0.5);
                } else if (type === 'skip') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(300, now);
                    osc.frequency.linearRampToValueAtTime(50, now + 0.2);
                    gain.gain.setValueAtTime(0.2, now);
                    gain.gain.linearRampToValueAtTime(0.01, now + 0.2);
                    osc.start(now); osc.stop(now + 0.2);
                }
            } catch (e) { console.error("Audio error", e); }
        };

        // --- Icon Set ---
        const IconWrapper = ({ children }) => <span aria-hidden="true" focusable="false" className="pointer-events-none">{children}</span>;

        const Icons = {
            Activity: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></IconWrapper>,
            AlertTriangle: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg></IconWrapper>,
            ArrowRight: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg></IconWrapper>,
            ArrowLeft: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg></IconWrapper>,
            Check: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="20 6 9 17 4 12"/></svg></IconWrapper>,
            CheckCircle: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></IconWrapper>,
            ChevronDown: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m6 9 6 6 6-6"/></svg></IconWrapper>,
            Circle: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/></svg></IconWrapper>,
            Clipboard: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></svg></IconWrapper>,
            Clock: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></IconWrapper>,
            Database: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg></IconWrapper>,
            Download: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg></IconWrapper>,
            Dumbbell: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m2 6 4-4"/><path d="m3 10 7-7"/><path d="m14 21 7-7"/></svg></IconWrapper>,
            Edit2: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg></IconWrapper>,
            FileText: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg></IconWrapper>,
            Home: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></IconWrapper>,
            Hourglass: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M5 22h14"/><path d="M5 2h14"/><path d="M17 22v-4.172a2 2 0 0 0-.586-1.414L12 12l-4.414 4.414A2 2 0 0 0 7 17.828V22"/><path d="M7 2v4.172a2 2 0 0 0 .586 1.414L12 12l4.414-4.414A2 2 0 0 0 17 6.172V2"/></svg></IconWrapper>,
            List: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg></IconWrapper>,
            Plus: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg></IconWrapper>,
            RefreshCw: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg></IconWrapper>,
            Save: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg></IconWrapper>,
            Settings: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg></IconWrapper>,
            SkipForward: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="5 4 15 12 5 20 5 4"/><line x1="19" x2="19" y1="5" y2="19"/></svg></IconWrapper>,
            Trash2: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg></IconWrapper>,
            Upload: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg></IconWrapper>,
            X: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></IconWrapper>,
            Heart: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg></IconWrapper>,
            User: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></IconWrapper>
        };

        // --- Default Database ---
        const DEFAULT_DB = {
            'Upper Body': ['Bench Press', 'Overhead Press', 'Pull Ups', 'Dumbbell Rows', 'Bicep Curls', 'Tricep Dips', 'Lat Pulldown', 'Chest Fly', 'Face Pulls', 'Push Ups'],
            'Lower Body': ['Squats', 'Deadlifts', 'Lunges', 'Leg Press', 'Romanian Deadlifts', 'Calf Raises', 'Leg Extensions', 'Hamstring Curls', 'Goblet Squats'],
            'Core': ['Plank', 'Crunches', 'Leg Raises', 'Russian Twists', 'Ab Wheel', 'Bicycle Crunches', 'Hanging Leg Raises', 'Side Plank']
        };

        // --- Utility Functions ---
        const getRoutineForDay = (date) => {
            const day = date.getDay(); 
            if (day === 1 || day === 4) return 'Lower Body';
            if (day === 2 || day === 5) return 'Upper Body';
            return 'Core';
        };

        const formatDate = (date) => {
            return new Intl.DateTimeFormat('en-US', { weekday: 'long', month: 'long', day: 'numeric' }).format(date);
        };

        const getGreeting = () => {
            const hour = new Date().getHours();
            if (hour < 12) return "Good Morning";
            if (hour < 17) return "Good Afternoon";
            return "Good Evening";
        };

        const triggerHaptic = () => {
            if (window.navigator && window.navigator.vibrate) {
                window.navigator.vibrate(50);
            }
        };

        const calculateBMI = (weight, height) => {
            if (!weight || !height) return { val: '--', status: 'Unknown' };
            const w = parseFloat(weight);
            const h = parseFloat(height);
            if (w <= 0 || h <= 0) return { val: '--', status: 'Unknown' };
            
            const bmi = (703 * w) / (h * h);
            const val = bmi.toFixed(1);
            let status = 'Normal';
            if (bmi < 18.5) status = 'Underweight';
            else if (bmi >= 25 && bmi < 29.9) status = 'Overweight';
            else if (bmi >= 30) status = 'Obese';
            
            return { val, status };
        };

        const calculateMHR = (age) => {
            if (!age || age <= 0) return { fox: '--', tanaka: '--' };
            const fox = Math.round(220 - age);
            const tanaka = Math.round(208 - (0.7 * age));
            return { fox, tanaka };
        };

        const getTimeAgo = (dateString) => {
            if (!dateString) return '';
            const diff = new Date() - new Date(dateString);
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            if (days === 0) return "Today";
            if (days === 1) return "Yesterday";
            return `${days} days ago`;
        };

        // --- ADJUSTABLE INPUT COMPONENT (Fixed for VoiceOver) ---
        function AdjustableInput({ id, label, value, onChange, step, unit, min=0, max=9999 }) {
            const [isManual, setIsManual] = useState(false);
            const inputRef = useRef(null);
            const spinRef = useRef(null);

            const currentVal = value === '' ? min : parseFloat(value);
            // This is what VoiceOver will announce when values change
            const ariaValueText = `${value || min} ${unit}`;

            const adjust = (direction) => {
                triggerHaptic();
                playSound(direction === 'up' ? 'success' : 'skip'); 
                
                // Use a factor to safely multiply/divide floating point steps for accurate arithmetic
                const factor = step < 1 ? 100 : 1; 
                
                const cleanCurrentVal = Math.round(currentVal * factor);
                const cleanStep = Math.round(step * factor);

                let newVal;
                if (direction === 'up') newVal = (cleanCurrentVal + cleanStep) / factor;
                else newVal = (cleanCurrentVal - cleanStep) / factor;
                
                // Ensure correct formatting for display (e.g., 10.0 instead of 10)
                const formattedNewVal = step < 1 ? newVal.toFixed(1) : newVal.toString();

                if (newVal < min) newVal = min;
                if (newVal > max) newVal = max;
                
                onChange(newVal.toString()); // Pass the numerical string back
            };

            const handleKeyDown = (e) => {
                if (e.key === 'ArrowUp') { e.preventDefault(); adjust('up'); }
                if (e.key === 'ArrowDown') { e.preventDefault(); adjust('down'); }
            };

            useEffect(() => {
                if (isManual && inputRef.current) inputRef.current.focus();
                if (!isManual && spinRef.current) spinRef.current.focus();
            }, [isManual]);

            if (isManual) {
                return (
                    <div className="mb-4">
                         {/* Visually visible label, hidden from VoiceOver so it doesn't double-announce when input is focused */}
                         <label htmlFor={id} className="block text-sm font-bold text-gray-800 mb-1 capitalize" aria-hidden="true">{label}</label>
                        <div className="flex gap-2">
                            <input 
                                ref={inputRef} id={id} type="text" inputMode="decimal"
                                value={value} onChange={(e) => onChange(e.target.value)}
                                onBlur={() => setIsManual(false)}
                                className="w-full p-4 text-xl border-2 border-blue-500 rounded bg-white"
                                aria-label={label} /* Label provided directly on the input */
                            />
                             <button onClick={() => setIsManual(false)} className="bg-gray-200 p-3 rounded font-bold text-sm">Done</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="mb-4">
                    {/* Visual label hidden from screen reader to prevent double reading "Label... Label" */}
                    <div className="block text-sm font-bold text-gray-800 mb-1 capitalize" aria-hidden="true">{label}</div>
                    
                    <div 
                        ref={spinRef} role="spinbutton" tabIndex="0"
                        // 1. Label directly on control (Fixes double reading)
                        aria-label={label} 
                        // 2. Value logic
                        aria-valuenow={currentVal} 
                        // 3. Readable text (Fixes percentage issue)
                        aria-valuetext={ariaValueText}
                        aria-valuemin={min} aria-valuemax={max} 
                        onKeyDown={handleKeyDown} onClick={() => setIsManual(true)}
                        className="adjustable-input w-full p-4 text-xl border border-gray-400 rounded bg-white flex justify-between items-center cursor-pointer active:bg-gray-100"
                    >
                        {/* Visual value for sighted users */}
                        <span className="font-bold text-2xl">{value || min} <span className="text-sm text-gray-500">{unit}</span></span>
                        {/* Swipe instructions hidden from VoiceOver */}
                        <span aria-hidden="true" className="text-gray-500 text-sm font-medium uppercase">Swipe Up/Down</span>
                    </div>
                </div>
            );
        }


        // --- SPLASH SCREEN COMPONENT ---
        function SplashScreen({ onGoToMenu, routine, history, currentSession, onBonus, onJumpToCardio, onJumpToWeights, onChangeRoutine, onVitals }) {
            const [greeting] = useState(getGreeting());
            
            // Failsafe to remove loader once React mounts
            useEffect(() => {
                const loader = document.getElementById('loading-screen');
                if(loader) loader.style.display = 'none';
            }, []);
            
            const { progress, allDone, completedCount, isStrengthDoneToday } = useMemo(() => {
                const todayStr = new Date().toLocaleDateString();
                const todayEntries = history.filter(h => new Date(h.date).toLocaleDateString() === todayStr);
                
                const isWeightsSaved = todayEntries.some(h => !h.isCardio && !h.isBonus && !h.isVital);
                const isWeightsInProgress = !isWeightsSaved && (currentSession && currentSession.length > 0);

                const p = {
                    hiit: todayEntries.some(h => h.isCardio && h.activity === 'HIIT Run') ? 'done' : 'todo',
                    cycle: todayEntries.some(h => h.isCardio && h.activity === 'Indoor Cycle') ? 'done' : 'todo',
                    endurance: todayEntries.some(h => h.isCardio && ['Endurance Run', 'Tempo Run', 'Progressive Run', 'ETP Run'].includes(h.activity)) ? 'done' : 'todo',
                    incline: todayEntries.some(h => h.isCardio && h.activity === 'Incline Walk') ? 'done' : 'todo',
                    weights: isWeightsSaved ? 'done' : (isWeightsInProgress ? 'progress' : 'todo')
                };

                let count = 0;
                if (p.hiit === 'done') count++;
                if (p.cycle === 'done') count++;
                if (p.endurance === 'done') count++;
                if (p.incline === 'done') count++;
                if (p.weights === 'done') count++;

                return { progress: p, allDone: count === 5, completedCount: count, isStrengthDoneToday: isWeightsSaved };
            }, [history, routine, currentSession]);

            const getButtonText = () => {
                if (allDone) return "I'm feeling extra good today! üéâ";
                if (completedCount === 0) return "Let's get this day going";
                const percentage = Math.round((completedCount / 5) * 100);
                if (percentage < 40) return `Off to a good start! (${percentage}% Done)`;
                if (percentage < 60) return `Building momentum... (${percentage}% Done)`;
                if (percentage < 80) return `Over the hump! (${percentage}% Done)`;
                return `Home stretch! (${percentage}% Done)`;
            };

            const StatusIcon = ({ status }) => {
                if (status === 'done') return <span aria-label="Completed"><Icons.CheckCircle className="text-green-500" /></span>;
                if (status === 'progress') return <span aria-label="In Progress"><Icons.Hourglass className="text-orange-400 animate-pulse" /></span>;
                return <span aria-label="Not started"><Icons.Circle className="text-gray-300" /></span>;
            };
            
            const InteractiveRow = ({ label, status, onClick, activityName }) => (
                <button 
                    onClick={() => { triggerHaptic(); onClick(); }} 
                    className="w-full flex items-center justify-between p-2 rounded hover:bg-slate-700 text-left active:bg-slate-600 transition-colors"
                    aria-label={`Log ${label}`} // IMPROVEMENT: Explicit action verb
                >
                    <span className="flex items-center gap-2 text-base">
                        {label} 
                        {/* IMPROVEMENT: Removed redundant visual arrow hint */}
                    </span>
                    <StatusIcon status={status} />
                </button>
            );

            // SAFE CLICK HANDLER
            const handleMainClick = () => {
                triggerHaptic();
                playSound('success');
                try {
                    if (allDone) {
                        onBonus();
                    } else {
                        onGoToMenu();
                    }
                } catch (e) {
                    console.error("Navigation safety catch", e);
                    onGoToMenu(); // Fallback
                }
            };

            return (
                <div className="fixed inset-0 bg-slate-900 text-white z-50 flex flex-col p-6 overflow-y-auto">
                    {/* TOP LEFT: SKIP TO MAIN MENU (IMPROVEMENT: Switched icon and text) */}
                    <div className="flex justify-between w-full mb-6">
                        <button 
                            onClick={() => { triggerHaptic(); onGoToMenu(); }}
                            className="p-3 bg-slate-800 rounded hover:bg-slate-700 flex items-center gap-2 font-bold"
                            aria-label="Skip to Main Menu"
                        >
                            <Icons.SkipForward size={20} /> Skip to Main Menu
                        </button>
                    </div>

                    <div className="flex-1 flex flex-col justify-center space-y-8">
                        <div>
                            {/* IMPROVEMENT: Changed greeting to be more professional and clear */}
                            <h1 className="text-4xl font-bold mb-2">Welcome!</h1>
                            <p className="text-slate-400 text-xl font-medium" aria-label={`Today's Date is ${formatDate(new Date())}`}>
                                Today: {formatDate(new Date())}
                            </p>
                            
                            <div className="flex items-center gap-3 mt-1">
                                {/* IMPROVEMENT: Clearer routine focus statement */}
                                <p className="text-blue-400 text-2xl font-extrabold uppercase tracking-wide" aria-live="polite">
                                    Today's Strength Focus: {routine}
                                </p>
                            </div>
                            
                            {/* CHANGE FOCUS BUTTON (Locked if done) */}
                            <div className="mt-2">
                                {isStrengthDoneToday ? (
                                    <span 
                                        className="bg-green-800 text-green-100 border border-green-600 rounded px-3 py-1 text-sm font-bold inline-block"
                                        aria-live="polite"
                                    >
                                         {/* IMPROVEMENT: More concise logged status */}
                                         {routine} Strength Focus Logged
                                    </span>
                                ) : (
                                    <>
                                        {/* IMPROVEMENT: Clearer screen reader label for dropdown */}
                                        <label htmlFor="change-focus" className="sr-only">Change Strength Focus:</label>
                                        <select 
                                            id="change-focus"
                                            onChange={(e) => { triggerHaptic(); onChangeRoutine(e.target.value); }}
                                            value={routine}
                                            className="bg-slate-800 text-white border border-slate-600 rounded px-2 py-1 text-sm font-bold"
                                            aria-label="Current Strength Focus"
                                        >
                                            <option value="Upper Body">Switch to Upper Body</option>
                                            <option value="Lower Body">Switch to Lower Body</option>
                                            <option value="Core">Switch to Core</option>
                                        </select>
                                    </>
                                )}
                            </div>

                            {/* Removed Active Days/Streak Feature */}
                        </div>

                        <div className="space-y-6">
                            <div className="bg-slate-800 p-5 rounded-xl border border-slate-700">
                                {/* IMPROVEMENT: Morning Session */}
                                <h2 className="text-slate-400 text-sm font-bold uppercase tracking-wider mb-4">Morning Session</h2>
                                <div className="space-y-3 text-lg font-medium">
                                    <InteractiveRow label="HIIT Run" status={progress.hiit} onClick={() => onJumpToCardio('HIIT Run')} />
                                    <InteractiveRow label="Indoor Cycle" status={progress.cycle} onClick={() => onJumpToCardio('Indoor Cycle')} />
                                </div>
                            </div>

                            <div className="bg-slate-800 p-5 rounded-xl border border-slate-700">
                                {/* IMPROVEMENT: Afternoon Session */}
                                <h2 className="text-slate-400 text-sm font-bold uppercase tracking-wider mb-4">Afternoon Session</h2>
                                <div className="space-y-3 text-lg font-medium">
                                    {/* IMPROVEMENT: Use Log verbage */}
                                    <InteractiveRow label={`${routine} Focus`} status={progress.weights} onClick={() => onJumpToWeights(routine)} />
                                    <InteractiveRow label="ETP Run" status={progress.endurance} onClick={() => onJumpToCardio('ETP Run')} />
                                    <InteractiveRow label="Incline Walk" status={progress.incline} onClick={() => onJumpToCardio('Incline Walk')} />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="mt-6 space-y-3">
                         <button 
                            onClick={handleMainClick}
                            className={`w-full text-white font-bold text-xl py-6 rounded-xl shadow-lg active:scale-95 transition-transform ${allDone ? 'bg-green-600 hover:bg-green-500' : 'bg-blue-600 hover:bg-blue-500'}`}
                        >
                            {getButtonText()}
                        </button>
                    </div>
                </div>
            );
        }

        // --- LUCKY GAME VIEW ---
        function LuckyView({ onBack, onSave, availableExercises, history }) {
            const [exercise, setExercise] = useState(null);
            const [sets, setSets] = useState('');
            const [reps, setReps] = useState('');
            const [weight, setWeight] = useState('');
            const mysteryRef = useRef(null);

            const pickRandom = () => {
                const randomName = availableExercises[Math.floor(Math.random() * availableExercises.length)];
                
                // Lookup history (ANY history is fine for lucky mode context)
                let lastData = { sets: '', reps: '', weight: '' };
                for (let i = history.length - 1; i >= 0; i--) {
                    if (history[i].isCardio) continue;
                    const pastExercise = history[i].exercises.find(e => e.name.toLowerCase() === randomName.toLowerCase());
                    if (pastExercise) { lastData = { ...pastExercise }; break; }
                }

                setExercise(randomName);
                setSets(lastData.sets || '3');
                setReps(lastData.reps || '10');
                setWeight(lastData.weight || '');
                
                // Focus Logic
                setTimeout(() => {
                    if(mysteryRef.current) mysteryRef.current.focus();
                }, 100);
            };

            useEffect(() => {
                pickRandom();
            }, []);

            const handleSpin = (isExit) => {
                triggerHaptic();
                playSound('success');
                // Save data
                onSave({ type: 'Strength', name: exercise, sets, reps, weight });
                
                if (isExit) {
                    onBack();
                } else {
                    pickRandom(); // Re-roll
                }
            };

            if (!exercise) return <div className="p-8 text-center font-bold">Spinning...</div>;

            return (
                <div className="space-y-6">
                    <div className="bg-purple-700 text-white p-6 rounded-lg shadow-lg text-center border-4 border-purple-900">
                        <h2 ref={mysteryRef} tabIndex="-1" className="text-2xl font-extrabold uppercase mb-1 focus:outline-none">Mystery Exercise</h2>
                        <p className="text-3xl font-black text-yellow-300">{exercise}</p>
                    </div>

                    <div className="bg-white p-6 rounded-lg shadow-xl border-t-8 border-purple-600 space-y-6">
                        <div className="grid grid-cols-2 gap-4">
                            <div><AdjustableInput id="l-sets" label="Sets" value={sets} onChange={setSets} step={1} unit="" /></div>
                            <div><AdjustableInput id="l-reps" label="Reps" value={reps} onChange={setReps} step={1} unit="" /></div>
                            <div className="col-span-2"><AdjustableInput id="l-weight" label="Weight" value={weight} onChange={setWeight} step={1} unit="pounds" /></div>
                        </div>

                        <div className="flex flex-col gap-3 pt-2">
                            <button onClick={() => handleSpin(false)} className="w-full py-5 bg-purple-600 text-white font-bold text-xl rounded-lg shadow-lg hover:bg-purple-500 border-b-4 border-purple-800 active:border-b-0 active:mt-1">
                                üé≤ Spin Again (Save & Next)
                            </button>
                            <button onClick={() => handleSpin(true)} className="w-full py-4 bg-gray-200 text-gray-800 font-bold text-lg rounded-lg hover:bg-gray-300">
                                üèÅ Cash Out (Save & Exit)
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- NEW ETP MENU VIEW ---
        function ETPMenuView({ onBack, onSelect }) {
            return (
                <div className="space-y-6">
                    <div className="flex items-center gap-2 mb-4">
                        <button onClick={onBack} className="text-gray-600 font-bold flex items-center gap-1 p-2 bg-gray-200 rounded">
                            <Icons.ArrowLeft size={20} /> Back to Menu
                        </button>
                        <h2 className="text-2xl font-bold text-blue-900">ETP Run Type</h2>
                    </div>
                    
                    <div className="space-y-4">
                        <button onClick={() => { triggerHaptic(); onSelect('Endurance Run'); }} className="w-full p-8 bg-blue-600 text-white rounded-xl shadow-lg font-bold text-2xl flex flex-col items-start active:scale-[.99] transition-transform">
                            <span className="flex items-center justify-between w-full">Endurance Run <Icons.ArrowRight size={28} /></span>
                            <span className="text-sm font-medium text-blue-200 mt-1">Memo: Saturday, Sunday, and Monday</span>
                        </button>
                        <button onClick={() => { triggerHaptic(); onSelect('Tempo Run'); }} className="w-full p-8 bg-indigo-600 text-white rounded-xl shadow-lg font-bold text-2xl flex flex-col items-start active:scale-[.99] transition-transform">
                            <span className="flex items-center justify-between w-full">Tempo Run <Icons.ArrowRight size={28} /></span>
                            <span className="text-sm font-medium text-indigo-200 mt-1">Memo: Wednesday and Friday</span>
                        </button>
                        <button onClick={() => { triggerHaptic(); onSelect('Progressive Run'); }} className="w-full p-8 bg-purple-600 text-white rounded-xl shadow-lg font-bold text-2xl flex flex-col items-start active:scale-[.99] transition-transform">
                            <span className="flex items-center justify-between w-full">Progressive Run <Icons.ArrowRight size={28} /></span>
                            <span className="text-sm font-medium text-purple-200 mt-1">Memo: Tuesday and Thursday</span>
                        </button>
                    </div>
                </div>
            );
        }

        // --- VITALS VIEW (UPDATED - READ ONLY FIELDS) ---
        function VitalsView({ history, onSave }) {
            const [age, setAge] = useState('');
            const [height, setHeight] = useState('');
            const [weight, setWeight] = useState('');
            const [waist, setWaist] = useState('');
            const [chest, setChest] = useState('');
            const [biceps, setBiceps] = useState('');
            const [thigh, setThigh] = useState('');
            const [notes, setNotes] = useState('');
            
            // Calculate derived values live
            const bmiData = calculateBMI(weight, height);
            const mhrData = calculateMHR(age);

            // Pre-fill history logic
            useEffect(() => {
                const lastVital = history.slice().reverse().find(h => h.isVital);
                if (lastVital && lastVital.metrics) {
                    const m = lastVital.metrics;
                    if (m.age) setAge(m.age);
                    if (m.height) setHeight(m.height);
                    if (m.weight) setWeight(m.weight);
                    if (m.waist) setWaist(m.waist);
                    if (m.chest) setChest(m.chest);
                    if (m.biceps) setBiceps(m.biceps);
                    if (m.thigh) setThigh(m.thigh);
                }
            }, [history]);

            const handleSave = () => {
                triggerHaptic();
                playSound('success');
                onSave({ 
                    age, height, weight, waist, chest, biceps, thigh, notes,
                    // Legacy support for report generator
                    heightSnapshot: height,
                    ageSnapshot: age
                });
            };

            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded-lg shadow text-center">
                        <h2 className="font-extrabold text-xl text-teal-700 uppercase flex items-center justify-center gap-2"><Icons.Heart size={24} /> Vitals & Body Composition</h2>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <div><AdjustableInput id="v-age" label="Age" value={age} onChange={setAge} step={1} unit="years" /></div>
                        <div><AdjustableInput id="v-height" label="Height" value={height} onChange={setHeight} step={1} unit="inches" /></div>
                    </div>
                    
                    {/* Weight step set to 0.5 as requested */}
                    <div className="col-span-2"><AdjustableInput id="v-weight" label="Weight" value={weight} onChange={setWeight} step={0.5} unit="pounds" /></div>

                    {/* READ-ONLY INFO CARD */}
                    <div className="bg-teal-50 p-4 rounded-xl border-4 border-teal-200 text-center">
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <p className="text-xs font-bold text-teal-800 uppercase tracking-wider">BMI</p>
                                <p className="text-3xl font-black text-teal-900">{bmiData.val}</p>
                                <p className="text-xs font-bold text-teal-700">{bmiData.status}</p>
                            </div>
                            <div className="border-l border-teal-200 pl-2">
                                <p className="text-xs font-bold text-teal-800 uppercase tracking-wider">Maximum Heart Rate</p>
                                <div className="text-sm font-bold text-teal-900 mt-1 text-left">
                                    <p>Fox: {mhrData.fox}</p>
                                    <p>Tanaka: {mhrData.tanaka}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-lg shadow-xl space-y-6">
                        <h3 className="font-bold text-gray-500 uppercase text-sm">Body Measurements (inches)</h3>
                        <div className="grid grid-cols-2 gap-4">
                            <div className="col-span-2"><AdjustableInput id="v-waist" label="Waist Circumference" value={waist} onChange={setWaist} step={0.25} unit="inches" /></div>
                            <div><AdjustableInput id="v-chest" label="Chest Circumference" value={chest} onChange={setChest} step={0.25} unit="inches" /></div>
                            <div><AdjustableInput id="v-biceps" label="Biceps Circumference" value={biceps} onChange={setBiceps} step={0.25} unit="inches" /></div>
                            <div className="col-span-2"><AdjustableInput id="v-thigh" label="Thigh Circumference" value={thigh} onChange={setThigh} step={0.25} unit="inches" /></div>
                        </div>

                        <div>
                            <label className="block text-sm font-bold text-gray-800 mb-1">Notes</label>
                            <textarea value={notes} onChange={e => setNotes(e.target.value)} className="w-full p-3 text-lg border border-gray-400 rounded" rows="2"></textarea>
                        </div>

                        <button onClick={handleSave} className="w-full py-5 bg-teal-600 text-white font-bold text-xl rounded-lg shadow-lg hover:bg-teal-500">
                            Save Vitals
                        </button>
                    </div>
                </div>
            );
        }

        // --- BONUS VIEW ---
        function BonusView({ onBack, onSaveBonus, availableExercises, history, onStartLucky }) {
            const [subMode, setSubMode] = useState('menu'); 
            const [note, setNote] = useState('');
            const [sessionHistory, setSessionHistory] = useState([]);
            const [strengthForm, setStrengthForm] = useState({ name: '', sets: '', reps: '', weight: '' });
            const [cardioActivity, setCardioActivity] = useState(''); 

            // PERSISTENT BONUS LIST: Filter history for today's bonus items
            const sessionHistoryMemo = useMemo(() => {
                if (!history) return [];
                const todayStr = new Date().toLocaleDateString();
                return history.filter(h => h.isBonus && new Date(h.date).toLocaleDateString() === todayStr);
            }, [history]);

            const handleBonusCardioSave = (activity, metrics) => {
                onSaveBonus({ type: 'Cardio', name: activity, ...metrics });
                setSubMode('menu');
            };

            const handleStrengthSave = (e) => {
                e.preventDefault();
                if(!strengthForm.name) return;
                onSaveBonus({ type: 'Strength', ...strengthForm });
                setStrengthForm({ name: '', sets: '', reps: '', weight: '' });
                setSubMode('menu');
            };

            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded-lg shadow text-center">
                        <h2 className="font-extrabold text-xl text-green-700 uppercase">Bonus Zone</h2>
                    </div>
                    
                    <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                        <label className="block text-sm font-bold text-yellow-900 mb-1">Bonus Session Note</label>
                        <textarea value={note} onChange={e => setNote(e.target.value)} placeholder="" className="w-full p-3 border border-yellow-300 rounded bg-white" rows="2" />
                    </div>
                    {subMode === 'menu' && (
                        <div className="space-y-4">
                            <div className="bg-white p-4 rounded-lg shadow"><h3 className="font-bold text-lg text-gray-800 mb-2 border-b pb-2">Today's Extra Work</h3>{sessionHistoryMemo.length === 0 ? <p className="text-gray-500 italic">Nothing added yet.</p> : (<ul className="list-disc pl-5 space-y-1">{sessionHistoryMemo.map((item, i) => (<li key={i} className="text-gray-800"><span className="font-bold">{item.isCardio ? 'Cardio' : 'Strength'}:</span> {item.isCardio ? item.activity : item.exercises[0].name}</li>))}</ul>)}</div>
                            
                            <button onClick={() => { triggerHaptic(); onStartLucky(); }} className="w-full p-6 bg-purple-600 text-white rounded-xl shadow-lg font-bold text-xl flex items-center justify-center gap-3 border-b-4 border-purple-800 active:border-b-0 active:mt-1">
                                <span className="text-3xl">üé≤</span> I'm Feeling Lucky
                            </button>

                            <button onClick={() => { triggerHaptic(); setSubMode('cardio'); }} className="w-full p-6 bg-indigo-600 text-white rounded-xl shadow-lg font-bold text-xl flex items-center justify-center gap-3"><Icons.Activity size={28} /> Add Bonus Cardio</button>
                            <button onClick={() => { triggerHaptic(); setSubMode('strength'); }} className="w-full p-6 bg-blue-700 text-white rounded-xl shadow-lg font-bold text-xl flex items-center justify-center gap-3"><Icons.Dumbbell size={28} /> Add Bonus Strength</button>
                        </div>
                    )}
                    {subMode === 'cardio' && <div className="bg-white p-4 rounded-lg shadow-xl border-t-8 border-indigo-500"><div className="flex justify-between items-center mb-4"><button onClick={() => setSubMode('menu')} className="text-gray-600 font-bold flex items-center gap-1"><Icons.ArrowLeft size={20}/> Back</button><h2 className="text-xl font-bold">Add Bonus Cardio</h2></div><div className="space-y-4">{['HIIT Run', 'Indoor Cycle', 'ETP Run', 'Incline Walk', 'Treadmill Walk', 'Elliptical'].map(type => (<button key={type} onClick={() => { triggerHaptic(); setCardioActivity(type); }} className="w-full p-4 text-left border rounded-lg font-bold hover:bg-indigo-50 flex justify-between">{type} <Icons.ArrowRight size={20} /></button>))}</div></div>}
                    {subMode === 'cardio' && cardioActivity && <div className="fixed inset-0 bg-gray-100 z-50 p-4 overflow-y-auto"><CardioForm history={[]} onSave={(activity, metrics) => { handleBonusCardioSave(activity, metrics); setCardioActivity(''); }} onCancel={() => { setCardioActivity(''); setSubMode('menu'); }} /></div>}
                    {subMode === 'strength' && (
                        <form onSubmit={handleStrengthSave} className="bg-white p-6 rounded-lg shadow-xl border-t-8 border-blue-600">
                             <div className="flex justify-between items-center mb-4">
                                <button type="button" onClick={() => setSubMode('menu')} className="text-gray-600 font-bold flex items-center gap-1"><Icons.ArrowLeft size={20}/> Back</button>
                                <h2 className="text-xl font-bold text-blue-900">Add Bonus Strength</h2>
                            </div>
                            <div className="space-y-4">
                                <div><label className="block font-bold text-sm mb-1">Exercise</label><select className="w-full p-3 border rounded text-lg font-bold" value={strengthForm.name} onChange={e => setStrengthForm({...strengthForm, name: e.target.value})}><option value="">Select Exercise...</option>{availableExercises.map(ex => <option key={ex} value={ex}>{ex}</option>)}</select></div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div><AdjustableInput id="b-sets" label="Sets" value={strengthForm.sets} onChange={v => setStrengthForm({...strengthForm, sets:v})} step={1} unit="" /></div>
                                    <div><AdjustableInput id="b-reps" label="Reps" value={strengthForm.reps} onChange={v => setStrengthForm({...strengthForm, reps:v})} step={1} unit="" /></div>
                                    {/* Weights step is 1 as requested/intended */}
                                    <div className="col-span-2"><AdjustableInput id="b-weight" label="Weight" value={strengthForm.weight} onChange={v => setStrengthForm({...strengthForm, weight:v})} step={1} unit="pounds" /></div>
                                </div>
                                <div className="flex gap-3 pt-4"><button type="submit" className="w-full py-3 bg-blue-600 text-white font-bold rounded-lg shadow">Save Bonus</button></div>
                            </div>
                        </form>
                    )}
                </div>
            );
        }

        // --- Exercise Item (Standard) ---
        function ExerciseItem({ exercise, isEditing, isLast, onEdit, onDelete, onUpdate, onNext, onSkip, previousBest, previousData }) {
            const firstInputRef = useRef(null);
            const [confirmDelete, setConfirmDelete] = useState(false);

            // NEW: Contextual Recap Logic (Full Sentence)
            const contextualRecap = useMemo(() => {
                if (!isEditing || !previousData) return null;
                let text = `${exercise.name} History: Last time you did ${previousData.weight || 0} pounds`;
                if (previousData.sets) text += ` for ${previousData.sets} sets`;
                if (previousData.reps) text += ` of ${previousData.reps} reps.`;
                if (previousData.notes) text += ` Note: ${previousData.notes}`;
                return text;
            }, [isEditing, previousData, exercise.name]);

            // Smart Time Visibility
            const hasHistoryTime = previousData && previousData.time && previousData.time > 0;
            const hasCurrentTime = exercise.time && exercise.time > 0;
            const [showTime, setShowTime] = useState(hasHistoryTime || hasCurrentTime);

            useEffect(() => {
                if (isEditing && firstInputRef.current) setTimeout(() => firstInputRef.current.focus(), 50);
            }, [isEditing]);

            if (isEditing) {
                return (
                    <div className="bg-white p-4 rounded-lg shadow-xl border-4 border-blue-600 mb-6 relative" role="region" aria-label={`Editing ${exercise.name}`}>
                        <div className="flex justify-between items-center mb-4 border-b pb-2">
                            <div>
                                <h3 className="text-2xl font-bold text-blue-900">{exercise.name}</h3>
                                {contextualRecap && (
                                    <div className="bg-yellow-100 text-yellow-900 px-3 py-3 rounded mt-2 text-sm font-bold border border-yellow-300 leading-relaxed" role="note">
                                        {contextualRecap}
                                    </div>
                                )}
                            </div>
                             <button 
                                onClick={() => {
                                    triggerHaptic();
                                    if(confirmDelete) {
                                        onDelete(exercise.id, exercise.name);
                                    } else {
                                        playSound('skip');
                                        setConfirmDelete(true);
                                        setTimeout(() => setConfirmDelete(false), 3000);
                                    }
                                }} 
                                className={`p-4 rounded-lg transition-colors ${confirmDelete ? 'bg-red-600 text-white font-bold' : 'text-red-600 hover:bg-red-50'}`}
                                aria-label={`Delete ${exercise.name}`}
                            >
                                {confirmDelete ? "Sure?" : <Icons.Trash2 size={28} />}
                            </button>
                        </div>
                        
                        {/* SKIP BUTTON AT TOP */}
                        <button onClick={() => { triggerHaptic(); playSound('skip'); onSkip(exercise); }} className="w-full mb-6 py-4 bg-gray-100 text-gray-700 border border-gray-300 rounded-lg font-bold flex items-center justify-center gap-2 active:bg-gray-200">
                            <span className="uppercase tracking-wide text-sm">Skip for now</span> <Icons.SkipForward size={20} />
                        </button>

                        {/* REPLACED WITH ADJUSTABLE INPUTS */}
                        <div className="grid grid-cols-2 gap-4 mb-4">
                            <div ref={firstInputRef} tabIndex="-1">
                                <AdjustableInput id={`${exercise.id}-sets`} label="Sets" value={exercise.sets} onChange={v => onUpdate(exercise.id, 'sets', v)} step={1} unit="" />
                            </div>
                            <div>
                                <AdjustableInput id={`${exercise.id}-reps`} label="Reps" value={exercise.reps} onChange={v => onUpdate(exercise.id, 'reps', v)} step={1} unit="" />
                            </div>
                            {/* Weight step is 1 as requested/intended for weight training */}
                            <div className="col-span-2">
                                <AdjustableInput id={`${exercise.id}-weight`} label="Weight" value={exercise.weight} onChange={v => onUpdate(exercise.id, 'weight', v)} step={1} unit="pounds" />
                            </div>
                            
                            {/* SMART TIME TOGGLE */}
                             <div className="col-span-2">
                                {showTime ? (
                                    <AdjustableInput id={`${exercise.id}-time`} label="Time" value={exercise.time} onChange={v => onUpdate(exercise.id, 'time', v)} step={1} unit="seconds" />
                                ) : (
                                    <button onClick={() => setShowTime(true)} className="text-blue-600 font-bold text-sm underline py-2">Add Duration (+)</button>
                                )}
                            </div>
                        </div>

                        {/* Moved Notes and Next to be immediately accessible */}
                        <div className="space-y-4">
                             <div className="flex gap-2">
                                <button onClick={() => { triggerHaptic(); playSound('success'); onNext(exercise); }} className={`w-full text-white py-5 rounded-lg font-bold text-xl shadow flex items-center justify-center gap-3 ${isLast ? 'bg-green-700' : 'bg-blue-700'}`}>
                                    {isLast ? <><Icons.Check size={28} /> Finish</> : <><Icons.ArrowRight size={28} /> Next</>}
                                </button>
                            </div>
                            <hr />
                            <label htmlFor={`notes-${exercise.id}`} className="block text-sm font-bold text-gray-500 mb-1">Optional Notes</label>
                            <textarea id={`notes-${exercise.id}`} aria-label="Notes" value={exercise.notes} onChange={(e) => onUpdate(exercise.id, 'notes', e.target.value)} className="w-full p-3 text-lg border border-gray-400 rounded focus:border-blue-600 focus:ring-4 focus:ring-blue-600/50" placeholder="" rows="2" />
                        </div>
                    </div>
                );
            }
            
            // --- SAVED (COMPLETED) VIEW ---
            const isSaved = exercise.isCompleted; 
            
            const statusColor = isSaved ? "border-l-8 border-green-500 bg-white" : "border border-gray-300 bg-gray-50 opacity-70";
            const statusText = isSaved ? `Saved ‚úÖ` : "Not Started";
            const summaryText = [exercise.sets && `${exercise.sets} sets`, exercise.reps && `${exercise.reps} reps`, exercise.weight && `${exercise.weight} pounds`].filter(Boolean).join(', ');

            return (
                <li className={`p-4 rounded-lg shadow-sm mb-3 flex justify-between items-center list-none ${statusColor}`}>
                    <div className="flex-grow pr-4">
                        <h3 className="text-lg font-bold text-gray-800">{exercise.name}</h3>
                        <div className="flex flex-col">
                            <span className="text-gray-700 font-medium">{summaryText}</span>
                            <span className={`text-xs font-bold uppercase tracking-wide mt-1 ${isSaved ? 'text-green-700' : 'text-gray-500'}`}>Status: {statusText}</span>
                        </div>
                    </div>
                    <button onClick={() => {triggerHaptic(); onEdit(exercise.id)}} className="p-4 bg-gray-100 text-blue-800 rounded-lg border border-gray-300 hover:bg-blue-100 min-h-[44px] min-w-[44px]" aria-label={`Edit ${exercise.name}`}>
                        <Icons.Edit2 size={20} />
                    </button>
                </li>
            );
        }

        // --- Cardio Form (Unifed UI with Headers) ---
        function CardioForm({ history, onSave, onCancel, initialActivity }) {
            const [activity, setActivity] = useState(initialActivity || '');
            const [showEtpMenu, setShowEtpMenu] = useState(false);
            
            const [formData, setFormData] = useState({ 
                duration: '20', 
                speedEasy: '', speedMod: '', speedHard: '', speedAllOut: '', 
                intensity: '', avgSpeed: '', minIncline: '', maxIncline: '', 
                notes: '', effort: '5', isGuided: false,
                warmupDur: '10', warmupSpd: '',
                tempoDur: '20', tempoSpd: '',
                cooldownDur: '10', cooldownSpd: '',
                inclinePct: '', avgHR: '', maxHR: '',
                progBaseDur: '10', progBaseSpd: '',
                progBuildDur: '10', progBuildSpd: '',
                progFinishDur: '10', progFinishSpd: ''
            });
            const durationRef = useRef(null);

            // Derived Calculation for Tempo Run
            const tempoStats = useMemo(() => {
                if (activity !== 'Tempo Run') return null;
                const wD = parseFloat(formData.warmupDur) || 0;
                const tD = parseFloat(formData.tempoDur) || 0;
                const cD = parseFloat(formData.cooldownDur) || 0;
                const totalDur = wD + tD + cD;
                const wS = parseFloat(formData.warmupSpd) || 0;
                const tS = parseFloat(formData.tempoSpd) || 0;
                const cS = parseFloat(formData.cooldownSpd) || 0;
                let totalDist = 0;
                if (totalDur > 0) {
                    totalDist = (wD/60 * wS) + (tD/60 * tS) + (cD/60 * cS);
                }
                const avgSpd = totalDur > 0 ? (totalDist / (totalDur/60)).toFixed(1) : 0;
                return { totalDur, avgSpd };
            }, [activity, formData.warmupDur, formData.tempoDur, formData.cooldownDur, formData.warmupSpd, formData.tempoSpd, formData.cooldownSpd]);

            // Derived Calculation for Progressive Run
            const progStats = useMemo(() => {
                if (activity !== 'Progressive Run') return null;
                const bD = parseFloat(formData.progBaseDur) || 0;
                const buD = parseFloat(formData.progBuildDur) || 0;
                const fD = parseFloat(formData.progFinishDur) || 0;
                const totalDur = bD + buD + fD;
                const bS = parseFloat(formData.progBaseSpd) || 0;
                const buS = parseFloat(formData.progBuildSpd) || 0;
                const fS = parseFloat(formData.progFinishSpd) || 0;
                let totalDist = 0;
                if (totalDur > 0) {
                    totalDist = (bD/60 * bS) + (buD/60 * buS) + (fD/60 * fS);
                }
                const avgSpd = totalDur > 0 ? (totalDist / (totalDur/60)).toFixed(1) : 0;
                return { totalDur, avgSpd };
            }, [activity, formData.progBaseDur, formData.progBuildDur, formData.progFinishDur, formData.progBaseSpd, formData.progBuildSpd, formData.progFinishSpd]);


            // QUICK LOG BUTTON LOGIC
            const lastSession = useMemo(() => {
                if (!activity) return null;
                return history.slice().reverse().find(h => h.isCardio && h.activity === activity);
            }, [activity, history]);

            const handleQuickLog = () => {
                 if (!lastSession || !lastSession.metrics) return;
                 const payload = { ...lastSession.metrics, notes: '', effort: '5' };
                 triggerHaptic();
                 playSound('success');
                 onSave(activity, payload);
            };

            useEffect(() => {
                if (activity) {
                    if (lastSession && lastSession.metrics) {
                        setFormData(prev => ({ ...prev, ...lastSession.metrics, notes: '', effort: '5' }));
                    } else {
                        setFormData(prev => ({ ...prev, duration: '20', notes: '', effort: '5', isGuided: false }));
                    }
                    setTimeout(() => durationRef.current?.focus(), 100);
                }
            }, [activity, lastSession]);

            const handleChange = (field, value) => setFormData(prev => ({ ...prev, [field]: value }));
            const handleSubmit = (e) => { 
                e.preventDefault(); 
                if (!activity) return; 
                triggerHaptic(); 
                playSound('success'); 
                
                let finalData = { ...formData };
                if (activity === 'Tempo Run' && tempoStats) {
                    finalData.duration = tempoStats.totalDur.toString();
                    finalData.avgSpeed = tempoStats.avgSpd.toString();
                }
                if (activity === 'Progressive Run' && progStats) {
                    finalData.duration = progStats.totalDur.toString();
                    finalData.avgSpeed = progStats.avgSpd.toString();
                }
                
                onSave(activity, finalData); 
            };

            if (showEtpMenu) {
                return <ETPMenuView onBack={() => { setActivity(''); setShowEtpMenu(false); }} onSelect={(act) => { setActivity(act); setShowEtpMenu(false); }} />;
            }

            if (!activity) {
                // ... (Cardio Selection UI remains the same)
                return (
                    <div className="bg-white p-6 rounded-lg shadow-lg border border-blue-200">
                        <div className="text-center mb-6">
                            <h2 className="text-2xl font-bold text-blue-900 mb-1" tabIndex="-1">Cardio Selection</h2>
                        </div>
                        <div className="grid grid-cols-1 gap-4">
                            {['HIIT Run', 'Indoor Cycle', 'ETP Run', 'Incline Walk'].map(type => (
                                <button 
                                    key={type} 
                                    onClick={() => { 
                                        triggerHaptic(); 
                                        if (type === 'ETP Run') {
                                            setShowEtpMenu(true);
                                        } else {
                                            setActivity(type); 
                                        }
                                    }} 
                                    className="p-5 bg-blue-50 text-blue-900 font-bold text-xl rounded-lg border-2 border-blue-100 hover:bg-blue-100 hover:border-blue-300 text-left flex justify-between items-center"
                                >
                                    {type} <Icons.ArrowRight size={24} />
                                </button>
                            ))}
                        </div>
                        <button onClick={() => { triggerHaptic(); onCancel(); }} className="w-full mt-6 py-4 text-gray-600 font-bold text-lg flex items-center justify-center gap-2"><Icons.X size={24} /> Cancel</button>
                    </div>
                );
            }
            
            return (
                <form onSubmit={handleSubmit} className="bg-white p-6 rounded-lg shadow-xl border-t-8 border-indigo-600 space-y-8">
                    
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-2xl font-bold text-indigo-900">{activity} Log</h2>
                        {lastSession && (
                            <button type="button" onClick={handleQuickLog} className="bg-green-100 text-green-800 px-4 py-2 rounded-lg font-bold text-sm border border-green-300 shadow-sm">
                                ‚ö° Quick Log: Same as Last Time
                            </button>
                        )}
                    </div>
                    
                    {/* History Recap Box */}
                    {lastSession && (
                        <div className="bg-yellow-50 p-3 rounded mb-4 border border-yellow-200 text-sm text-yellow-900">
                            <strong>Last Time:</strong> {lastSession.metrics.duration} minutes
                            {lastSession.metrics.avgSpeed && ` @ ${lastSession.metrics.avgSpeed} miles per hour`}
                            {lastSession.metrics.intensity && ` (${lastSession.metrics.intensity})`}
                            {lastSession.metrics.notes && <div className="italic mt-1">"{lastSession.metrics.notes}"</div>}
                        </div>
                    )}

                    {/* SECTION 1: ACTIVITY METRICS (Dynamic Content) */}
                    <section className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-6">
                        <h3 className="font-bold text-gray-700 uppercase text-lg border-b pb-2">Activity Metrics</h3>
                        
                        {activity === 'Tempo Run' && (
                            <div className="space-y-6" ref={durationRef} tabIndex="-1">
                                <div className="bg-blue-100 p-4 rounded-lg border border-blue-300 text-center mb-4">
                                    <p className="text-sm font-bold text-blue-900 uppercase">Calculated Totals</p>
                                    <div className="flex justify-around mt-2">
                                        <div><span className="block text-2xl font-black">{tempoStats.totalDur}</span><span className="text-xs text-gray-600">Minutes</span></div>
                                        <div><span className="block text-2xl font-black">{tempoStats.avgSpd}</span><span className="text-xs text-gray-600">Average Miles per Hour</span></div>
                                    </div>
                                </div>
                                
                                <h4 className="font-bold text-gray-500 uppercase text-sm border-b pb-1">1. Warm Up Segment</h4>
                                <div className="grid grid-cols-2 gap-4">
                                    <AdjustableInput id="tm-w-dur" label="Duration" value={formData.warmupDur} onChange={v => handleChange('warmupDur', v)} step={1} unit="minutes" />
                                    <AdjustableInput id="tm-w-spd" label="Speed" value={formData.warmupSpd} onChange={v => handleChange('warmupSpd', v)} step={0.1} unit="miles per hour" />
                                </div>

                                <h4 className="font-bold text-gray-500 uppercase text-sm border-b pb-1">2. Tempo Segment</h4>
                                <div className="grid grid-cols-2 gap-4">
                                    <AdjustableInput id="tm-t-dur" label="Duration" value={formData.tempoDur} onChange={v => handleChange('tempoDur', v)} step={1} unit="minutes" />
                                    <AdjustableInput id="tm-t-spd" label="Speed" value={formData.tempoSpd} onChange={v => handleChange('tempoSpd', v)} step={0.1} unit="miles per hour" />
                                </div>

                                <h4 className="font-bold text-gray-500 uppercase text-sm border-b pb-1">3. Cool Down Segment</h4>
                                <div className="grid grid-cols-2 gap-4">
                                    <AdjustableInput id="tm-c-dur" label="Duration" value={formData.cooldownDur} onChange={v => handleChange('cooldownDur', v)} step={1} unit="minutes" />
                                    <AdjustableInput id="tm-c-spd" label="Speed" value={formData.cooldownSpd} onChange={v => handleChange('cooldownSpd', v)} step={0.1} unit="miles per hour" />
                                </div>
                                <AdjustableInput id="tm-inc" label="Incline" value={formData.inclinePct} onChange={v => handleChange('inclinePct', v)} step={1} unit="%" />
                            </div>
                        )}

                        {activity === 'Progressive Run' && (
                             <div className="space-y-6" ref={durationRef} tabIndex="-1">
                                <div className="bg-purple-100 p-4 rounded-lg border border-purple-300 text-center mb-4">
                                    <p className="text-sm font-bold text-purple-900 uppercase">Calculated Totals</p>
                                    <div className="flex justify-around mt-2">
                                        <div><span className="block text-2xl font-black">{progStats.totalDur}</span><span className="text-xs text-gray-600">Minutes</span></div>
                                        <div><span className="block text-2xl font-black">{progStats.avgSpd}</span><span className="text-xs text-gray-600">Average Miles per Hour</span></div>
                                    </div>
                                </div>
                                
                                <h4 className="font-bold text-gray-500 uppercase text-sm border-b pb-1">1. Base Segment</h4>
                                <div className="grid grid-cols-2 gap-4">
                                    <AdjustableInput id="pg-b-dur" label="Duration" value={formData.progBaseDur} onChange={v => handleChange('progBaseDur', v)} step={1} unit="minutes" />
                                    <AdjustableInput id="pg-b-spd" label="Speed" value={formData.progBaseSpd} onChange={v => handleChange('progBaseSpd', v)} step={0.1} unit="miles per hour" />
                                </div>

                                <h4 className="font-bold text-gray-500 uppercase text-sm border-b pb-1">2. Build Segment</h4>
                                <div className="grid grid-cols-2 gap-4">
                                    <AdjustableInput id="pg-bu-dur" label="Duration" value={formData.progBuildDur} onChange={v => handleChange('progBuildDur', v)} step={1} unit="minutes" />
                                    <AdjustableInput id="pg-bu-spd" label="Speed" value={formData.progBuildSpd} onChange={v => handleChange('progBuildSpd', v)} step={0.1} unit="miles per hour" />
                                </div>

                                <h4 className="font-bold text-gray-500 uppercase text-sm border-b pb-1">3. Finish Segment</h4>
                                <div className="grid grid-cols-2 gap-4">
                                    <AdjustableInput id="pg-f-dur" label="Duration" value={formData.progFinishDur} onChange={v => handleChange('progFinishDur', v)} step={1} unit="minutes" />
                                    <AdjustableInput id="pg-f-spd" label="Speed" value={formData.progFinishSpd} onChange={v => handleChange('progFinishSpd', v)} step={0.1} unit="miles per hour" />
                                </div>
                                <AdjustableInput id="pg-inc" label="Incline" value={formData.inclinePct} onChange={v => handleChange('inclinePct', v)} step={1} unit="%" />
                            </div>
                        )}
                        
                        {/* HIIT Run Specific Fields */}
                        {activity === 'HIIT Run' && (
                            <div className="space-y-4" ref={durationRef} tabIndex="-1">
                                <AdjustableInput id="c-duration" label="Total Duration" value={formData.duration} onChange={v => handleChange('duration', v)} step={1} unit="minutes" />
                                <h4 className="font-bold text-gray-500 uppercase text-sm border-b pb-1">Speed Zones (Miles per Hour)</h4>
                                <div className="grid grid-cols-2 gap-4">
                                    <div><AdjustableInput id="c-easy" label="Easy Speed" value={formData.speedEasy} onChange={v => handleChange('speedEasy', v)} step={0.1} unit="mph" /></div>
                                    <div><AdjustableInput id="c-mod" label="Moderate Speed" value={formData.speedMod} onChange={v => handleChange('speedMod', v)} step={0.1} unit="mph" /></div>
                                    <div><AdjustableInput id="c-hard" label="Hard Speed" value={formData.speedHard} onChange={v => handleChange('speedHard', v)} step={0.1} unit="mph" /></div>
                                    {/* All Out Speed label update */}
                                    <div><AdjustableInput id="c-max" label="All Out Speed" value={formData.speedAllOut} onChange={v => handleChange('speedAllOut', v)} step={0.1} unit="mph" /></div>
                                </div>
                                {/* Incline field added for HIIT Run */}
                                <AdjustableInput id="c-inc" label="Incline" value={formData.inclinePct} onChange={v => handleChange('inclinePct', v)} step={1} unit="%" />
                            </div>
                        )}

                        {/* Indoor Cycle Specific Fields */}
                        {activity === 'Indoor Cycle' && (
                            <div className="space-y-4" ref={durationRef} tabIndex="-1">
                                <AdjustableInput id="c-duration" label="Total Duration" value={formData.duration} onChange={v => handleChange('duration', v)} step={1} unit="minutes" />
                                <h4 className="font-bold text-gray-500 uppercase text-sm border-b pb-1">Intensity Level</h4>
                                <div>
                                    <label className="block text-sm font-bold text-gray-800 mb-3" id="intensity-label">Intensity</label>
                                    <div className="grid grid-cols-2 gap-3" role="radiogroup" aria-labelledby="intensity-label">
                                        {['Easy', 'Moderate', 'Hard', 'All Out'].map(level => (
                                            <label key={level} className={`p-4 border-2 rounded-lg flex items-center justify-center font-bold cursor-pointer ${formData.intensity === level ? 'bg-indigo-100 border-indigo-600 text-indigo-900' : 'border-gray-300 text-gray-700'}`}>
                                                <input type="radio" name="intensity" value={level} checked={formData.intensity === level} onChange={e => handleChange('intensity', e.target.value)} className="sr-only" />
                                                {level}
                                            </label>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Endurance Run Specific Fields */}
                        {activity === 'Endurance Run' && (
                            <div className="space-y-4" ref={durationRef} tabIndex="-1">
                                <AdjustableInput id="c-duration" label="Total Duration" value={formData.duration} onChange={v => handleChange('duration', v)} step={1} unit="minutes" />
                                <AdjustableInput id="c-avg" label="Average Speed" value={formData.avgSpeed} onChange={v => handleChange('avgSpeed', v)} step={0.1} unit="miles per hour" />
                                <AdjustableInput id="c-inc" label="Incline" value={formData.inclinePct} onChange={v => handleChange('inclinePct', v)} step={1} unit="%" />
                            </div>
                        )}
                                
                        {/* Incline Walk Specific Fields */}
                        {activity === 'Incline Walk' && (
                            <div className="space-y-4" ref={durationRef} tabIndex="-1">
                                <AdjustableInput id="c-duration" label="Total Duration" value={formData.duration} onChange={v => handleChange('duration', v)} step={1} unit="minutes" />
                                <AdjustableInput id="c-w-avg" label="Average Speed" value={formData.avgSpeed} onChange={v => handleChange('avgSpeed', v)} step={0.1} unit="miles per hour" />
                                <div className="grid grid-cols-2 gap-4">
                                    <div><AdjustableInput id="c-min" label="Minimum Incline" value={formData.minIncline} onChange={v => handleChange('minIncline', v)} step={1} unit="%" /></div>
                                    <div><AdjustableInput id="c-max" label="Maximum Incline" value={formData.maxIncline} onChange={v => handleChange('maxIncline', v)} step={1} unit="%" /></div>
                                </div>
                            </div>
                        )}
                    </section>
                    
                    {/* SECTION 2: HEART RATE STATS */}
                    <section className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-4">
                        <h3 className="font-bold text-gray-700 uppercase text-lg border-b pb-2">Heart Rate Statistics</h3>
                        <div className="grid grid-cols-2 gap-4">
                            <AdjustableInput id="std-hr-avg" label="Average Heart Rate" value={formData.avgHR} onChange={v => handleChange('avgHR', v)} step={1} unit="beats per minute" />
                            <AdjustableInput id="std-hr-max" label="Maximum Heart Rate" value={formData.maxHR} onChange={v => handleChange('maxHR', v)} step={1} unit="beats per minute" />
                        </div>
                    </section>

                    {/* SECTION 3: SESSION DETAILS */}
                    <section className="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-6">
                        <h3 className="font-bold text-gray-700 uppercase text-lg border-b pb-2">Session Details</h3>
                        
                        <div className="flex items-center gap-3">
                            <input 
                                id="c-guided" 
                                type="checkbox" 
                                checked={formData.isGuided} 
                                onChange={e => handleChange('isGuided', e.target.checked)} 
                                className="w-6 h-6 text-blue-600 rounded focus:ring-blue-500 border-gray-300"
                            />
                            <label htmlFor="c-guided" className="text-lg font-bold text-gray-800">
                                Guided Routine (Fitness+)
                            </label>
                        </div>

                        <div>
                            <label htmlFor="cardio-notes" className="block text-sm font-bold text-gray-800 mb-1">Notes</label>
                            <textarea id="cardio-notes" aria-label="Cardio notes" value={formData.notes} onChange={e => handleChange('notes', e.target.value)} className="w-full p-3 text-lg border border-gray-400 rounded bg-white" placeholder="" rows="3" />
                        </div>
                        
                        <div className="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                            <AdjustableInput id="c-effort" label="Effort Score (1-10)" value={formData.effort} onChange={v => handleChange('effort', v)} step={1} unit="" min={1} max={10} />
                        </div>
                    </section>

                    <div className="flex gap-3 pt-4">
                        <button type="submit" className="w-full py-4 bg-indigo-700 text-white rounded-lg font-bold text-xl shadow flex items-center justify-center gap-2">
                            <Icons.Check size={24} /> Save Log Entry
                        </button>
                    </div>
                </form>
            );
        }

        // --- Reports Generation Logic (Updated with Full Words) ---
        const generateReportText = (entries, filterType) => {
            let text = `EASY LOG REPORT - ${filterType.toUpperCase()}\n`;
            text += `Generated: ${new Date().toLocaleString()}\n`;
            text += `----------------------------------------\n\n`;

            if (entries.length === 0) {
                text += "No workouts found for this period.\n";
                return text;
            }

            entries.forEach(entry => {
                const dateStr = new Date(entry.date).toLocaleDateString();
                const timeStr = new Date(entry.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                text += `DATE: ${dateStr} at ${timeStr}\n`;
                
                if (entry.isCardio) {
                    text += `TYPE: Cardio (${entry.activity})\n`;
                    if (entry.metrics) {
                         if (entry.metrics.isGuided) text += `STYLE: Guided (Fitness+)\n`;
                         text += `DURATION: ${entry.metrics.duration} minutes\n`;
                         if (entry.metrics.effort) text += `EFFORT: ${entry.metrics.effort}/10\n`;
                         if (entry.metrics.avgSpeed) text += `AVERAGE SPEED: ${entry.metrics.avgSpeed} miles per hour\n`;
                         
                         // TEMPO SPECIFIC REPORTING
                         if (entry.activity === 'Tempo Run') {
                             if (entry.metrics.warmupDur) text += `WARMUP: ${entry.metrics.warmupDur} minutes @ ${entry.metrics.warmupSpd} miles per hour\n`;
                             if (entry.metrics.tempoDur) text += `TEMPO: ${entry.metrics.tempoDur} minutes @ ${entry.metrics.tempoSpd} miles per hour\n`;
                             if (entry.metrics.cooldownDur) text += `COOLDOWN: ${entry.metrics.cooldownDur} minutes @ ${entry.metrics.cooldownSpd} miles per hour\n`;
                         }

                         // PROGRESSIVE SPECIFIC REPORTING
                         if (entry.activity === 'Progressive Run') {
                             if (entry.metrics.progBaseDur) text += `BASE DURATION: ${entry.metrics.progBaseDur} minutes @ ${entry.metrics.progBaseSpd} miles per hour\n`;
                             if (entry.metrics.progBuildDur) text += `BUILD DURATION: ${entry.metrics.progBuildDur} minutes @ ${entry.metrics.progBuildSpd} miles per hour\n`;
                             if (entry.metrics.progFinishDur) text += `FINISH DURATION: ${entry.metrics.progFinishDur} minutes @ ${entry.metrics.progFinishSpd} miles per hour\n`;
                         }

                         // Global Cardio metrics for report
                         if (entry.metrics.inclinePct) text += `INCLINE PERCENTAGE: ${entry.metrics.inclinePct}%\n`;
                         if (entry.metrics.avgHR) text += `HEART RATE: Average ${entry.metrics.avgHR} / Maximum ${entry.metrics.maxHR} beats per minute\n`;

                         if (entry.metrics.intensity) text += `INTENSITY: ${entry.metrics.intensity}\n`;
                         if (entry.metrics.minIncline) text += `INCLINE RANGE: ${entry.metrics.minIncline}% - ${entry.metrics.maxIncline}%\n`;
                         if (entry.metrics.speedEasy) text += `SPEEDS: Easy:${entry.metrics.speedEasy} / Moderate:${entry.metrics.speedMod} / Hard:${entry.metrics.speedHard} / All Out:${entry.metrics.speedAllOut} miles per hour\n`;
                         if (entry.metrics.notes) text += `NOTE: ${entry.metrics.notes}\n`;
                    }
                } else if (entry.isVital) {
                    text += `TYPE: Vitals Log\n`;
                    text += `WEIGHT: ${entry.metrics.weight} pounds\n`;
                    text += `BMI: ${calculateBMI(entry.metrics.weight, entry.metrics.heightSnapshot).val}\n`;
                    const mhr = calculateMHR(entry.metrics.ageSnapshot);
                    text += `MAXIMUM HEART RATE (MHR): Fox ${mhr.fox} / Tanaka ${mhr.tanaka} beats per minute\n`;
                    if(entry.metrics.waist) text += `WAIST CIRCUMFERENCE: ${entry.metrics.waist} inches\n`;
                    if(entry.metrics.biceps) text += `BICEPS CIRCUMFERENCE: ${entry.metrics.biceps} inches\n`;
                    if(entry.metrics.chest) text += `CHEST CIRCUMFERENCE: ${entry.metrics.chest} inches\n`;
                    if(entry.metrics.thigh) text += `THIGH CIRCUMFERENCE: ${entry.metrics.thigh} inches\n`;
                } else {
                    text += `TYPE: Weight Training (${entry.routine})\n`;
                    if (entry.exercises) {
                        if (entry.overallEffort) text += `OVERALL EFFORT: ${entry.overallEffort}/10\n`;
                        entry.exercises.forEach(ex => {
                            if (ex.sets || ex.weight) { 
                                text += ` - ${ex.name.toUpperCase()}: ${ex.weight} pounds`;
                                if (ex.sets) text += ` (${ex.sets} sets x ${ex.reps} reps)`;
                                if (ex.time) text += ` [Time: ${ex.time} seconds]`;
                                if (ex.notes) text += `\n   Note: ${ex.notes}`;
                                text += `\n`;
                            }
                        });
                    }
                }
                text += `\n----------------------------------------\n\n`;
            });
            return text;
        };
        
        // --- CSV Generation Logic ---
        const generateReportCSV = (entries) => {
            // Define all possible column headers in a guaranteed order
            const headers = [
                "Date", "Time", "Type", "Routine", "Activity", 
                "Exercise_Name", "Sets", "Reps", "Weight_LBS", "Duration_Mins", 
                "Effort_RPE", "Notes", 
                "Avg_Speed_MPH", "Intensity", 
                "Min_Incline_PCT", "Max_Incline_PCT", "Incline_PCT",
                "Speed_Easy_MPH", "Speed_Mod_MPH", "Speed_Hard_MPH", "Speed_AllOut_MPH",
                "HR_Avg_BPM", "HR_Max_BPM", "Guided_Routine",
                "TM_Warmup_Dur", "TM_Warmup_Spd", "TM_Tempo_Dur", "TM_Tempo_Spd", "TM_Cooldown_Dur", "TM_Cooldown_Spd",
                "Prog_Base_Dur", "Prog_Base_Spd", "Prog_Build_Dur", "Prog_Build_Spd", "Prog_Finish_Dur", "Prog_Finish_Spd",
                "V_Weight_LBS", "V_Height_Inches", "V_Age_Years", "V_BMI", "V_MHR_Fox", "V_MHR_Tanaka",
                "V_Waist_Inches", "V_Chest_Inches", "V_Biceps_Inches", "V_Thigh_Inches"
            ];

            // Function to safely quote and escape commas/quotes for CSV standard
            const escapeCSV = (value) => {
                if (value === undefined || value === null) return '';
                let str = String(value);
                // Replace double quotes with two double quotes, then wrap the whole string in double quotes if it contains quotes or commas
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    str = str.replace(/"/g, '""');
                    return `"${str}"`;
                }
                return str;
            };

            let csv = headers.join(',') + '\n';

            entries.forEach(entry => {
                // Formatting Date and Time separately for easier spreadsheet sorting/filtering
                const dateObj = new Date(entry.date);
                const dateStr = dateObj.toLocaleDateString();
                const timeStr = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});
                
                if (entry.isVital) {
                    const metrics = entry.metrics || {};
                    const bmi = calculateBMI(metrics.weight, metrics.heightSnapshot).val;
                    const mhr = calculateMHR(metrics.ageSnapshot);
                    
                    const rowData = {
                        "Date": dateStr, 
                        "Time": timeStr, 
                        "Type": "Vitals", 
                        "Routine": "N/A", 
                        "Activity": "Vitals Log", 
                        "Exercise_Name": "", "Sets": "", "Reps": "", "Weight_LBS": "", "Duration_Mins": "", 
                        "Effort_RPE": "", "Notes": metrics.notes || "", 
                        "Avg_Speed_MPH": "", "Intensity": "", 
                        "Min_Incline_PCT": "", "Max_Incline_PCT": "", "Incline_PCT": "",
                        "Speed_Easy_MPH": "", "Speed_Mod_MPH": "", "Speed_Hard_MPH": "", "Speed_AllOut_MPH": "",
                        "HR_Avg_BPM": "", "HR_Max_BPM": "", "Guided_Routine": "",
                        "TM_Warmup_Dur": "", "TM_Warmup_Spd": "", "TM_Tempo_Dur": "", "TM_Tempo_Spd": "", "TM_Cooldown_Dur": "", "TM_Cooldown_Spd": "",
                        "Prog_Base_Dur": "", "Prog_Base_Spd": "", "Prog_Build_Dur": "", "Prog_Build_Spd": "", "Prog_Finish_Dur": "", "Prog_Finish_Spd": "",
                        "V_Weight_LBS": metrics.weight || "", 
                        "V_Height_Inches": metrics.height || "", 
                        "V_Age_Years": metrics.age || "", 
                        "V_BMI": bmi, 
                        "V_MHR_Fox": mhr.fox, 
                        "V_MHR_Tanaka": mhr.tanaka,
                        "V_Waist_Inches": metrics.waist || "", 
                        "V_Chest_Inches": metrics.chest || "", 
                        "V_Biceps_Inches": metrics.biceps || "", 
                        "V_Thigh_Inches": metrics.thigh || ""
                    };
                    
                    csv += headers.map(h => escapeCSV(rowData[h])).join(',') + '\n';
                
                } else if (entry.isCardio) {
                    const metrics = entry.metrics || {};
                    
                    const rowData = {
                        "Date": dateStr, 
                        "Time": timeStr, 
                        "Type": "Cardio", 
                        "Routine": entry.routine || "N/A", 
                        "Activity": entry.activity || "", 
                        "Exercise_Name": "", "Sets": "", "Reps": "", "Weight_LBS": "", 
                        "Duration_Mins": metrics.duration || "", 
                        "Effort_RPE": entry.overallEffort || metrics.effort || "", 
                        "Notes": metrics.notes || "", 
                        "Avg_Speed_MPH": metrics.avgSpeed || "", 
                        "Intensity": metrics.intensity || "", 
                        "Min_Incline_PCT": metrics.minIncline || "", 
                        "Max_Incline_PCT": metrics.maxIncline || "", 
                        "Incline_PCT": metrics.inclinePct || "",
                        "Speed_Easy_MPH": metrics.speedEasy || "", 
                        "Speed_Mod_MPH": metrics.speedMod || "", 
                        "Speed_Hard_MPH": metrics.speedHard || "", 
                        "Speed_AllOut_MPH": metrics.speedAllOut || "",
                        "HR_Avg_BPM": metrics.avgHR || "", 
                        "HR_Max_BPM": metrics.maxHR || "", 
                        "Guided_Routine": metrics.isGuided ? "TRUE" : "FALSE",
                        "TM_Warmup_Dur": metrics.warmupDur || "", "TM_Warmup_Spd": metrics.warmupSpd || "", 
                        "TM_Tempo_Dur": metrics.tempoDur || "", "TM_Tempo_Spd": metrics.tempoSpd || "", 
                        "TM_Cooldown_Dur": metrics.cooldownDur || "", "TM_Cooldown_Spd": metrics.cooldownSpd || "",
                        "Prog_Base_Dur": metrics.progBaseDur || "", "Prog_Base_Spd": metrics.progBaseSpd || "", 
                        "Prog_Build_Dur": metrics.progBuildDur || "", "Prog_Build_Spd": metrics.progBuildSpd || "", 
                        "Prog_Finish_Dur": metrics.progFinishDur || "", "Prog_Finish_Spd": metrics.progFinishSpd || "",
                        "V_Weight_LBS": "", "V_Height_Inches": "", "V_Age_Years": "", "V_BMI": "", "V_MHR_Fox": "", "V_MHR_Tanaka": "",
                        "V_Waist_Inches": "", "V_Chest_Inches": "", "V_Biceps_Inches": "", "V_Thigh_Inches": ""
                    };
                    
                    csv += headers.map(h => escapeCSV(rowData[h])).join(',') + '\n';

                } else {
                    const baseRowData = {
                        "Date": dateStr, 
                        "Time": timeStr, 
                        "Type": "Strength", 
                        "Routine": entry.routine || "N/A", 
                        "Activity": "Weight Training", 
                        "Duration_Mins": "", 
                        "Effort_RPE": entry.overallEffort || "", 
                        "Notes": "", 
                        "Avg_Speed_MPH": "", "Intensity": "", 
                        "Min_Incline_PCT": "", "Max_Incline_PCT": "", "Incline_PCT": "",
                        "Speed_Easy_MPH": "", "Speed_Mod_MPH": "", "Speed_Hard_MPH": "", "Speed_AllOut_MPH": "",
                        "HR_Avg_BPM": "", "HR_Max_BPM": "", "Guided_Routine": "",
                        "TM_Warmup_Dur": "", "TM_Warmup_Spd": "", "TM_Tempo_Dur": "", "TM_Tempo_Spd": "", "TM_Cooldown_Dur": "", "TM_Cooldown_Spd": "",
                        "Prog_Base_Dur": "", "Prog_Base_Spd": "", "Prog_Build_Dur": "", "Prog_Build_Spd": "", "Prog_Finish_Dur": "", "Prog_Finish_Spd": "",
                        "V_Weight_LBS": "", "V_Height_Inches": "", "V_Age_Years": "", "V_BMI": "", "V_MHR_Fox": "", "V_MHR_Tanaka": "",
                        "V_Waist_Inches": "", "V_Chest_Inches": "", "V_Biceps_Inches": "", "V_Thigh_Inches": ""
                    };
                    
                    (entry.exercises || []).forEach(ex => {
                        const rowData = {
                            ...baseRowData,
                            "Exercise_Name": ex.name || "", 
                            "Sets": ex.sets || "", 
                            "Reps": ex.reps || "", 
                            "Weight_LBS": ex.weight || "",
                            "Duration_Mins": ex.time ? (parseFloat(ex.time) / 60).toFixed(2) : "", // Convert seconds to minutes for CSV
                            "Notes": ex.notes || "",
                        };
                        csv += headers.map(h => escapeCSV(rowData[h])).join(',') + '\n';
                    });
                }
            });
            return csv;
        };


        // --- Reports, AddForm, and Main App ---
        function ReportsView({ history, onBack }) {
            const [filter, setFilter] = useState('week');
            const [reportText, setReportText] = useState('');
            const [filteredEntries, setFilteredEntries] = useState([]);
            
            // Generate Filename Utility
            const generateFilename = (ext = 'txt') => {
                const now = new Date();
                const pad = (n) => n.toString().padStart(2, '0');
                const timestamp = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}`;
                return `EasyLog_Report_${filter}_${timestamp}.${ext}`;
            };
            
            // Core filtering logic
            useEffect(() => {
                const now = new Date();
                const filtered = history.filter(entry => {
                    const d = new Date(entry.date);
                    if (filter === 'day') return d.toDateString() === now.toDateString();
                    if (filter === 'month') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                    if (filter === 'year') return d.getFullYear() === now.getFullYear();
                    if (filter === 'week') { const oneWeekAgo = new Date(); oneWeekAgo.setDate(now.getDate() - 7); return d >= oneWeekAgo; }
                    return true;
                }).slice().reverse();
                setFilteredEntries(filtered);
                setReportText(generateReportText(filtered, filter));
            }, [filter, history]);
            
            const handleCopy = () => { triggerHaptic(); const ta = document.createElement("textarea"); ta.value = reportText; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); alert("Report copied!"); };
            
            const handleDownloadTXT = () => { 
                triggerHaptic(); 
                const blob = new Blob([reportText], { type: 'text/plain' }); 
                const url = URL.createObjectURL(blob); 
                const a = document.createElement('a'); 
                a.href = url; 
                a.download = generateFilename('txt'); 
                document.body.appendChild(a); 
                a.click(); 
                document.body.removeChild(a); 
                URL.revokeObjectURL(url); 
            };
            
            // New CSV export handler
            const handleDownloadCSV = () => { 
                triggerHaptic(); 
                const csvData = generateReportCSV(filteredEntries);
                const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' }); 
                const url = URL.createObjectURL(blob); 
                const a = document.createElement('a'); 
                a.href = url; 
                a.download = generateFilename('csv'); 
                document.body.appendChild(a); 
                a.click(); 
                document.body.removeChild(a); 
                URL.revokeObjectURL(url); 
            };

            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded-lg shadow text-center">
                        <h2 className="text-xl font-bold">Reports</h2>
                    </div>
                    
                    <div className="bg-white p-4 rounded-lg shadow"><div className="grid grid-cols-5 gap-1">{['day', 'week', 'month', 'year', 'all'].map(f => (<button key={f} onClick={() => { triggerHaptic(); setFilter(f); }} className={`py-3 px-1 rounded text-sm font-bold uppercase ${filter === f ? 'bg-blue-700 text-white' : 'bg-gray-200 text-gray-700'}`}>{f}</button>))}</div></div>
                    
                    {/* Updated button row for CSV export (3 buttons now) */}
                    <div className="flex gap-2">
                        <button onClick={handleCopy} className="flex-1 py-4 bg-indigo-100 text-indigo-900 border-2 border-indigo-300 rounded-lg font-bold flex items-center justify-center gap-2 text-sm">
                            <Icons.Clipboard size={20} /> Copy for AI
                        </button>
                        <button onClick={handleDownloadTXT} className="flex-1 py-4 bg-green-100 text-green-900 border-2 border-green-300 rounded-lg font-bold flex items-center justify-center gap-2 text-sm">
                            <Icons.FileText size={20} /> Save TXT
                        </button>
                        <button onClick={handleDownloadCSV} className="flex-1 py-4 bg-yellow-100 text-yellow-900 border-2 border-yellow-300 rounded-lg font-bold flex items-center justify-center gap-2 text-sm">
                            <Icons.Download size={20} /> Export as CSV
                        </button>
                    </div>
                    
                    <div className="space-y-4">
                        <h3 className="text-lg font-bold text-gray-700 border-b pb-2">{filter === 'all' ? 'All Time' : `This ${filter.charAt(0).toUpperCase() + filter.slice(1)}`} ({filteredEntries.length} entries)</h3>
                        {filteredEntries.length === 0 && <p className="text-gray-400 italic">No entries found.</p>}
                        <div className="bg-white p-4 rounded-lg shadow-inner text-xs font-mono whitespace-pre-wrap max-h-[50vh] overflow-y-auto border border-gray-300" aria-label="Detailed Workout Report Preview">
                            {reportText}
                        </div>
                    </div>
                </div>
            );
        }

        function AddExerciseForm({ onAdd, routine, availableExercises }) {
            const [mode, setMode] = useState('select');
            const [customInput, setCustomInput] = useState('');
            const selectRef = useRef(null);
            const inputRef = useRef(null);
            const handleSelectChange = (e) => { const val = e.target.value; if (val === 'TYPE_NEW') { setMode('type'); setTimeout(() => inputRef.current?.focus(), 100); } else if (val !== '') { onAdd(val, false); e.target.value = ''; } };
            const handleCustomSubmit = (e) => { e.preventDefault(); if (customInput.trim()) { onAdd(customInput.trim(), true); setCustomInput(''); setMode('select'); setTimeout(() => selectRef.current?.focus(), 100); } };
            return (
                <div className="bg-blue-50 p-4 rounded-lg border-2 border-blue-200 mt-6">
                    <div className="flex justify-between items-center mb-2">
                        <h2 className="text-lg font-bold text-gray-600 uppercase tracking-wide mb-2 pl-1">Add New Exercise</h2>
                         {/* JUMP LINK TO ADD */}
                         <a href="#" onClick={(e) => { e.preventDefault(); inputRef.current && inputRef.current.focus(); }} className="sr-only">Jump to Add Form</a>
                    </div>
                    {mode === 'select' ? (<div className="relative"><select ref={selectRef} onChange={handleSelectChange} defaultValue="" className="block w-full p-4 text-lg border border-blue-300 rounded shadow-sm focus:ring-4 focus:ring-blue-600 appearance-none bg-white"><option value="" disabled>Select exercise...</option>{availableExercises.map((ex) => (<option key={ex} value={ex}>{ex}</option>))}<option value="TYPE_NEW" className="font-bold text-blue-800">+ Type New...</option></select><div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-700"><Icons.ChevronDown size={24} /></div></div>) : (<form onSubmit={handleCustomSubmit} className="flex flex-col gap-3"><input ref={inputRef} type="text" value={customInput} onChange={(e) => setCustomInput(e.target.value)} placeholder={`New ${routine} Exercise Name`} className="w-full p-4 border border-blue-300 rounded shadow-sm text-lg focus:ring-4 focus:ring-blue-600" autoComplete="off" /><div className="flex gap-2"><button type="button" onClick={() => setMode('select')} className="flex-1 py-3 bg-gray-200 text-gray-800 rounded-lg font-bold">Cancel</button><button type="submit" className="flex-1 py-3 bg-blue-700 text-white rounded-lg font-bold">Save</button></div></form>)}
                </div>
            );
        }

        // --- MAIN APP ---
        function App() {
            const [isDataLoaded, setIsDataLoaded] = useState(false); 
            const [showSplash, setShowSplash] = useState(true);
            const [currentDate, setCurrentDate] = useState(new Date());
            const [view, setView] = useState('menu'); 
            const [history, setHistory] = useState([]);
            const [manualRoutine, setManualRoutine] = useState(null);
            const [todaysExercises, setTodaysExercises] = useState([]);
            const [customDb, setCustomDb] = useState({});
            const [editingId, setEditingId] = useState(null);
            const [announcement, setAnnouncement] = useState('');
            const [workoutEffort, setWorkoutEffort] = useState('5');
            
            const [targetCardio, setTargetCardio] = useState(''); // NEW STATE for linking

            
            const announcementRef = useRef(null);
            const headerRef = useRef(null);
            const finishRef = useRef(null);

            // INIT EFFECT
            useEffect(() => {
                try {
                    const savedHistory = localStorage.getItem('workout_history');
                    const savedCurrentSession = localStorage.getItem('current_session');
                    const savedSessionDate = localStorage.getItem('current_session_date');
                    const savedCustomDb = localStorage.getItem('custom_exercise_db');
                    const savedManualRoutine = localStorage.getItem('manual_routine');
                    const seenSplash = sessionStorage.getItem('seen_splash_v5');
                    
                    if (savedHistory) setHistory(JSON.parse(savedHistory));
                    if (savedCustomDb) setCustomDb(JSON.parse(savedCustomDb));
                    
                    const todayStr = new Date().toLocaleDateString();
                    
                    if (savedSessionDate && savedSessionDate !== todayStr) {
                         localStorage.removeItem('manual_routine');
                         setManualRoutine(null);
                    } else {
                         if (savedManualRoutine) setManualRoutine(savedManualRoutine);
                    }

                    if (savedCurrentSession && savedSessionDate) {
                        if (savedSessionDate === todayStr) {
                            try { setTodaysExercises(JSON.parse(savedCurrentSession)); } catch(e) { console.error("Session corrupted", e); }
                        }
                    }
                    if (seenSplash) setShowSplash(false);
                } catch (err) {
                    console.error("Critical Init Error", err);
                } finally {
                    setTimeout(() => {
                        const loader = document.getElementById('loading-screen');
                        if (loader) loader.style.display = 'none';
                        setIsDataLoaded(true);
                    }, 800);
                }
            }, []);

            // PERSISTENCE
            useEffect(() => { if(isDataLoaded) localStorage.setItem('current_session', JSON.stringify(todaysExercises)); }, [todaysExercises, isDataLoaded]);
            useEffect(() => { if(isDataLoaded) localStorage.setItem('current_session_date', new Date().toDateString()); }, [todaysExercises, isDataLoaded]);
            useEffect(() => { if(isDataLoaded) localStorage.setItem('workout_history', JSON.stringify(history)); }, [history, isDataLoaded]);
            useEffect(() => { if(isDataLoaded) localStorage.setItem('custom_exercise_db', JSON.stringify(customDb)); }, [customDb, isDataLoaded]);
            
            // Focus Management: Top Left Header
            useEffect(() => { 
                if (headerRef.current && !showSplash) {
                    setTimeout(() => headerRef.current.focus(), 100);
                }
            }, [view, showSplash]);

            const activeRoutine = manualRoutine || getRoutineForDay(currentDate);
            const announce = (message) => { setAnnouncement(message); setTimeout(() => setAnnouncement(''), 6000); };

            // Renamed and changed logic to go straight to menu
            const goToMenu = () => {
                try {
                    sessionStorage.setItem('seen_splash_v5', 'true');
                } catch (e) { console.error("Storage error", e); }
                setShowSplash(false);
                setView('menu');
            };

            const switchToBonus = () => {
                try { sessionStorage.setItem('seen_splash_v5', 'true'); } catch (e) {}
                setShowSplash(false);
                setView('bonus');
            };
            
            const changeRoutine = (newRoutine) => {
                // Clear any existing session data when switching routines to avoid mix-ups
                if (todaysExercises.length > 0) {
                    setTodaysExercises([]);
                }
                setManualRoutine(newRoutine);
                localStorage.setItem('manual_routine', newRoutine);
            };

            const handleBonusSave = (entry) => {
                const record = {
                    id: Date.now(),
                    date: new Date().toString(),
                    isCardio: entry.type === 'Cardio',
                    routine: 'Bonus Session', 
                    isBonus: true, 
                    activity: entry.type === 'Cardio' ? entry.name : undefined,
                    metrics: entry.type === 'Cardio' ? { duration: entry.duration, notes: entry.notes, ...entry } : undefined,
                    exercises: entry.type === 'Strength' ? [{ name: entry.name, weight: entry.weight, sets: entry.sets, reps: entry.reps }] : undefined
                };
                setHistory(prev => [...prev, record]);
                announce(`${entry.name} saved to Bonus Session.`);
            };

            const handleVitalsSave = (metrics) => {
                const record = {
                    id: Date.now(),
                    date: new Date().toString(),
                    isVital: true,
                    metrics: metrics
                };
                setHistory(prev => [...prev, record]);
                setView('menu');
                announce("Vitals Saved.");
            };
            
            const masterExerciseList = useMemo(() => {
                const standard = Object.values(DEFAULT_DB).flat();
                const custom = Object.values(customDb).flat();
                return [...new Set([...standard, ...custom])].sort();
            }, [customDb]);

            const activeExercise = useMemo(() => {
                if (todaysExercises.length === 0) return null;
                if (editingId) {
                    const found = todaysExercises.find(ex => ex.id === editingId);
                    if (found) return found;
                }
                return todaysExercises.find(ex => !ex.isCompleted);
            }, [todaysExercises, editingId]);

            const upNextExercises = useMemo(() => {
                if (!activeExercise) return [];
                const activeIndex = todaysExercises.findIndex(ex => ex.id === activeExercise.id);
                return todaysExercises.slice(activeIndex + 1).filter(ex => !ex.isCompleted);
            }, [todaysExercises, activeExercise]);

            const completedExercises = useMemo(() => {
                return todaysExercises.filter(ex => ex.isCompleted);
            }, [todaysExercises]);

            const handleNextExercise = (currentExercise) => { 
                triggerHaptic(); 
                playSound('success');
                if (currentExercise.weight && currentExercise.previousWeight) {
                    const cleanWeight = parseFloat(currentExercise.weight.toString().replace(/[^0-9.]/g, ''));
                    const cleanPrev = parseFloat(currentExercise.previousWeight.toString().replace(/[^0-9.]/g, ''));
                    if (!isNaN(cleanWeight) && !isNaN(cleanPrev) && cleanWeight > cleanPrev) {
                        announce(`New PR on ${currentExercise.name}!`);
                    }
                }
                setTodaysExercises(prev => prev.map(e => e.id === currentExercise.id ? { ...e, isCompleted: true } : e));
                setEditingId(null);
                announce("Saved. Loading next.");
            };

            const handleSkipExercise = (currentExercise) => { 
                triggerHaptic(); 
                playSound('skip');
                const currentIndex = todaysExercises.findIndex(ex => ex.id === currentExercise.id); 
                const newSession = [...todaysExercises]; 
                newSession.splice(currentIndex, 1); 
                newSession.push(currentExercise); 
                setTodaysExercises(newSession); 
                setEditingId(null);
                announce(`Skipped. Now: ${newSession[currentIndex].name}.`); 
            };

            const handleLoadLastWorkout = () => { 
                triggerHaptic(); 
                const lastWorkout = history.slice().reverse().find(w => !w.isCardio && w.routine === activeRoutine); 
                if (!lastWorkout) { announce("No history."); return; } 
                const newSession = lastWorkout.exercises.map(ex => ({ 
                    ...ex, id: Date.now() + Math.random(), previousWeight: ex.weight, isCompleted: false 
                })); 
                if (todaysExercises.length > 0) {
                    const existingNames = new Set(todaysExercises.map(ex => ex.name));
                    const uniqueNew = newSession.filter(ex => !existingNames.has(ex.name));
                    if (uniqueNew.length === 0) { announce("All exercises already in list."); return; }
                    setTodaysExercises(prev => [...prev, ...uniqueNew]);
                    announce(`Merged ${uniqueNew.length} exercises.`);
                } else {
                    setTodaysExercises(newSession); 
                    if(newSession.length) setEditingId(newSession[0].id); 
                    announce("Loaded."); 
                }
            };

            const handleAddExercise = (exerciseName, isNewCustom) => { 
                triggerHaptic(); 
                if(isNewCustom) setCustomDb(prev => { const list = prev[activeRoutine] || []; if (!list.includes(exerciseName)) return { ...prev, [activeRoutine]: [...list, exerciseName] }; return prev; }); 
                let lastData = { sets: '', reps: '', weight: '', time: '', notes: '' };
                for (let i = history.length - 1; i >= 0; i--) {
                    if (history[i].isCardio) continue;
                    // THE GHOST LOGIC: Ignore bonus entries for standard history lookup
                    if (history[i].isBonus) continue;
                    
                    const pastExercise = history[i].exercises.find(e => e.name.toLowerCase() === exerciseName.toLowerCase());
                    if (pastExercise) { lastData = { ...pastExercise }; break; }
                }
                const newExercise = { 
                    id: Date.now(), name: exerciseName, sets: lastData.sets || '', reps: lastData.reps || '', weight: lastData.weight || '', 
                    time: lastData.time || '', notes: '', previousWeight: lastData.weight || '', isCompleted: false 
                }; 
                setTodaysExercises([...todaysExercises, newExercise]); 
                setEditingId(newExercise.id); 
                announce("Added."); 
            };

            const updateExercise = (id, field, value) => { if (field === 'timer_finished') { announce("Rest finished!"); return; } setTodaysExercises(prev => prev.map(ex => ex.id === id ? { ...ex, [field]: value } : ex)); };
            const removeExercise = (id, name) => { setTodaysExercises(prev => prev.filter(ex => ex.id !== id)); if (editingId === id) setEditingId(null); announce("Removed."); };
            
            // FIX: Ensure overallEffort is saved!
            const finishWorkout = () => { 
                triggerHaptic(); 
                if (!todaysExercises.length) return; 
                setEditingId(null); 
                const record = { 
                    id: Date.now(), 
                    date: new Date().toString(), 
                    routine: activeRoutine, 
                    isCardio: false, 
                    exercises: todaysExercises,
                    overallEffort: workoutEffort // Explicitly saving this now!
                }; 
                setHistory([...history, record]); 
                setTodaysExercises([]); 
                localStorage.removeItem('current_session'); 
                setManualRoutine(null); 
                setView('menu'); 
                announce("Saved."); 
            };
            
            const handleSaveCardio = (activity, metrics) => { 
                const record = { id: Date.now(), date: new Date().toString(), isCardio: true, activity, metrics }; 
                setHistory([...history, record]); 
                
                // Removed all shoe mileage calculation logic
                announce("Saved."); 
                
                setTargetCardio(''); // Clear target
                setView('menu'); 
            };

            const backupData = () => { 
                triggerHaptic(); 
                // Removed shoeMileage, shoeLimit from backup data
                const data = { history, currentSession: todaysExercises, customDb, exportDate: new Date().toString() }; 
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); 
                const url = URL.createObjectURL(blob); 
                const a = document.createElement('a'); 
                
                // Precise Filename Generation
                const now = new Date();
                const pad = (n) => n.toString().padStart(2, '0');
                const timestamp = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}`;
                
                a.href = url; 
                a.download = `EasyLog_Backup_${timestamp}.json`; 
                document.body.appendChild(a); 
                a.click(); 
                document.body.removeChild(a); 
            };

            const restoreData = (event) => { 
                triggerHaptic(); 
                const file = event.target.files[0]; 
                if(!file) return; 
                const reader = new FileReader(); 
                reader.onload = (e) => { 
                    try {
                        const data = JSON.parse(e.target.result); 
                        if(data.history) setHistory(data.history); 
                        if(data.currentSession) setTodaysExercises(data.currentSession); 
                        if(data.customDb) setCustomDb(data.customDb); 
                        // Removed shoeMileage, shoeLimit from restore logic
                        announce("Restored."); 
                        playSound('success');
                    } catch(err) {
                        playSound('skip');
                        alert("Invalid Backup File.");
                    }
                }; 
                reader.readAsText(file); 
            };

            const getTimeAgo = (dateString) => {
                if (!dateString) return '';
                const diff = new Date() - new Date(dateString);
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                if (days === 0) return "Today";
                if (days === 1) return "Yesterday";
                return `${days} days ago`;
            };
            
            const availableExercises = [...(DEFAULT_DB[activeRoutine] || []), ...(customDb[activeRoutine] || [])].sort();
            
            // Helper for Database Status
            const lastEntry = history.length > 0 ? history[history.length - 1] : null;
            const dbStatus = lastEntry 
                ? `Database Active. Last activity: ${lastEntry.isCardio ? lastEntry.activity : (lastEntry.routine || 'Workout')} (${getTimeAgo(lastEntry.date)})`
                : "‚ö†Ô∏è Database Empty. No history found.";

            // RENDER
            if (!isDataLoaded) return null; 

            if (showSplash) {
                return <SplashScreen 
                    onGoToMenu={goToMenu} 
                    onBonus={switchToBonus} 
                    routine={activeRoutine} 
                    history={history} 
                    currentSession={todaysExercises} 
                    onJumpToCardio={(act) => { 
                        if (act === 'ETP Run') {
                            goToMenu();
                            setView('etp-menu');
                        } else {
                            goToMenu(); 
                            setTargetCardio(act); 
                            setView('cardio'); 
                        }
                    }} 
                    onJumpToWeights={(rt) => { goToMenu(); changeRoutine(rt); setView('weights'); }} 
                    onChangeRoutine={changeRoutine}
                />;
            }

            return (
                <div className="min-h-screen bg-gray-100 text-gray-900 font-sans pb-20">
                    <div role="status" aria-live="polite" className="sr-only" ref={announcementRef}>{announcement}</div>
                    <header className="bg-slate-900 text-white p-4 shadow-md sticky top-0 z-20">
                        <div className="max-w-3xl mx-auto flex justify-between items-center">
                            
                            {/* TOP LEFT NAVIGATION LOGIC (Back to Progress Page) */}
                            <div className="flex gap-2">
                                {view !== 'menu' ? (
                                    // Back to Menu button for all non-menu views
                                    <button 
                                        ref={headerRef} // FOCUS TARGET
                                        onClick={() => {triggerHaptic(); setView('menu');}} 
                                        className="p-3 bg-slate-800 rounded hover:bg-slate-700 flex items-center gap-2 font-bold"
                                        aria-label="Go to Main Menu"
                                    >
                                        <Icons.ArrowLeft size={20} /> Main Menu
                                    </button>
                                ) : (
                                    // Back to Progress Page (Splash) button when on the main menu
                                    <button
                                        ref={headerRef}
                                        onClick={() => { triggerHaptic(); setShowSplash(true); }} // Back to Progress Page (Splash)
                                        className="p-3 bg-slate-800 rounded hover:bg-slate-700 flex items-center gap-2 font-bold"
                                        aria-label="Back to Progress Page"
                                    >
                                        <Icons.ArrowLeft size={20} /> Back to Progress Page
                                    </button>
                                )}
                            </div>

                            {/* TOP RIGHT: DATA MGMT */}
                            <button onClick={() => {triggerHaptic(); setView(view === 'settings' ? 'menu' : 'settings');}} className="p-3 bg-slate-800 rounded hover:bg-slate-700 flex items-center gap-2 font-bold" aria-label="Data Management">
                                <Icons.Database size={20} /> Data
                            </button>
                        </div>
                    </header>
                    <main className="max-w-3xl mx-auto p-4">
                        {view === 'menu' && (
                            <div className="space-y-6 mt-4">
                                <div className="text-center mb-4"><p className="text-slate-500 font-medium">{formatDate(currentDate)}</p></div>
                                
                                {/* DATABASE STATUS MONITOR */}
                                <div className={`p-3 rounded-lg border-2 mb-4 text-sm font-bold text-center ${lastEntry ? 'bg-green-50 border-green-200 text-green-900' : 'bg-red-50 border-red-200 text-red-900'}`}>
                                    {dbStatus}
                                </div>
                                
                                {currentDate.getDay() === 5 && <div className="bg-yellow-100 border-l-8 border-yellow-500 text-yellow-900 p-4 rounded-lg flex items-center gap-3" role="alert"><Icons.AlertTriangle size={28} /><span className="font-bold text-lg">It's Friday. Don't forget to backup!</span></div>}
                                <button onClick={() => {triggerHaptic(); setView('weights');}} className="w-full p-8 bg-blue-700 text-white rounded-xl shadow-lg hover:bg-blue-800 focus:ring-4 focus:ring-blue-400 text-left"><div className="flex items-center gap-4 mb-2"><Icons.Dumbbell size={40} /><span className="text-3xl font-extrabold">{activeRoutine}</span></div></button>
                                <button onClick={() => {triggerHaptic(); setTargetCardio(''); setView('cardio');}} className="w-full p-8 bg-indigo-700 text-white rounded-xl shadow-lg hover:bg-indigo-800 focus:ring-4 focus:ring-indigo-400 text-left"><div className="flex items-center gap-4 mb-2"><Icons.Activity size={40} /><span className="text-3xl font-extrabold">Cardio</span></div></button>
                                
                                {/* NEW VITALS BUTTON */}
                                <button onClick={() => {triggerHaptic(); setView('vitals');}} className="w-full p-6 bg-teal-600 text-white rounded-xl shadow border border-teal-500 hover:bg-teal-700 text-left flex items-center gap-4"><Icons.Heart size={32} /><span className="text-2xl font-bold">Vitals & BMI</span></button>

                                <button onClick={() => {triggerHaptic(); setView('reports');}} className="w-full p-6 bg-white text-slate-800 rounded-xl shadow border border-gray-200 hover:bg-gray-50 text-left flex items-center gap-4"><Icons.List size={32} className="text-slate-500" /><span className="text-xl font-bold">Reports</span></button>
                                {/* Removed redundant progress check link */}
                            </div>
                        )}
                        {view === 'bonus' && <BonusView onBack={() => {triggerHaptic(); setView('menu');}} onSaveBonus={handleBonusSave} availableExercises={masterExerciseList} history={history} onStartLucky={() => setView('lucky')} />}
                        {view === 'lucky' && <LuckyView onBack={() => {triggerHaptic(); setView('bonus');}} onSave={handleBonusSave} availableExercises={masterExerciseList} history={history} />}
                        {view === 'cardio' && <CardioForm history={history} onSave={handleSaveCardio} onCancel={() => setView('menu')} initialActivity={targetCardio} />}
                        {view === 'vitals' && <VitalsView history={history} onSave={handleVitalsSave} />}
                        {view === 'etp-menu' && <ETPMenuView onBack={() => setView('menu')} onSelect={(act) => { setTargetCardio(act); setView('cardio'); }} />}
                        
                        {view === 'weights' && (
                            <div className="space-y-6">
                                <h2 className="text-2xl font-bold text-blue-900 border-b-4 border-blue-500 pb-2 mb-4">{activeRoutine}</h2>
                                
                                {todaysExercises.length === 0 && (
                                    <div className="mb-6">
                                        {history.some(w => !w.isCardio && w.routine === activeRoutine) ? (
                                            <button onClick={handleLoadLastWorkout} className="w-full bg-blue-50 text-blue-900 border-2 border-blue-200 py-6 px-6 rounded-lg font-bold text-xl shadow flex items-center justify-center gap-3">
                                                <Icons.RefreshCw size={28} /> Load Last {activeRoutine}
                                            </button>
                                        ) : (
                                            <div className="p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800 text-center font-medium">
                                                No history found for {activeRoutine}. Start adding exercises below!
                                            </div>
                                        )}
                                    </div>
                                )}
                                
                                {/* ZONE 1: CURRENT EXERCISE */}
                                <h2 className="text-lg font-bold text-gray-600 uppercase tracking-wide mb-2 pl-1 border-b pb-1">Current Exercise</h2>
                                {activeExercise ? (
                                    <div aria-live="polite">
                                        <ExerciseItem 
                                            key={activeExercise.id} 
                                            exercise={activeExercise} 
                                            isEditing={true} 
                                            isLast={false} 
                                            onEdit={setEditingId} 
                                            onDelete={removeExercise} 
                                            onUpdate={updateExercise} 
                                            onNext={handleNextExercise} 
                                            onSkip={handleSkipExercise} 
                                            previousBest={activeExercise.previousWeight} 
                                            // Added: Pass history Data for Contextual Recap
                                            previousData={{
                                                weight: activeExercise.previousWeight,
                                                sets: activeExercise.sets || (history.slice().reverse().find(h => !h.isCardio && h.exercises.some(e => e.name === activeExercise.name))?.exercises.find(e => e.name === activeExercise.name)?.sets),
                                                reps: activeExercise.reps || (history.slice().reverse().find(h => !h.isCardio && h.exercises.some(e => e.name === activeExercise.name))?.exercises.find(e => e.name === activeExercise.name)?.reps),
                                                notes: (history.slice().reverse().find(h => !h.isCardio && h.exercises.some(e => e.name === activeExercise.name))?.exercises.find(e => e.name === activeExercise.name)?.notes)
                                            }}
                                        />
                                    </div>
                                ) : (
                                    // SMART CONTROL CENTER
                                    todaysExercises.length > 0 && (
                                        <div className="p-6 bg-green-50 border-4 border-green-200 rounded-xl shadow-inner text-center space-y-4" role="alert">
                                            <h2 className="text-2xl font-bold text-green-800">‚úÖ Workout Complete!</h2>
                                            <p className="text-green-700">Up next queue is empty.</p>
                                            
                                            {/* NEW: EFFORT SCORE FOR WORKOUT */}
                                            <div className="bg-white p-4 rounded-lg border border-green-300 text-left">
                                                <AdjustableInput id="w-effort" label="Overall Workout Effort (1-10)" value={workoutEffort} onChange={setWorkoutEffort} step={1} unit="" min={1} max={10} />
                                            </div>

                                            <div className="flex flex-col gap-3 mt-4">
                                                 <button ref={finishRef} onClick={finishWorkout} className="w-full bg-green-700 text-white text-2xl font-bold py-5 px-6 rounded-lg shadow-lg flex items-center justify-center gap-3"><Icons.Save size={32} /> Finish Workout Now</button>
                                                 
                                                 {/* REPLACED BUTTON WITH FORM */}
                                                 <div className="mt-4 pt-4 border-t border-green-300 text-left">
                                                    <p className="font-bold text-green-800 mb-2">Forgot an exercise? Add it here:</p>
                                                    <AddExerciseForm 
                                                        onAdd={handleAddExercise} 
                                                        routine={activeRoutine} 
                                                        availableExercises={availableExercises} 
                                                    />
                                                 </div>
                                            </div>
                                        </div>
                                    )
                                )}

                                {/* ZONE 2: UP NEXT QUEUE */}
                                <div>
                                    <div className="flex justify-between items-center mb-2 border-b pb-1">
                                        <h2 className="text-lg font-bold text-gray-600 uppercase tracking-wide pl-1">Up Next Queue</h2>
                                        {/* JUMP TO ADD BUTTON */}
                                        <button onClick={() => handleAddExercise("New Exercise", false)} className="text-blue-600 font-bold text-sm bg-blue-50 px-3 py-1 rounded hover:bg-blue-100 border border-blue-200">
                                            + Add New
                                        </button>
                                    </div>
                                    {upNextExercises.length > 0 ? (
                                        <ul className="space-y-2 list-none p-0 opacity-70">
                                            {upNextExercises.map((ex, index) => (
                                                <li key={ex.id} className="bg-white p-4 rounded-lg border border-gray-200 flex justify-between">
                                                    <span className="font-bold text-gray-700">{ex.name}</span>
                                                    <span className="text-xs bg-gray-200 px-2 py-1 rounded text-gray-600">Waiting</span>
                                                </li>
                                            ))}
                                        </ul>
                                    ) : (
                                        <p className="text-gray-400 italic pl-1">Queue is empty.</p>
                                    )}
                                </div>

                                {/* ZONE 3: COMPLETED LOG */}
                                <div>
                                    <h2 className="text-lg font-bold text-gray-600 uppercase tracking-wide mb-2 pl-1 border-b pb-1">Completed Log</h2>
                                    {completedExercises.length > 0 ? (
                                        <ul className="space-y-2 list-none p-0">
                                            {completedExercises.map((ex, index) => (
                                                <ExerciseItem 
                                                    key={ex.id} 
                                                    exercise={ex} 
                                                    isEditing={false} 
                                                    isLast={false} 
                                                    onEdit={setEditingId} 
                                                    onDelete={removeExercise} 
                                                    onUpdate={updateExercise} 
                                                    onNext={handleNextExercise} 
                                                    onSkip={handleSkipExercise} 
                                                    previousBest={ex.previousWeight} 
                                                />
                                            ))}
                                        </ul>
                                    ) : (
                                        <p className="text-gray-400 italic pl-1">Nothing completed yet.</p>
                                    )}
                                </div>

                                {/* ZONE 4: ADD NEW - ONLY SHOW IF NOT IN END GAME STATE */}
                                {activeExercise && (
                                    <div className="mt-8 border-t pt-6">
                                        <h2 className="text-lg font-bold text-gray-600 uppercase tracking-wide mb-2 pl-1">Add New Exercise</h2>
                                        <AddExerciseForm onAdd={handleAddExercise} routine={activeRoutine} availableExercises={availableExercises} />
                                    </div>
                                )}
                            </div>
                        )}
                        {view === 'reports' && <ReportsView history={history} onBack={() => setView('menu')} />}
                        {view === 'settings' && (
                            <div className="space-y-8 bg-white p-6 rounded-lg shadow border border-gray-200">
                                
                                {/* DATA LOG SECTION */}
                                <section>
                                    <h2 className="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-gray-100 pb-2">Backup & Restore</h2>
                                    <div className="space-y-4">
                                        <button onClick={backupData} className="w-full flex items-center justify-center gap-3 bg-gray-800 text-white p-5 rounded-lg font-bold text-lg"><Icons.Download size={24} /> Backup Data</button>
                                        <div className="relative">
                                            <input type="file" accept=".json" onChange={restoreData} className="opacity-0 absolute inset-0 w-full h-full cursor-pointer" id="restore-input" />
                                            <label htmlFor="restore-input" className="w-full flex items-center justify-center gap-3 bg-blue-600 text-white p-5 rounded-lg font-bold text-lg cursor-pointer"><Icons.Upload size={24} /> Restore Data</label>
                                        </div>
                                    </div>
                                </section>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
