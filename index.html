<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kinetic Compass v1.7</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Engines -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
        /* BASE DARK MODE STYLES */
        body { 
            overscroll-behavior-y: contain; 
            -webkit-tap-highlight-color: transparent; 
            background-color: #1a202c; 
            color: #f1f5f9; 
        }
        button { touch-action: manipulation; }
        
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #1a202c; 
            display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 9999;
            font-family: sans-serif; transition: opacity 0.5s;
        }
        
        #error-message {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #450a0a; 
            color: #fca5a5; 
            padding: 20px; z-index: 10000;
            font-family: monospace; white-space: pre-wrap; overflow: auto;
            display: none; 
        }

        .spinner {
            width: 50px; height: 50px; border: 5px solid #334155; 
            border-top: 5px solid #3b82f6; border-radius: 50%; 
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .sr-only {
            position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
            overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0;
        }
        
        .radio-label input:checked + div {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans pb-20">
    
    <div id="loading-screen" role="alert" aria-live="assertive">
        <div class="spinner" aria-hidden="true"></div>
        <h1 class="text-xl font-bold text-gray-300">Loading Kinetic Compass...</h1>
    </div>

    <div id="error-message"></div>
    <div id="root"></div>

    <script>
        window.onerror = function(msg, url, line) {
            const loader = document.getElementById('loading-screen');
            const errDiv = document.getElementById('error-message');
            if (loader) loader.style.display = 'none';
            if (errDiv) {
                errDiv.style.display = 'block';
                errDiv.innerHTML = "<strong>Error Loading App:</strong>\n" + msg + "\nLine: " + line;
            }
        };
        setTimeout(function() {
            const root = document.getElementById('root');
            if (!root || root.innerHTML.trim() === '') {
                const loader = document.getElementById('loading-screen');
                if (loader && loader.style.display !== 'none') {
                    loader.style.display = 'none';
                    const errDiv = document.getElementById('error-message');
                    if (errDiv && errDiv.style.display === 'none') {
                        errDiv.style.display = 'block';
                        errDiv.innerHTML = "<strong>Timeout:</strong> The app is taking too long to start. Please try refreshing.";
                    }
                }
            }
        }, 5000);
    </script>

    <script type="text/babel">
        const useState = React.useState;
        const useEffect = React.useEffect;
        const useRef = React.useRef;
        const useMemo = React.useMemo;

        // --- AUDIO ENGINE ---
        const audioCtxRef = { current: null };
        const playSound = (type) => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                if (!audioCtxRef.current) audioCtxRef.current = new AudioContext();
                if (audioCtxRef.current.state === 'suspended') audioCtxRef.current.resume().catch(e => console.log(e));
                const ctx = audioCtxRef.current;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                const now = ctx.currentTime;
                
                if (type === 'success') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(880, now); 
                    osc.frequency.exponentialRampToValueAtTime(1760, now + 0.1); 
                    gain.gain.setValueAtTime(0.3, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                    osc.start(now); osc.stop(now + 0.5);
                } else if (type === 'skip') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(300, now);
                    osc.frequency.linearRampToValueAtTime(50, now + 0.2);
                    gain.gain.setValueAtTime(0.2, now);
                    gain.gain.linearRampToValueAtTime(0.01, now + 0.2);
                    osc.start(now); osc.stop(now + 0.2);
                } else if (type === 'alert') {
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(440, now);
                    osc.frequency.setValueAtTime(440, now + 0.05);
                    osc.frequency.setValueAtTime(0, now + 0.06);
                    osc.frequency.setValueAtTime(440, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0.01, now + 0.2);
                    osc.start(now); osc.stop(now + 0.2);
                } else if (type === 'tick') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(600, now);
                    gain.gain.setValueAtTime(0.05, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
                    osc.start(now); osc.stop(now + 0.05);
                }
            } catch (e) { console.error("Audio error", e); }
        };

        // --- TTS ENGINE ---
        const speak = (text, priority = false) => {
            if ('speechSynthesis' in window) {
                if (priority) window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 1.15; 
                utterance.pitch = 1.0;
                window.speechSynthesis.speak(utterance);
            }
        };

        // --- WAKE LOCK HOOK (NEW) ---
        const useWakeLock = (shouldLock) => {
            useEffect(() => {
                let wakeLock = null;

                const requestLock = async () => {
                    try {
                        if ('wakeLock' in navigator && shouldLock) {
                            wakeLock = await navigator.wakeLock.request('screen');
                            // console.log("Wake Lock active");
                        }
                    } catch (err) {
                        console.log("Wake Lock error:", err);
                    }
                };

                const releaseLock = async () => {
                    if (wakeLock) {
                        try {
                            await wakeLock.release();
                            wakeLock = null;
                            // console.log("Wake Lock released");
                        } catch (err) {
                            console.log("Wake Lock release error:", err);
                        }
                    }
                };

                if (shouldLock) {
                    requestLock();
                } else {
                    releaseLock();
                }

                const handleVisibilityChange = () => {
                    if (document.visibilityState === 'visible' && shouldLock) {
                        requestLock();
                    }
                };

                document.addEventListener('visibilitychange', handleVisibilityChange);

                return () => {
                    releaseLock();
                    document.removeEventListener('visibilitychange', handleVisibilityChange);
                };
            }, [shouldLock]);
        };

        // --- Icon Set ---
        const IconWrapper = ({ children }) => <span aria-hidden="true" focusable="false" className="pointer-events-none">{children}</span>;

        const Icons = {
            Activity: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></IconWrapper>,
            AlertTriangle: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg></IconWrapper>,
            ArrowRight: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg></IconWrapper>,
            ArrowLeft: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg></IconWrapper>,
            Check: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="20 6 9 17 4 12"/></svg></IconWrapper>,
            CheckCircle: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></IconWrapper>,
            ChevronDown: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m6 9 6 6 6-6"/></svg></IconWrapper>,
            Circle: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/></svg></IconWrapper>,
            Clipboard: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></svg></IconWrapper>,
            Clock: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></IconWrapper>,
            Database: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg></IconWrapper>,
            Download: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg></IconWrapper>,
            Dumbbell: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m2 6 4-4"/><path d="m3 10 7-7"/><path d="m14 21 7-7"/></svg></IconWrapper>,
            Edit2: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5L2 22l1.5-5.5L17 3z"/></svg></IconWrapper>,
            FileText: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg></IconWrapper>,
            Home: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></IconWrapper>,
            Hourglass: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M5 22h14"/><path d="M5 2h14"/><path d="M17 22v-4.172a2 2 0 0 0-.586-1.414L12 12l-4.414 4.414A2 2 0 0 0 7 17.828V22"/><path d="M7 2v4.172a2 2 0 0 0 .586 1.414L12 12l4.414-4.414A2 2 0 0 0 17 6.172V2"/></svg></IconWrapper>,
            List: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg></IconWrapper>,
            Plus: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg></IconWrapper>,
            RefreshCw: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg></IconWrapper>,
            Save: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg></IconWrapper>,
            Settings: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg></IconWrapper>,
            SkipForward: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="5 4 15 12 5 20 5 4"/><line x1="19" x2="19" y1="5" y2="19"/></svg></IconWrapper>,
            Trash2: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg></IconWrapper>,
            Upload: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg></IconWrapper>,
            X: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></IconWrapper>,
            Heart: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg></IconWrapper>,
            User: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></IconWrapper>,
            Pause: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg></IconWrapper>,
            Play: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></IconWrapper>
        };

        const DEFAULT_DB = {
            'Upper Body': ['Bench Press', 'Overhead Press', 'Pull Ups', 'Dumbbell Rows', 'Bicep Curls', 'Tricep Dips', 'Lat Pulldown', 'Chest Fly', 'Face Pulls', 'Push Ups'],
            'Lower Body': ['Squats', 'Deadlifts', 'Lunges', 'Leg Press', 'Romanian Deadlifts', 'Calf Raises', 'Leg Extensions', 'Hamstring Curls', 'Goblet Squats'],
            'Core': ['Plank', 'Crunches', 'Leg Raises', 'Russian Twists', 'Ab Wheel', 'Bicycle Crunches', 'Hanging Leg Raises', 'Side Plank']
        };

        const getRoutineForDay = (date) => {
            const day = date.getDay(); 
            if (day === 1 || day === 4) return 'Lower Body';
            if (day === 2 || day === 5) return 'Upper Body';
            return 'Core';
        };

        const formatDate = (date) => {
            return new Intl.DateTimeFormat('en-US', { weekday: 'long', month: 'long', day: 'numeric' }).format(date);
        };

        const getGreeting = () => {
            const hour = new Date().getHours();
            if (hour < 12) return "Good Morning";
            if (hour < 17) return "Good Afternoon";
            return "Good Evening";
        };

        const triggerHaptic = () => {
            if (window.navigator && window.navigator.vibrate) {
                window.navigator.vibrate(50);
            }
        };

        const calculateBMI = (weight, height) => {
            if (!weight || !height) return { val: '--', status: 'Unknown' };
            const w = parseFloat(weight);
            const h = parseFloat(height);
            if (w <= 0 || h <= 0) return { val: '--', status: 'Unknown' };
            const bmi = (703 * w) / (h * h);
            const val = bmi.toFixed(1);
            let status = 'Normal';
            if (bmi < 18.5) status = 'Underweight';
            else if (bmi >= 25 && bmi < 29.9) status = 'Overweight';
            else if (bmi >= 30) status = 'Obese';
            return { val, status };
        };

        const calculateMHR = (age) => {
            if (!age || age <= 0) return { fox: '--', tanaka: '--' };
            const fox = Math.round(220 - age);
            const tanaka = Math.round(208 - (0.7 * age));
            return { fox, tanaka };
        };

        const getTimeAgo = (dateString) => {
            if (!dateString) return '';
            const diff = new Date() - new Date(dateString);
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            if (days === 0) return "Today";
            if (days === 1) return "Yesterday";
            return `${days} days ago`;
        };

        function StaticInput({ id, label, value, onChange, unit="", inputMode="numeric" }) {
            const displayValue = value || '';
            let ariaValueText = `${displayValue}`;
            if (unit) ariaValueText += ` ${unit}`;
            return (
                <div className="mb-4">
                     <label htmlFor={id} className="block text-sm font-bold text-gray-400 mb-1 capitalize">{label}</label>
                    <input id={id} type="text" inputMode={inputMode} value={value} onChange={(e) => onChange(e.target.value)} className="w-full p-4 text-xl border border-slate-600 rounded bg-slate-800 text-white" aria-label={label} aria-valuenow={parseFloat(value) || 0} aria-valuetext={ariaValueText} placeholder={inputMode === 'numeric' ? '0' : '0.0'} />
                </div>
            );
        }

        function NumericStepperInput({ id, label, value, onChange, step=1, unit="", min=0, max=9999 }) {
            const numValue = value === '' ? min : parseFloat(value);
            const inputMode = step < 1 ? "decimal" : "numeric";
            const decimalPlaces = step < 1 ? 1 : 0;
            const displayValue = value || '';
            const adjust = (direction) => {
                triggerHaptic();
                const factor = step < 1 ? 100 : 1; 
                const cleanStep = Math.round(step * factor);
                const cleanCurrentVal = Math.round(numValue * factor);
                let newVal;
                if (direction === 'up') newVal = (cleanCurrentVal + cleanStep) / factor;
                else newVal = (cleanCurrentVal - cleanStep) / factor;
                if (newVal < min) newVal = min;
                if (newVal > max) newVal = max;
                const formattedValue = step < 1 ? newVal.toFixed(decimalPlaces).toString() : Math.round(newVal).toString();
                onChange(formattedValue);
            };
            return (
                <div className="mb-4">
                     <label htmlFor={id} className="block text-sm font-bold text-gray-400 mb-1 capitalize">{label}</label>
                    <div className="flex items-center space-x-2">
                        <button type="button" onClick={() => adjust('down')} className="p-4 bg-slate-700 rounded-lg text-white font-bold text-2xl w-14 h-14 flex items-center justify-center border border-slate-600 hover:bg-slate-600 active:bg-slate-500" aria-label={`Subtract ${step} ${unit}`} disabled={numValue <= min}>&minus;</button>
                        <input id={id} type="text" inputMode={inputMode} value={displayValue} onChange={(e) => onChange(e.target.value.replace(/[^\d.]/g, ''))} className="flex-1 p-3 text-2xl font-bold text-center border border-slate-600 rounded bg-slate-800 text-white" aria-label={label} placeholder={min.toString()} />
                        {unit && <span className="text-gray-400 text-sm font-medium">{unit}</span>}
                        <button type="button" onClick={() => adjust('up')} className="p-4 bg-slate-700 rounded-lg text-white font-bold text-2xl w-14 h-14 flex items-center justify-center border border-slate-600 hover:bg-slate-600 active:bg-slate-500" aria-label={`Add ${step} ${unit}`} disabled={numValue >= max}>&#43;</button>
                    </div>
                </div>
            );
        }

        // --- ACTIVE RUN TIMER COMPONENT (UPDATED v1.6) ---
        function ActiveRunTimer({ phases, type, onComplete, onCancel }) {
            // phaseIndex -1 = Pre-Start Countdown
            const [currentPhaseIndex, setCurrentPhaseIndex] = useState(-1);
            const [timeLeft, setTimeLeft] = useState(10); // Start with 10s countdown
            const [isPaused, setIsPaused] = useState(false);
            const [isFinished, setIsFinished] = useState(false);
            const timerRef = useRef(null);
            
            // Audio Announce Helper
            const announce = (text, priority = false) => {
                speak(text, priority);
            };

            // Phase Speed Helper
            const getPhaseSpeed = (idx) => {
                if (idx < 0 || idx >= phases.length) return "";
                const spd = phases[idx].speed;
                return spd && parseFloat(spd) > 0 ? `Speed ${spd}.` : "";
            };

            // Initial announcement
            useEffect(() => {
                announce(`10 seconds to start. Get ready.`);
            }, []);

            useEffect(() => {
                if (isPaused || isFinished) {
                    if (timerRef.current) clearInterval(timerRef.current);
                    return;
                }

                timerRef.current = setInterval(() => {
                    setTimeLeft((prev) => {
                        const nextTime = prev - 1;
                        
                        // --- PRE-START LOGIC (-1) ---
                        if (currentPhaseIndex === -1) {
                            if (nextTime === 5) { playSound('tick'); announce("5"); }
                            if (nextTime === 4) { playSound('tick'); announce("4"); }
                            if (nextTime === 3) { playSound('tick'); announce("3"); }
                            if (nextTime === 2) { playSound('tick'); announce("2"); }
                            if (nextTime === 1) { playSound('tick'); announce("1"); }
                            
                            if (nextTime < 0) {
                                // Transition to Phase 0
                                handlePhaseTransition(0);
                                return phases[0].durationMinutes * 60; // Reset timer for Phase 0
                            }
                            return nextTime;
                        }

                        // --- ACTIVE PHASE LOGIC (0+) ---
                        const phaseDur = phases[currentPhaseIndex].durationMinutes * 60;
                        const elapsed = phaseDur - nextTime;
                        
                        // 5-Minute Reminders
                        if (elapsed > 0 && elapsed % 300 === 0 && nextTime > 10) { // Every 300 seconds (5 mins)
                            playSound('alert');
                            const mins = elapsed / 60;
                            announce(`${mins} minutes.`);
                        }
                        
                        // 10-Second Countdown to End of Phase
                        if (nextTime === 10) { playSound('tick'); announce("10", true); }
                        else if (nextTime < 10 && nextTime > 0) { playSound('tick'); announce(nextTime.toString(), true); }

                        if (nextTime < 0) {
                            handlePhaseTransition(currentPhaseIndex + 1);
                            return 0; // Temp return
                        }
                        return nextTime;
                    });
                }, 1000);

                return () => clearInterval(timerRef.current);
            }, [currentPhaseIndex, isPaused, isFinished]);

            const handlePhaseTransition = (nextIndex) => {
                if (nextIndex < phases.length) {
                    // Next Phase
                    const nextPhase = phases[nextIndex];
                    const speedText = getPhaseSpeed(nextIndex);
                    setCurrentPhaseIndex(nextIndex);
                    setTimeLeft(nextPhase.durationMinutes * 60);
                    playSound('success');
                    announce(`Beginning Phase ${nextIndex + 1}: ${nextPhase.name}. ${speedText}`);
                } else {
                    // Workout Complete
                    setIsFinished(true);
                    clearInterval(timerRef.current);
                    playSound('success');
                    announce(`Workout Complete. Returning to data entry.`);
                    // Small delay to let speech start before unmounting
                    setTimeout(() => {
                        onComplete(); // Go back to form
                    }, 3000);
                }
            };

            const togglePause = () => {
                triggerHaptic();
                if (isPaused) { setIsPaused(false); announce("Resuming."); } 
                else { setIsPaused(true); announce("Paused."); }
            };

            const handleCancel = () => {
                triggerHaptic();
                announce("Workout cancelled.");
                onCancel();
            };

            const formatTime = (seconds) => {
                const m = Math.floor(seconds / 60);
                const s = seconds % 60;
                return `${m}:${s < 10 ? '0' : ''}${s}`;
            };

            // Pre-Start Display
            if (currentPhaseIndex === -1) {
                 return (
                    <div className="fixed inset-0 bg-slate-900 z-50 flex flex-col items-center justify-center p-6 text-center" role="region" aria-label="Countdown to Start">
                        <h2 className="text-4xl font-bold text-gray-400 mb-8 uppercase tracking-widest">Get Ready</h2>
                        <div className="text-[10rem] font-black text-white leading-none animate-pulse" aria-live="assertive">
                            {timeLeft}
                        </div>
                        <button onClick={handleCancel} className="mt-12 text-red-400 font-bold px-6 py-3 border-2 border-red-900 rounded-full hover:bg-red-900/20">Cancel</button>
                    </div>
                );
            }

            // Finished Display (Briefly shown before auto-close)
            if (isFinished) {
                return (
                    <div className="fixed inset-0 bg-slate-900 z-50 flex flex-col items-center justify-center p-6 text-center">
                        <div className="bg-green-600 p-6 rounded-full mb-6 animate-bounce"><Icons.Check size={64} className="text-white" /></div>
                        <h2 className="text-4xl font-bold text-white mb-2">Workout Complete!</h2>
                    </div>
                );
            }

            const currentPhase = phases[currentPhaseIndex];

            return (
                <div className="fixed inset-0 bg-slate-900 z-50 flex flex-col p-4" role="region" aria-label="Active Workout Timer">
                    {/* Top Bar */}
                    <div className="flex justify-between items-center mb-6">
                        <button onClick={handleCancel} className="text-red-400 font-bold px-4 py-2 border border-red-900 rounded hover:bg-red-900/20">Cancel & Return</button>
                        <div className="text-xs font-bold text-gray-500 uppercase tracking-widest">Phase {currentPhaseIndex + 1} of {phases.length}</div>
                    </div>

                    {/* Timer Display */}
                    <div className="flex-1 flex flex-col items-center justify-center space-y-6">
                        <h2 className="text-3xl font-bold text-blue-400 text-center" aria-live="polite">
                            {currentPhase.name}
                        </h2>
                         {/* Speed Indicator */}
                        {currentPhase.speed > 0 && (
                            <div className="bg-slate-800 px-6 py-2 rounded-full border border-slate-600">
                                <span className="text-gray-400 text-sm font-bold uppercase mr-2">Target Speed</span>
                                <span className="text-2xl font-black text-white">{currentPhase.speed}</span>
                            </div>
                        )}
                        
                        <div className="text-9xl font-black text-white font-mono tracking-tighter" aria-label={`${Math.floor(timeLeft / 60)} minutes ${timeLeft % 60} seconds remaining`}>
                            {formatTime(timeLeft)}
                        </div>

                        {isPaused && <div className="px-4 py-2 bg-yellow-900 text-yellow-200 rounded font-bold uppercase tracking-widest animate-pulse">Paused</div>}
                    </div>

                    {/* Controls */}
                    <div className="mt-auto pt-6 pb-8">
                        <button onClick={togglePause} className={`w-full py-8 rounded-2xl font-bold text-3xl shadow-xl flex items-center justify-center gap-4 ${isPaused ? 'bg-green-600 text-white' : 'bg-yellow-600 text-white'}`} aria-label={isPaused ? "Resume Workout" : "Pause Workout"}>
                            {isPaused ? <><Icons.Play size={40} /> Resume</> : <><Icons.Pause size={40} /> Pause</>}
                        </button>
                    </div>
                </div>
            );
        }

        function SplashScreen({ onGoToMenu, routine, history, currentSession, onBonus, onJumpToCardio, onJumpToWeights, onChangeRoutine }) {
            const [greeting] = useState(getGreeting());
            useEffect(() => { const loader = document.getElementById('loading-screen'); if(loader) loader.style.display = 'none'; }, []);
            
            const { progress, allDone, completedCount, isStrengthDoneToday } = useMemo(() => {
                const todayStr = new Date().toLocaleDateString();
                const todayEntries = history.filter(h => new Date(h.date).toLocaleDateString() === todayStr);
                const isWeightsSaved = todayEntries.some(h => !h.isCardio && !h.isBonus && !h.isVital);
                const isWeightsInProgress = !isWeightsSaved && (currentSession && currentSession.length > 0);
                const p = {
                    hiit: todayEntries.some(h => h.isCardio && h.activity === 'HIIT Run') ? 'done' : 'todo',
                    cycle: todayEntries.some(h => h.isCardio && h.activity === 'Indoor Cycle') ? 'done' : 'todo',
                    endurance: todayEntries.some(h => h.isCardio && ['Endurance Run', 'Tempo Run', 'Progressive Run', 'ETP Run'].includes(h.activity)) ? 'done' : 'todo',
                    incline: todayEntries.some(h => h.isCardio && h.activity === 'Incline Walk') ? 'done' : 'todo',
                    weights: isWeightsSaved ? 'done' : (isWeightsInProgress ? 'progress' : 'todo')
                };
                let count = 0;
                if (p.hiit === 'done') count++; if (p.cycle === 'done') count++; if (p.endurance === 'done') count++; if (p.incline === 'done') count++; if (p.weights === 'done') count++;
                return { progress: p, allDone: count === 5, completedCount: count, isStrengthDoneToday: isWeightsSaved };
            }, [history, routine, currentSession]);

            const getButtonText = () => {
                if (allDone) return "I'm feeling extra good today! üéâ";
                if (completedCount === 0) return "Let's get this day going";
                const percentage = Math.round((completedCount / 5) * 100);
                if (percentage < 40) return `Off to a good start! (${percentage}% Done)`;
                if (percentage < 60) return `Building momentum... (${percentage}% Done)`;
                if (percentage < 80) return `Over the hump! (${percentage}% Done)`;
                return `Home stretch! (${percentage}% Done)`;
            };

            const StatusIcon = ({ status }) => {
                if (status === 'done') return <span aria-label="Completed"><Icons.CheckCircle className="text-green-500" /></span>;
                if (status === 'progress') return <span aria-label="In Progress"><Icons.Hourglass className="text-orange-400 animate-pulse" /></span>;
                return <span aria-label="Not started"><Icons.Circle className="text-gray-500" /></span>;
            };
            
            const getButtonAriaLabel = (label, status) => {
                let baseLabel;
                if (label.includes('Focus')) baseLabel = `Log Today's ${label}`; else baseLabel = `Log ${label}`;
                if (status === 'done') return `${label}, Completed`;
                if (status === 'progress') return `${baseLabel}, In Progress. Tap to continue.`;
                if (status === 'todo') return `${baseLabel}, Not Completed`;
                return baseLabel; 
            };
            
            const InteractiveRow = ({ label, status, onClick }) => (
                <button onClick={() => { triggerHaptic(); onClick(); }} className="w-full flex items-center justify-between p-2 rounded hover:bg-slate-700 text-left active:bg-slate-600 transition-colors" aria-label={getButtonAriaLabel(label, status)}>
                    <span className="flex items-center gap-2 text-base">{label}</span>
                    <StatusIcon status={status} />
                </button>
            );

            const handleMainClick = () => { triggerHaptic(); playSound('success'); try { if (allDone) { onBonus(); } else { onGoToMenu(); } } catch (e) { console.error("Navigation safety catch", e); onGoToMenu(); } };

            return (
                <div className="fixed inset-0 bg-slate-900 text-white z-50 flex flex-col p-6 overflow-y-auto">
                    <div className="flex justify-between w-full mb-6">
                        <button onClick={() => { triggerHaptic(); onGoToMenu(); }} className="p-3 bg-slate-800 rounded hover:bg-slate-700 flex items-center gap-2 font-bold" aria-label="Skip to Main Menu"><Icons.SkipForward size={20} /> Skip to Main Menu</button>
                    </div>
                    <div className="flex-1 flex flex-col justify-center space-y-8">
                        <div>
                            <h1 className="text-4xl font-bold mb-2">Welcome to Kinetic Compass v1.7!</h1>
                            <p className="text-slate-400 text-xl font-medium" aria-label={`Today's Date is ${formatDate(new Date())}`}>Today: {formatDate(new Date())}</p>
                            <div className="flex items-center gap-3 mt-1"><p className="text-blue-400 text-2xl font-extrabold uppercase tracking-wide" aria-live="polite">Today's Strength Focus: {routine}</p></div>
                             <div className="mt-2">{isStrengthDoneToday ? (<span className="bg-green-800 text-green-100 border border-green-600 rounded px-3 py-1 text-sm font-bold inline-block" aria-live="polite">{routine} Strength Focus Logged</span>) : (<><label htmlFor="change-focus" className="sr-only">Change Strength Focus:</label><select id="change-focus" onChange={(e) => { triggerHaptic(); onChangeRoutine(e.target.value); }} value={routine} className="bg-slate-800 text-white border border-slate-600 rounded px-2 py-1 text-sm font-bold inline-block w-auto" aria-label="Select a different Strength Focus routine for today"><option value="Upper Body">Upper Body</option><option value="Lower Body">Lower Body</option><option value="Core">Core</option></select></>)}</div>
                        </div>
                        <div className="space-y-6">
                            <div className="bg-slate-800 p-5 rounded-xl border border-slate-700">
                                <h2 role="presentation" className="text-slate-400 text-sm font-bold uppercase tracking-wider mb-4">Morning Session</h2>
                                <div className="space-y-3 text-lg font-medium">
                                    <InteractiveRow label="HIIT Run" status={progress.hiit} onClick={() => onJumpToCardio('HIIT Run')} />
                                    <InteractiveRow label="Indoor Cycle" status={progress.cycle} onClick={() => onJumpToCardio('Indoor Cycle')} />
                                </div>
                            </div>
                            <div className="bg-slate-800 p-5 rounded-xl border border-slate-700">
                                <h2 role="presentation" className="text-slate-400 text-sm font-bold uppercase tracking-wider mb-4">Afternoon Session</h2>
                                <div className="space-y-3 text-lg font-medium">
                                    <InteractiveRow label={`${routine} Focus`} status={progress.weights} onClick={() => onJumpToWeights(routine)} />
                                    <InteractiveRow label="ETP Run" status={progress.endurance} onClick={() => onJumpToCardio('ETP Run')} />
                                    <InteractiveRow label="Incline Walk" status={progress.incline} onClick={() => onJumpToCardio('Incline Walk')} />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div className="mt-6 space-y-3">
                         <button onClick={handleMainClick} className={`w-full text-white font-bold text-xl py-6 rounded-xl shadow-lg active:scale-95 transition-transform ${allDone ? 'bg-green-600 hover:bg-green-500' : 'bg-blue-600 hover:bg-blue-500'}`}>{getButtonText()}</button>
                    </div>
                </div>
            );
        }

        function LuckyView({ onBack, onSave, availableExercises, history }) {
            const [exercise, setExercise] = useState(null);
            const [sets, setSets] = useState('');
            const [reps, setReps] = useState('');
            const [weight, setWeight] = useState('');
            const mysteryRef = useRef(null);
            const pickRandom = () => {
                const randomName = availableExercises[Math.floor(Math.random() * availableExercises.length)];
                let lastData = { sets: '', reps: '', weight: '' };
                for (let i = history.length - 1; i >= 0; i--) {
                    if (history[i].isCardio) continue;
                    const pastExercise = history[i].exercises.find(e => e.name.toLowerCase() === randomName.toLowerCase());
                    if (pastExercise) { lastData = { ...pastExercise }; break; }
                }
                setExercise(randomName);
                setSets(lastData.sets || '3');
                setReps(lastData.reps || '10');
                setWeight(lastData.weight || '');
                setTimeout(() => { if(mysteryRef.current) mysteryRef.current.focus(); }, 100);
            };
            useEffect(() => { pickRandom(); }, []);
            const handleSpin = (isExit) => { triggerHaptic(); playSound('success'); onSave({ type: 'Strength', name: exercise, sets, reps, weight }); if (isExit) { onBack(); } else { pickRandom(); } };
            if (!exercise) return <div className="p-8 text-center font-bold text-white">Spinning...</div>;
            return (
                <div className="space-y-6">
                    <div className="bg-purple-700 text-white p-6 rounded-lg shadow-lg text-center border-4 border-purple-900"><h2 role="presentation" ref={mysteryRef} tabIndex="-1" className="text-2xl font-extrabold uppercase mb-1 focus:outline-none">Mystery Exercise</h2><p className="text-3xl font-black text-yellow-300">{exercise}</p></div>
                    <div className="bg-slate-800 text-white p-6 rounded-lg shadow-xl border-t-8 border-purple-600 space-y-6"><div className="grid grid-cols-2 gap-4"><div><NumericStepperInput id="l-sets" label="Sets" value={sets} onChange={setSets} step={1} unit="" /></div><div><NumericStepperInput id="l-reps" label="Reps" value={reps} onChange={setReps} step={1} unit="" /></div><div className="col-span-2"><NumericStepperInput id="l-weight" label="Weight" value={weight} onChange={setWeight} step={1} unit="pounds" /></div></div><div className="flex flex-col gap-3 pt-2"><button onClick={() => handleSpin(false)} className="w-full py-5 bg-purple-600 text-white font-bold text-xl rounded-lg shadow-lg hover:bg-purple-500 border-b-4 border-purple-800 active:border-b-0 active:mt-1">üé≤ Spin Again (Save & Next)</button><button onClick={() => handleSpin(true)} className="w-full py-4 bg-slate-700 text-gray-200 font-bold text-lg rounded-lg hover:bg-slate-600">üèÅ Cash Out (Save & Exit)</button></div></div>
                </div>
            );
        }

        function ETPMenuView({ onBack, onSelect }) {
            return (
                <div className="space-y-6">
                    <div className="flex items-center gap-2 mb-4"><button onClick={onBack} className="text-gray-400 font-bold flex items-center gap-1 p-2 bg-slate-700 rounded hover:bg-slate-600"><Icons.ArrowLeft size={20} /> Back to Menu</button><h2 role="presentation" className="text-2xl font-bold text-blue-400">ETP Run Type</h2></div>
                    <div className="space-y-4">
                        <button onClick={() => { triggerHaptic(); onSelect('Endurance Run'); }} className="w-full p-8 bg-blue-700 text-white rounded-xl shadow-lg font-bold text-2xl flex flex-col items-start active:scale-[.99] transition-transform"><span className="flex items-center justify-between w-full">Endurance Run <Icons.ArrowRight size={28} /></span><span className="text-sm font-medium text-blue-300 mt-1">Memo: Saturday, Sunday, and Monday</span></button>
                        <button onClick={() => { triggerHaptic(); onSelect('Tempo Run'); }} className="w-full p-8 bg-indigo-700 text-white rounded-xl shadow-lg font-bold text-2xl flex flex-col items-start active:scale-[.99] transition-transform"><span className="flex items-center justify-between w-full">Tempo Run <Icons.ArrowRight size={28} /></span><span className="text-sm font-medium text-indigo-300 mt-1">Memo: Wednesday and Friday</span></button>
                        <button onClick={() => { triggerHaptic(); onSelect('Progressive Run'); }} className="w-full p-8 bg-purple-700 text-white rounded-xl shadow-lg font-bold text-2xl flex flex-col items-start active:scale-[.99] transition-transform"><span className="flex items-center justify-between w-full">Progressive Run <Icons.ArrowRight size={28} /></span><span className="text-sm font-medium text-purple-300 mt-1">Memo: Tuesday and Thursday</span></button>
                    </div>
                </div>
            );
        }

        function VitalsView({ history, onSave }) {
            const [vitals, setVitals] = useState({ age: '', height: '', weight: '', waist: '', chest: '', biceps: '', thigh: '', notes: '' });
            const handleChange = (field, value) => { let cleanedValue = value.replace(/[^\d.]/g, ''); if (field === 'age' || field === 'height') cleanedValue = cleanedValue.split('.')[0] || ''; setVitals(prev => ({ ...prev, [field]: cleanedValue })); };
            useEffect(() => { const lastVital = history.slice().reverse().find(h => h.isVital); if (lastVital && lastVital.metrics) { setVitals(prev => ({ ...prev, age: lastVital.metrics.age || '', height: lastVital.metrics.height || '', weight: lastVital.metrics.weight || '', waist: lastVital.metrics.waist || '', chest: lastVital.metrics.chest || '', biceps: lastVital.metrics.biceps || '', thigh: lastVital.metrics.thigh || '' })); } }, [history]);
            const bmiData = calculateBMI(vitals.weight, vitals.height);
            const mhrData = calculateMHR(vitals.age);
            const handleSave = () => { triggerHaptic(); playSound('success'); onSave({ ...vitals, heightSnapshot: vitals.height, ageSnapshot: vitals.age }); };
            return (
                <div className="space-y-6">
                    <div className="bg-slate-800 text-white p-4 rounded-lg shadow text-center border border-slate-700"><h2 role="presentation" className="font-extrabold text-xl text-teal-400 uppercase flex items-center justify-center gap-2"><Icons.Heart size={24} /> Vitals & Body Composition</h2></div>
                    <div className="grid grid-cols-2 gap-4"><div><StaticInput id="v-age" label="Age" value={vitals.age} onChange={v => handleChange('age', v)} inputMode="numeric" unit="years" /></div><div><StaticInput id="v-height" label="Height" value={vitals.height} onChange={v => handleChange('height', v)} inputMode="numeric" unit="inches" /></div></div>
                    <div className="col-span-2"><NumericStepperInput id="v-weight" label="Weight" value={vitals.weight} onChange={v => handleChange('weight', v)} step={0.5} unit="pounds" /></div>
                    <div className="bg-teal-950 p-4 rounded-xl border-4 border-teal-700 text-center"><div className="grid grid-cols-2 gap-4"><div><p className="text-xs font-bold text-teal-300 uppercase tracking-wider">BMI</p><p className="text-3xl font-black text-teal-100">{bmiData.val}</p><p className="text-xs font-bold text-teal-400">{bmiData.status}</p></div><div className="border-l border-teal-800 pl-2"><p className="text-xs font-bold text-teal-300 uppercase tracking-wider">Maximum Heart Rate</p><div className="text-sm font-bold text-teal-100 mt-1 text-left"><p>Fox: {mhrData.fox}</p><p>Tanaka: {mhrData.tanaka}</p></div></div></div></div>
                    <div className="bg-slate-800 p-6 rounded-lg shadow-xl space-y-6 border border-slate-700"><h3 role="presentation" className="font-bold text-gray-400 uppercase text-sm">Body Measurements (inches)</h3><div className="grid grid-cols-2 gap-4"><div className="col-span-2"><StaticInput id="v-waist" label="Waist Circumference" value={vitals.waist} onChange={v => handleChange('waist', v)} inputMode="decimal" unit="inches" /></div><div><StaticInput id="v-chest" label="Chest Circumference" value={vitals.chest} onChange={v => handleChange('chest', v)} inputMode="decimal" unit="inches" /></div><div><StaticInput id="v-biceps" label="Biceps Circumference" value={vitals.biceps} onChange={v => handleChange('biceps', v)} inputMode="decimal" unit="inches" /></div><div className="col-span-2"><StaticInput id="v-thigh" label="Thigh Circumference" value={vitals.thigh} onChange={v => handleChange('thigh', v)} inputMode="decimal" unit="inches" /></div></div><div><label className="block text-sm font-bold text-gray-400 mb-1">Notes</label><textarea value={vitals.notes} onChange={e => handleChange('notes', e.target.value)} className="w-full p-3 text-lg border border-slate-600 rounded bg-slate-700 text-white" rows="2" aria-label="Notes on Vitals" /></div><button onClick={handleSave} className="w-full py-5 bg-teal-600 text-white font-bold text-xl rounded-lg shadow-lg hover:bg-teal-500">Save Vitals</button></div>
                </div>
            );
        }

        function BonusView({ onBack, onSaveBonus, availableExercises, history, onStartLucky }) {
            const [subMode, setSubMode] = useState('menu'); 
            const [note, setNote] = useState('');
            const [strengthForm, setStrengthForm] = useState({ name: '', sets: '', reps: '', weight: '' });
            const [cardioActivity, setCardioActivity] = useState(''); 
            const sessionHistoryMemo = useMemo(() => {
                if (!history) return [];
                const todayStr = new Date().toLocaleDateString();
                return history.filter(h => h.isBonus && new Date(h.date).toLocaleDateString() === todayStr);
            }, [history]);
            const handleBonusCardioSave = (activity, metrics) => { onSaveBonus({ type: 'Cardio', name: activity, ...metrics }); setSubMode('menu'); };
            const handleStrengthSave = (e) => { e.preventDefault(); if(!strengthForm.name) return; onSaveBonus({ type: 'Strength', ...strengthForm }); setStrengthForm({ name: '', sets: '', reps: '', weight: '' }); setSubMode('menu'); };
            return (
                <div className="space-y-6">
                    <div className="bg-slate-800 text-white p-4 rounded-lg shadow text-center border border-slate-700"><h2 role="presentation" className="font-extrabold text-xl text-green-400 uppercase">Bonus Zone</h2></div>
                    <div className="bg-yellow-950 p-4 rounded-lg border border-yellow-700"><label className="block text-sm font-bold text-yellow-300 mb-1">Bonus Session Note</label><textarea value={note} onChange={e => setNote(e.target.value)} placeholder="" className="w-full p-3 border border-yellow-700 rounded bg-slate-800 text-white" rows="2" /></div>
                    {subMode === 'menu' && (
                        <div className="space-y-4">
                            <div className="bg-slate-800 text-white p-4 rounded-lg shadow border border-slate-700"><h3 role="presentation" className="font-bold text-lg text-gray-300 mb-2 border-b border-slate-700 pb-2">Today's Extra Work</h3>{sessionHistoryMemo.length === 0 ? <p className="text-gray-500 italic">Nothing added yet.</p> : (<ul className="list-disc pl-5 space-y-1">{sessionHistoryMemo.map((item, i) => (<li key={i} className="text-gray-300"><span className="font-bold">{item.isCardio ? 'Cardio' : 'Strength'}:</span> {item.isCardio ? item.activity : item.exercises[0].name}</li>))}</ul>)}</div>
                            <button onClick={() => { triggerHaptic(); onStartLucky(); }} className="w-full p-6 bg-purple-600 text-white rounded-xl shadow-lg font-bold text-xl flex items-center justify-center gap-3 border-b-4 border-purple-800 active:border-b-0 active:mt-1"><span className="text-3xl">üé≤</span> I'm Feeling Lucky</button>
                            <button onClick={() => { triggerHaptic(); setSubMode('cardio'); }} className="w-full p-6 bg-indigo-600 text-white rounded-xl shadow-lg font-bold text-xl flex items-center justify-center gap-3"><Icons.Activity size={28} /> Add Bonus Cardio</button>
                            <button onClick={() => { triggerHaptic(); setSubMode('strength'); }} className="w-full p-6 bg-blue-700 text-white rounded-xl shadow-lg font-bold text-xl flex items-center justify-center gap-3"><Icons.Dumbbell size={28} /> Add Bonus Strength</button>
                        </div>
                    )}
                    {subMode === 'cardio' && <div className="bg-slate-800 text-white p-4 rounded-lg shadow-xl border-t-8 border-indigo-500"><div className="flex justify-between items-center mb-4"><button onClick={() => setSubMode('menu')} className="text-gray-400 font-bold flex items-center gap-1"><Icons.ArrowLeft size={20}/> Back</button><h2 role="presentation" className="text-xl font-bold text-indigo-400">Add Bonus Cardio</h2></div><div className="space-y-4">{['HIIT Run', 'Indoor Cycle', 'ETP Run', 'Incline Walk', 'Treadmill Walk', 'Elliptical'].map(type => (<button key={type} onClick={() => { triggerHaptic(); setCardioActivity(type); }} className="w-full p-4 text-left border border-slate-700 rounded-lg font-bold hover:bg-slate-700 flex justify-between">{type} <Icons.ArrowRight size={20} /></button>))}</div></div>}
                    {subMode === 'cardio' && cardioActivity && <div className="fixed inset-0 bg-slate-900 z-50 p-4 overflow-y-auto"><CardioForm history={[]} onSave={(activity, metrics) => { handleBonusCardioSave(activity, metrics); setCardioActivity(''); }} onCancel={() => { setCardioActivity(''); setSubMode('menu'); }} /></div>}
                    {subMode === 'strength' && (<form onSubmit={handleStrengthSave} className="bg-slate-800 text-white p-6 rounded-lg shadow-xl border-t-8 border-blue-600 border border-slate-700"><div className="flex justify-between items-center mb-4"><button type="button" onClick={() => setSubMode('menu')} className="text-gray-400 font-bold flex items-center gap-1"><Icons.ArrowLeft size={20}/> Back</button><h2 role="presentation" className="text-xl font-bold text-blue-400">Add Bonus Strength</h2></div><div className="space-y-4"><div><label className="block font-bold text-sm mb-1 text-gray-400">Exercise</label><select className="w-full p-3 border border-slate-600 rounded text-lg font-bold bg-slate-700 text-white" value={strengthForm.name} onChange={e => setStrengthForm({...strengthForm, name: e.target.value})}><option value="">Select Exercise...</option>{availableExercises.map(ex => <option key={ex} value={ex}>{ex}</option>)}</select></div><div className="grid grid-cols-2 gap-4"><div><NumericStepperInput id="b-sets" label="Sets" value={strengthForm.sets} onChange={v => setStrengthForm({...strengthForm, sets:v})} step={1} unit="" /></div><div><NumericStepperInput id="b-reps" label="Reps" value={strengthForm.reps} onChange={v => setStrengthForm({...strengthForm, reps:v})} step={1} unit="" /></div><div className="col-span-2"><NumericStepperInput id="b-weight" label="Weight" value={strengthForm.weight} onChange={v => setStrengthForm({...strengthForm, weight:v})} step={1} unit="pounds" /></div></div><div className="flex gap-3 pt-4"><button type="submit" className="w-full py-3 bg-blue-600 text-white font-bold rounded-lg shadow hover:bg-blue-600">Save Bonus</button></div></div></form>)}
                </div>
            );
        }

        function ExerciseItem({ exercise, isEditing, isLast, onEdit, onDelete, onUpdate, onNext, onSkip, previousBest, previousData }) {
            const firstInputRef = useRef(null);
            const [confirmDelete, setConfirmDelete] = useState(false);
            const contextualRecap = useMemo(() => {
                if (!isEditing || !previousData) return null;
                const weight = parseFloat(previousData.weight) || 0;
                const time = parseFloat(previousData.time) || 0;
                const sets = parseFloat(previousData.sets) || 0;
                const reps = parseFloat(previousData.reps) || 0;
                const notes = previousData.notes;
                let text = `${exercise.name} History: `;
                let primaryInfo = '';
                if (time > 0) { if (sets > 0) primaryInfo = `Last time you did ${sets} sets of ${time} seconds.`; else primaryInfo = `Last time you held for ${time} seconds.`; } else if (weight > 0) { primaryInfo = `Last time you did ${weight} pounds`; if (sets > 0) primaryInfo += ` for ${sets} sets`; if (reps > 0) primaryInfo += ` of ${reps} reps.`; } else if (sets > 0 || reps > 0) { primaryInfo = `Last time you did`; if (sets > 0) primaryInfo += ` ${sets} sets`; if (sets > 0 && reps > 0) primaryInfo += ` x `; if (reps > 0) primaryInfo += ` ${reps} reps.`; primaryInfo = primaryInfo.replace(' x ', ' of '); } else return null;
                text += primaryInfo;
                if (notes) { if (!text.trim().endsWith('.')) text += '.'; text += ` Note: ${notes}`; }
                return text;
            }, [isEditing, previousData, exercise.name]);

            useEffect(() => { if (isEditing && firstInputRef.current) setTimeout(() => firstInputRef.current.focus(), 50); }, [isEditing]);

            if (isEditing) {
                return (
                    <div className="bg-slate-800 p-4 rounded-lg shadow-xl border-4 border-blue-600 mb-6 relative text-white" role="region" aria-label={`Editing ${exercise.name}`}>
                        <div className="flex justify-between items-center mb-4 border-b border-slate-700 pb-2"><div><h3 className="text-2xl font-bold text-blue-400">{exercise.name}</h3>{contextualRecap && (<div className="bg-yellow-950 text-yellow-300 px-3 py-3 rounded mt-2 text-sm font-bold border border-yellow-700 leading-relaxed" role="note">{contextualRecap}</div>)}</div><button onClick={() => { triggerHaptic(); if(confirmDelete) { onDelete(exercise.id, exercise.name); } else { playSound('skip'); setConfirmDelete(true); setTimeout(() => setConfirmDelete(false), 3000); } }} className={`p-4 rounded-lg transition-colors ${confirmDelete ? 'bg-red-600 text-white font-bold' : 'text-red-400 hover:bg-slate-700'}`} aria-label={`Delete ${exercise.name}`}>{confirmDelete ? "Sure?" : <Icons.Trash2 size={28} />}</button></div>
                        <button onClick={() => { triggerHaptic(); playSound('skip'); onSkip(exercise); }} className="w-full mb-6 py-4 bg-slate-700 text-gray-300 border border-slate-600 rounded-lg font-bold flex items-center justify-center gap-2 active:bg-slate-600"><span className="uppercase tracking-wide text-sm">Skip for now</span> <Icons.SkipForward size={20} /></button>
                        <div className="grid grid-cols-2 gap-4 mb-4"><div ref={firstInputRef} tabIndex="-1"><NumericStepperInput id={`${exercise.id}-sets`} label="Sets" value={exercise.sets} onChange={v => onUpdate(exercise.id, 'sets', v)} step={1} unit="" /></div><div><NumericStepperInput id={`${exercise.id}-reps`} label="Reps" value={exercise.reps} onChange={v => onUpdate(exercise.id, 'reps', v)} step={1} unit="" /></div><div className="col-span-2"><NumericStepperInput id={`${exercise.id}-weight`} label="Weight" value={exercise.weight} onChange={v => onUpdate(exercise.id, 'weight', v)} step={1} unit="pounds" /></div><div className="col-span-2"><NumericStepperInput id={`${exercise.id}-time`} label="Time" value={exercise.time} onChange={v => onUpdate(exercise.id, 'time', v)} step={1} unit="seconds" /></div></div>
                        <div className="space-y-4"><div className="flex gap-2"><button onClick={() => { triggerHaptic(); playSound('success'); onNext(exercise); }} className={`w-full text-white py-5 rounded-lg font-bold text-xl shadow flex items-center justify-center gap-3 ${isLast ? 'bg-green-700 hover:bg-green-600' : 'bg-blue-700 hover:bg-blue-600'}`}>{isLast ? <><Icons.Check size={28} /> Finish</> : <><Icons.ArrowRight size={28} /> Next</>}</button></div><hr class="border-slate-700" /><label htmlFor={`notes-${exercise.id}`} className="block text-sm font-bold text-gray-400 mb-1">Optional Notes</label><textarea id={`notes-${exercise.id}`} aria-label="Notes" value={exercise.notes} onChange={(e) => onUpdate(exercise.id, 'notes', e.target.value)} className="w-full p-3 text-lg border border-slate-600 rounded bg-slate-700 focus:border-blue-600 focus:ring-4 focus:ring-blue-600/50 text-white" placeholder="" rows="2" /></div>
                    </div>
                );
            }
            const isSaved = exercise.isCompleted; const statusColor = isSaved ? "border-l-8 border-green-500 bg-slate-800" : "border border-slate-700 bg-slate-800 opacity-70"; const statusText = isSaved ? `Saved ‚úÖ` : "Not Started"; const summaryText = [exercise.sets && `${exercise.sets} sets`, exercise.reps && `${exercise.reps} reps`, exercise.weight && `${exercise.weight} pounds`].filter(Boolean).join(', ');
            return (
                <li className={`p-4 rounded-lg shadow-sm mb-3 flex justify-between items-center list-none ${statusColor}`}><div className="flex-grow pr-4"><h3 className="text-lg font-bold text-gray-200">{exercise.name}</h3><div className="flex flex-col"><span className="text-gray-400 font-medium">{summaryText}</span><span className={`text-xs font-bold uppercase tracking-wide mt-1 ${isSaved ? 'text-green-400' : 'text-gray-500'}`}>Status: {statusText}</span></div></div><button onClick={() => {triggerHaptic(); onEdit(exercise.id)}} className="p-4 bg-slate-700 text-blue-400 rounded-lg border border-slate-600 hover:bg-slate-600 min-h-[44px] min-w-[44px]" aria-label={`Edit ${exercise.name}`}><Icons.Edit2 size={20} /></button></li>
            );
        }

        function CardioForm({ history, onSave, onCancel, initialActivity }) {
            const [activity, setActivity] = useState(initialActivity || '');
            const [showEtpMenu, setShowEtpMenu] = useState(false);
            const [activeRunConfig, setActiveRunConfig] = useState(null); 
            const [formData, setFormData] = useState({ duration: '20', speedEasy: '', speedMod: '', speedHard: '', speedAllOut: '', intensity: '', avgSpeed: '', minIncline: '', maxIncline: '', notes: '', effort: '5', isGuided: false, warmupDur: '10', warmupSpd: '', tempoDur: '20', tempoSpd: '', cooldownDur: '10', cooldownSpd: '', inclinePct: '', avgHR: '', maxHR: '', progBaseDur: '10', progBaseSpd: '', progBuildDur: '10', progBuildSpd: '', progFinishDur: '10', progFinishSpd: '' });
            const durationRef = useRef(null);

            const tempoStats = useMemo(() => {
                if (activity !== 'Tempo Run') return null;
                const wD = parseFloat(formData.warmupDur) || 0; const tD = parseFloat(formData.tempoDur) || 0; const cD = parseFloat(formData.cooldownDur) || 0;
                const totalDur = wD + tD + cD;
                const wS = parseFloat(formData.warmupSpd) || 0; const tS = parseFloat(formData.tempoSpd) || 0; const cS = parseFloat(formData.cooldownSpd) || 0;
                let totalDist = 0; if (totalDur > 0) totalDist = (wD/60 * wS) + (tD/60 * tS) + (cD/60 * cS);
                const avgSpd = totalDur > 0 ? (totalDist / (totalDur/60)).toFixed(1) : 0;
                return { totalDur, avgSpd };
            }, [activity, formData.warmupDur, formData.tempoDur, formData.cooldownDur, formData.warmupSpd, formData.tempoSpd, formData.cooldownSpd]);

            const progStats = useMemo(() => {
                if (activity !== 'Progressive Run') return null;
                const bD = parseFloat(formData.progBaseDur) || 0; const buD = parseFloat(formData.progBuildDur) || 0; const fD = parseFloat(formData.progFinishDur) || 0;
                const totalDur = bD + buD + fD;
                const bS = parseFloat(formData.progBaseSpd) || 0; const buS = parseFloat(formData.progBuildSpd) || 0; const fS = parseFloat(formData.progFinishSpd) || 0;
                let totalDist = 0; if (totalDur > 0) totalDist = (bD/60 * bS) + (buD/60 * buS) + (fD/60 * fS);
                const avgSpd = totalDur > 0 ? (totalDist / (totalDur/60)).toFixed(1) : 0;
                return { totalDur, avgSpd };
            }, [activity, formData.progBaseDur, formData.progBuildDur, formData.progFinishDur, formData.progBaseSpd, formData.progBuildSpd, formData.progFinishSpd]);

            const lastSession = useMemo(() => { if (!activity) return null; return history.slice().reverse().find(h => h.isCardio && h.activity === activity); }, [activity, history]);
            const handleQuickLog = () => { if (!lastSession || !lastSession.metrics) return; const payload = { ...lastSession.metrics, notes: '', effort: '5' }; triggerHaptic(); playSound('success'); onSave(activity, payload); };

            useEffect(() => { if (activity) { if (lastSession && lastSession.metrics) { setFormData(prev => ({ ...prev, ...lastSession.metrics, notes: '', effort: '5' })); } else { setFormData(prev => ({ ...prev, duration: '20', notes: '', effort: '5', isGuided: false })); } setTimeout(() => durationRef.current?.focus(), 100); } }, [activity, lastSession]);

            // --- ACTIVATE SCREEN LOCK FOR CARDIO ---
            // Lock screen when activeRunConfig is present
            useWakeLock(!!activeRunConfig);

            const handleChange = (field, value) => setFormData(prev => ({ ...prev, [field]: value }));
            const handleSubmit = (e) => { e.preventDefault(); if (!activity) return; triggerHaptic(); playSound('success'); let finalData = { ...formData }; if (activity === 'Tempo Run' && tempoStats) { finalData.duration = tempoStats.totalDur.toString(); finalData.avgSpeed = tempoStats.avgSpd.toString(); } if (activity === 'Progressive Run' && progStats) { finalData.duration = progStats.totalDur.toString(); finalData.avgSpeed = progStats.avgSpd.toString(); } onSave(activity, finalData); };

            // --- START ACTIVE RUN HANDLER ---
            const startActiveRun = () => {
                triggerHaptic();
                let phases = [];
                if (activity === 'Tempo Run') {
                    phases = [
                        { name: 'Warm Up', durationMinutes: parseFloat(formData.warmupDur) || 10, speed: formData.warmupSpd },
                        { name: 'Tempo', durationMinutes: parseFloat(formData.tempoDur) || 20, speed: formData.tempoSpd },
                        { name: 'Cool Down', durationMinutes: parseFloat(formData.cooldownDur) || 10, speed: formData.cooldownSpd }
                    ];
                } else if (activity === 'Progressive Run') {
                    phases = [
                        { name: 'Base', durationMinutes: parseFloat(formData.progBaseDur) || 10, speed: formData.progBaseSpd },
                        { name: 'Build', durationMinutes: parseFloat(formData.progBuildDur) || 10, speed: formData.progBuildSpd },
                        { name: 'Finish', durationMinutes: parseFloat(formData.progFinishDur) || 10, speed: formData.progFinishSpd }
                    ];
                }
                if (phases.length > 0) setActiveRunConfig({ phases, type: activity });
            };

            if (activeRunConfig) {
                return <ActiveRunTimer phases={activeRunConfig.phases} type={activeRunConfig.type} onCancel={() => setActiveRunConfig(null)} onComplete={() => setActiveRunConfig(null)} />;
            }

            if (showEtpMenu) return <ETPMenuView onBack={() => { setActivity(''); setShowEtpMenu(false); }} onSelect={(act) => { setActivity(act); setShowEtpMenu(false); }} />;

            if (!activity) {
                return (
                    <div className="bg-slate-800 text-white p-6 rounded-lg shadow-lg border border-slate-700">
                        <div className="text-center mb-6"><h2 role="presentation" className="text-2xl font-bold text-blue-400 mb-1" tabIndex="-1">Cardio Selection</h2></div>
                        <div className="grid grid-cols-1 gap-4">{['HIIT Run', 'Indoor Cycle', 'ETP Run', 'Incline Walk'].map(type => (<button key={type} onClick={() => { triggerHaptic(); if (type === 'ETP Run') { setShowEtpMenu(true); } else { setActivity(type); } }} className="p-5 bg-slate-700 text-blue-300 font-bold text-xl rounded-lg border-2 border-slate-600 hover:bg-slate-600 hover:border-blue-500 text-left flex justify-between items-center">{type} <Icons.ArrowRight size={24} /></button>))}</div>
                        <button onClick={() => { triggerHaptic(); onCancel(); }} className="w-full mt-6 py-4 text-gray-400 font-bold text-lg flex items-center justify-center gap-2 bg-slate-700 rounded-lg hover:bg-slate-600"><Icons.X size={24} /> Cancel</button>
                    </div>
                );
            }
            
            return (
                <form onSubmit={handleSubmit} className="bg-slate-800 text-white p-6 rounded-lg shadow-xl border-t-8 border-indigo-600 space-y-8 border-slate-700">
                    <div className="flex justify-between items-center mb-4"><h2 role="presentation" className="text-2xl font-bold text-indigo-400">{activity} Log</h2>{lastSession && (<button type="button" onClick={handleQuickLog} className="bg-green-900 text-green-300 px-4 py-2 rounded-lg font-bold text-sm border border-green-700 shadow-sm hover:bg-green-800">‚ö° Quick Log: Same as Last Time</button>)}</div>
                    {lastSession && (<div className="bg-yellow-950 p-3 rounded mb-4 border border-yellow-700 text-sm text-yellow-300"><strong>Last Time:</strong> {lastSession.metrics.duration} minutes {lastSession.metrics.avgSpeed && `@ ${lastSession.metrics.avgSpeed} mph`}</div>)}

                    <section className="bg-slate-700 p-4 rounded-lg border border-slate-600 space-y-6">
                        <h3 role="presentation" className="font-bold text-gray-300 uppercase text-lg border-b border-slate-600 pb-2">Activity Metrics</h3>
                        
                        {activity === 'Tempo Run' && (
                            <div className="space-y-6" ref={durationRef} tabIndex="-1">
                                <div className="bg-blue-950 p-4 rounded-lg border border-blue-700 text-center mb-4"><p className="text-sm font-bold text-blue-300 uppercase">Calculated Totals</p><div className="flex justify-around mt-2 text-white"><div><span className="block text-2xl font-black">{tempoStats.totalDur}</span><span className="text-xs text-gray-400">Minutes</span></div><div><span className="block text-2xl font-black">{tempoStats.avgSpd}</span><span className="text-xs text-gray-400">Avg MPH</span></div></div></div>
                                <h4 role="presentation" className="font-bold text-gray-400 uppercase text-sm border-b border-slate-600 pb-1">1. Warm Up Segment</h4>
                                <div className="grid grid-cols-2 gap-4"><NumericStepperInput id="tm-w-dur" label="Duration" value={formData.warmupDur} onChange={v => handleChange('warmupDur', v)} step={1} unit="minutes" /><NumericStepperInput id="tm-w-spd" label="Speed" value={formData.warmupSpd} onChange={v => handleChange('warmupSpd', v)} step={0.1} unit="mph" /></div>
                                <h4 role="presentation" className="font-bold text-gray-400 uppercase text-sm border-b border-slate-600 pb-1">2. Tempo Segment</h4>
                                <div className="grid grid-cols-2 gap-4"><NumericStepperInput id="tm-t-dur" label="Duration" value={formData.tempoDur} onChange={v => handleChange('tempoDur', v)} step={1} unit="minutes" /><NumericStepperInput id="tm-t-spd" label="Speed" value={formData.tempoSpd} onChange={v => handleChange('tempoSpd', v)} step={0.1} unit="mph" /></div>
                                <h4 role="presentation" className="font-bold text-gray-400 uppercase text-sm border-b border-slate-600 pb-1">3. Cool Down Segment</h4>
                                <div className="grid grid-cols-2 gap-4"><NumericStepperInput id="tm-c-dur" label="Duration" value={formData.cooldownDur} onChange={v => handleChange('cooldownDur', v)} step={1} unit="minutes" /><NumericStepperInput id="tm-c-spd" label="Speed" value={formData.cooldownSpd} onChange={v => handleChange('cooldownSpd', v)} step={0.1} unit="mph" /></div>
                                <NumericStepperInput id="tm-inc" label="Incline" value={formData.inclinePct} onChange={v => handleChange('inclinePct', v)} step={1} unit="%" />
                                <button type="button" onClick={startActiveRun} className="w-full py-6 mt-4 bg-green-700 text-white rounded-xl shadow-lg font-bold text-2xl flex items-center justify-center gap-3 border-b-4 border-green-900 active:border-b-0 active:mt-1"><Icons.Play size={32} /> Start Audio Guided Run</button>
                            </div>
                        )}
                        {activity === 'Progressive Run' && (
                             <div className="space-y-6" ref={durationRef} tabIndex="-1">
                                <div className="bg-purple-950 p-4 rounded-lg border border-purple-700 text-center mb-4"><p className="text-sm font-bold text-purple-300 uppercase">Calculated Totals</p><div className="flex justify-around mt-2 text-white"><div><span className="block text-2xl font-black">{progStats.totalDur}</span><span className="text-xs text-gray-400">Minutes</span></div><div><span className="block text-2xl font-black">{progStats.avgSpd}</span><span className="text-xs text-gray-400">Avg MPH</span></div></div></div>
                                <h4 role="presentation" className="font-bold text-gray-400 uppercase text-sm border-b border-slate-600 pb-1">1. Base Segment</h4>
                                <div className="grid grid-cols-2 gap-4"><NumericStepperInput id="pg-b-dur" label="Duration" value={formData.progBaseDur} onChange={v => handleChange('progBaseDur', v)} step={1} unit="minutes" /><NumericStepperInput id="pg-b-spd" label="Speed" value={formData.progBaseSpd} onChange={v => handleChange('progBaseSpd', v)} step={0.1} unit="mph" /></div>
                                <h4 role="presentation" className="font-bold text-gray-400 uppercase text-sm border-b border-slate-600 pb-1">2. Build Segment</h4>
                                <div className="grid grid-cols-2 gap-4"><NumericStepperInput id="pg-bu-dur" label="Duration" value={formData.progBuildDur} onChange={v => handleChange('progBuildDur', v)} step={1} unit="minutes" /><NumericStepperInput id="pg-bu-spd" label="Speed" value={formData.progBuildSpd} onChange={v => handleChange('progBuildSpd', v)} step={0.1} unit="mph" /></div>
                                <h4 role="presentation" className="font-bold text-gray-400 uppercase text-sm border-b border-slate-600 pb-1">3. Finish Segment</h4>
                                <div className="grid grid-cols-2 gap-4"><NumericStepperInput id="pg-f-dur" label="Duration" value={formData.progFinishDur} onChange={v => handleChange('progFinishDur', v)} step={1} unit="minutes" /><NumericStepperInput id="pg-f-spd" label="Speed" value={formData.progFinishSpd} onChange={v => handleChange('progFinishSpd', v)} step={0.1} unit="mph" /></div>
                                <NumericStepperInput id="pg-inc" label="Incline" value={formData.inclinePct} onChange={v => handleChange('inclinePct', v)} step={1} unit="%" />
                                <button type="button" onClick={startActiveRun} className="w-full py-6 mt-4 bg-green-700 text-white rounded-xl shadow-lg font-bold text-2xl flex items-center justify-center gap-3 border-b-4 border-green-900 active:border-b-0 active:mt-1"><Icons.Play size={32} /> Start Audio Guided Run</button>
                            </div>
                        )}
                        {activity === 'HIIT Run' && (
                            <div className="space-y-4" ref={durationRef} tabIndex="-1"><NumericStepperInput id="c-duration" label="Total Duration" value={formData.duration} onChange={v => handleChange('duration', v)} step={1} unit="minutes" /><div className="grid grid-cols-2 gap-4"><div><NumericStepperInput id="c-easy" label="Easy" value={formData.speedEasy} onChange={v => handleChange('speedEasy', v)} step={0.1} unit="mph" /></div><div><NumericStepperInput id="c-mod" label="Moderate" value={formData.speedMod} onChange={v => handleChange('speedMod', v)} step={0.1} unit="mph" /></div><div><NumericStepperInput id="c-hard" label="Hard" value={formData.speedHard} onChange={v => handleChange('speedHard', v)} step={0.1} unit="mph" /></div><div><NumericStepperInput id="c-max" label="All Out" value={formData.speedAllOut} onChange={v => handleChange('speedAllOut', v)} step={0.1} unit="mph" /></div></div><NumericStepperInput id="c-inc" label="Incline" value={formData.inclinePct} onChange={v => handleChange('inclinePct', v)} step={1} unit="%" /></div>
                        )}
                        {activity === 'Indoor Cycle' && (
                            <div className="space-y-4" ref={durationRef} tabIndex="-1"><NumericStepperInput id="c-duration" label="Total Duration" value={formData.duration} onChange={v => handleChange('duration', v)} step={1} unit="minutes" /><div><label className="block text-sm font-bold text-gray-300 mb-3" id="intensity-label">Intensity</label><div className="grid grid-cols-2 gap-3" role="radiogroup" aria-labelledby="intensity-label">{['Easy', 'Moderate', 'Hard', 'All Out'].map(level => (<label key={level} className={`p-4 border-2 rounded-lg flex items-center justify-center font-bold cursor-pointer ${formData.intensity === level ? 'bg-indigo-700 border-indigo-400 text-white' : 'border-slate-600 text-gray-300 bg-slate-800 hover:bg-slate-700'}`}><input type="radio" name="intensity" value={level} checked={formData.intensity === level} onChange={e => handleChange('intensity', e.target.value)} className="sr-only" />{level}</label>))}</div></div></div>
                        )}
                        {activity === 'Endurance Run' && (
                            <div className="space-y-4" ref={durationRef} tabIndex="-1"><NumericStepperInput id="c-duration" label="Total Duration" value={formData.duration} onChange={v => handleChange('duration', v)} step={1} unit="minutes" /><NumericStepperInput id="c-avg" label="Average Speed" value={formData.avgSpeed} onChange={v => handleChange('avgSpeed', v)} step={0.1} unit="miles per hour" /><NumericStepperInput id="c-inc" label="Incline" value={formData.inclinePct} onChange={v => handleChange('inclinePct', v)} step={1} unit="%" /></div>
                        )}
                        {activity === 'Incline Walk' && (
                            <div className="space-y-4" ref={durationRef} tabIndex="-1"><NumericStepperInput id="c-duration" label="Total Duration" value={formData.duration} onChange={v => handleChange('duration', v)} step={1} unit="minutes" /><NumericStepperInput id="c-w-avg" label="Average Speed" value={formData.avgSpeed} onChange={v => handleChange('avgSpeed', v)} step={0.1} unit="miles per hour" /><div className="grid grid-cols-2 gap-4"><div><NumericStepperInput id="c-min" label="Min Incline" value={formData.minIncline} onChange={v => handleChange('minIncline', v)} step={1} unit="%" /></div><div><NumericStepperInput id="c-max" label="Max Incline" value={formData.maxIncline} onChange={v => handleChange('maxIncline', v)} step={1} unit="%" /></div></div></div>
                        )}
                    </section>
                    
                    <section className="bg-slate-700 p-4 rounded-lg border border-slate-600 space-y-4"><h3 role="presentation" className="font-bold text-gray-300 uppercase text-lg border-b border-slate-600 pb-2">Heart Rate Statistics</h3><div className="grid grid-cols-2 gap-4"><StaticInput id="std-hr-avg" label="Average HR" value={formData.avgHR} onChange={v => handleChange('avgHR', v)} inputMode="numeric" unit="bpm" /><StaticInput id="std-hr-max" label="Max HR" value={formData.maxHR} onChange={v => handleChange('maxHR', v)} inputMode="numeric" unit="bpm" /></div></section>
                    <section className="bg-slate-700 p-4 rounded-lg border border-slate-600 space-y-6"><h3 role="presentation" className="font-bold text-gray-300 uppercase text-lg border-b border-slate-600 pb-2">Session Details</h3><div className="flex items-center gap-3"><input id="c-guided" type="checkbox" checked={formData.isGuided} onChange={e => handleChange('isGuided', e.target.checked)} className="w-6 h-6 text-blue-600 rounded focus:ring-blue-500 border-gray-300 bg-slate-800" /><label htmlFor="c-guided" className="text-lg font-bold text-gray-300">Guided Routine (Fitness+)</label></div><div><label htmlFor="cardio-notes" className="block text-sm font-bold text-gray-300 mb-1">Notes</label><textarea id="cardio-notes" aria-label="Notes on Cardio" value={formData.notes} onChange={e => handleChange('notes', e.target.value)} className="w-full p-3 text-lg border border-slate-600 rounded bg-slate-800 text-white" placeholder="" rows="3" /></div><div className="bg-indigo-900 p-4 rounded-lg border border-indigo-700"><NumericStepperInput id="c-effort" label="Effort Score (1-10)" value={formData.effort} onChange={v => handleChange('effort', v)} step={1} unit="" min={1} max={10} /></div></section>
                    <div className="flex gap-3 pt-4"><button type="submit" className="w-full py-4 bg-indigo-700 text-white rounded-lg font-bold text-xl shadow flex items-center justify-center gap-2 hover:bg-indigo-600"><Icons.Check size={24} /> Save Log Entry</button></div>
                </form>
            );
        }

        const generateReportText = (entries, filterType) => { let text = `KINETIC COMPASS REPORT - ${filterType.toUpperCase()}\nGenerated: ${new Date().toLocaleString()}\n----------------------------------------\n\n`; if (entries.length === 0) { text += "No workouts found for this period.\n"; return text; } entries.forEach(entry => { const dateStr = new Date(entry.date).toLocaleDateString(); text += `DATE: ${dateStr}\n`; if (entry.isCardio) { text += `TYPE: Cardio (${entry.activity})\nDURATION: ${entry.metrics.duration} mins\n`; } else if (entry.isVital) { text += `TYPE: Vitals Log\nWEIGHT: ${entry.metrics.weight} lbs\n`; } else { text += `TYPE: Weight Training (${entry.routine})\n`; (entry.exercises || []).forEach(ex => { text += ` - ${ex.name}: ${ex.weight}lbs (${ex.sets}x${ex.reps})\n`; }); } text += `\n----------------------------------------\n\n`; }); return text; };
        const generateReportCSV = (entries) => { const headers = ["Date", "Type", "Activity", "Duration", "Weight", "Notes"]; let csv = headers.join(',') + '\n'; const escapeCSV = (value) => { if (!value) return ''; return `"${String(value).replace(/"/g, '""')}"`; }; entries.forEach(entry => { const dateStr = new Date(entry.date).toLocaleDateString(); if (entry.isCardio) { csv += [dateStr, "Cardio", entry.activity, entry.metrics.duration, "", entry.metrics.notes].map(escapeCSV).join(',') + '\n'; } else if (entry.isVital) { csv += [dateStr, "Vitals", "Log", "", entry.metrics.weight, entry.metrics.notes].map(escapeCSV).join(',') + '\n'; } else { csv += [dateStr, "Strength", entry.routine, "", "", ""].map(escapeCSV).join(',') + '\n'; } }); return csv; };

        function ReportsView({ history, onBack }) {
            const [filter, setFilter] = useState('week'); const [reportText, setReportText] = useState(''); const [filteredEntries, setFilteredEntries] = useState([]); const generateFilename = (ext = 'txt') => { const now = new Date(); return `KineticCompass_Report_${now.getTime()}.${ext}`; };
            useEffect(() => { const now = new Date(); const filtered = history.filter(entry => { const d = new Date(entry.date); if (filter === 'week') { const oneWeekAgo = new Date(); oneWeekAgo.setDate(now.getDate() - 7); return d >= oneWeekAgo; } return true; }).slice().reverse(); setFilteredEntries(filtered); setReportText(generateReportText(filtered, filter)); }, [filter, history]);
            const handleCopy = () => { triggerHaptic(); const ta = document.createElement("textarea"); ta.value = reportText; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); alert("Report copied!"); };
            const handleDownloadTXT = () => { triggerHaptic(); const blob = new Blob([reportText], { type: 'text/plain' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = generateFilename('txt'); document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); };
            const handleDownloadCSV = () => { triggerHaptic(); const csvData = generateReportCSV(filteredEntries); const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = generateFilename('csv'); document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); };
            return (
                <div className="space-y-6">
                    <div className="bg-slate-800 text-white p-4 rounded-lg shadow text-center border border-slate-700"><h2 role="presentation" className="text-xl font-bold">Reports</h2></div>
                    <div className="bg-slate-800 text-white p-4 rounded-lg shadow border border-slate-700"><div className="grid grid-cols-5 gap-1">{['day', 'week', 'month', 'year', 'all'].map(f => (<button key={f} onClick={() => { triggerHaptic(); setFilter(f); }} className={`py-3 px-1 rounded text-sm font-bold uppercase ${filter === f ? 'bg-blue-600 text-white' : 'bg-slate-700 text-gray-300'}`}>{f}</button>))}</div></div>
                    <div className="flex gap-2"><button onClick={handleCopy} className="flex-1 py-4 bg-indigo-900 text-indigo-300 border-2 border-indigo-700 rounded-lg font-bold flex items-center justify-center gap-2 text-sm hover:bg-indigo-800"><Icons.Clipboard size={20} /> Copy</button><button onClick={handleDownloadTXT} className="flex-1 py-4 bg-green-900 text-green-300 border-2 border-green-700 rounded-lg font-bold flex items-center justify-center gap-2 text-sm hover:bg-green-800"><Icons.FileText size={20} /> TXT</button><button onClick={handleDownloadCSV} className="flex-1 py-4 bg-yellow-900 text-yellow-300 border-2 border-yellow-700 rounded-lg font-bold flex items-center justify-center gap-2 text-sm hover:bg-yellow-800"><Icons.Download size={20} /> CSV</button></div>
                    <div className="space-y-4"><h3 role="presentation" className="text-lg font-bold text-gray-300 border-b border-slate-700 pb-2">Preview</h3><div className="bg-slate-900 p-4 rounded-lg shadow-inner text-xs font-mono whitespace-pre-wrap max-h-[50vh] overflow-y-auto border border-slate-700 text-gray-300">{reportText}</div></div>
                </div>
            );
        }

        function AddExerciseForm({ onAdd, routine, availableExercises }) {
            const [mode, setMode] = useState('select');
            const [customInput, setCustomInput] = useState('');
            const selectRef = useRef(null);
            const inputRef = useRef(null);
            const handleSelectChange = (e) => { const val = e.target.value; if (val === 'TYPE_NEW') { setMode('type'); setTimeout(() => inputRef.current?.focus(), 100); } else if (val !== '') { onAdd(val, false); e.target.value = ''; } };
            const handleCustomSubmit = (e) => { e.preventDefault(); if (customInput.trim()) { onAdd(customInput.trim(), true); setCustomInput(''); setMode('select'); setTimeout(() => selectRef.current?.focus(), 100); } };
            return (
                <div className="bg-blue-950 p-4 rounded-lg border-2 border-blue-800 mt-6">
                    <div className="flex justify-between items-center mb-2"><h2 role="presentation" className="text-lg font-bold text-gray-400 uppercase tracking-wide mb-2 pl-1">Add New Exercise</h2><a href="#" onClick={(e) => { e.preventDefault(); inputRef.current && inputRef.current.focus(); }} className="sr-only">Jump to Add Form</a></div>
                    {mode === 'select' ? (<div className="relative"><select ref={selectRef} onChange={handleSelectChange} defaultValue="" className="block w-full p-4 text-lg border border-blue-700 rounded shadow-sm focus:ring-4 focus:ring-blue-600 appearance-none bg-slate-800 text-white"><option value="" disabled>Select exercise...</option>{availableExercises.map((ex) => (<option key={ex} value={ex}>{ex}</option>))}<option value="TYPE_NEW" className="font-bold text-blue-400">+ Type New...</option></select><div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-400"><Icons.ChevronDown size={24} /></div></div>) : (<form onSubmit={handleCustomSubmit} className="flex flex-col gap-3"><input ref={inputRef} type="text" value={customInput} onChange={(e) => setCustomInput(e.target.value)} placeholder={`New ${routine} Exercise Name`} className="w-full p-4 border border-blue-700 rounded shadow-sm text-lg focus:ring-4 focus:ring-blue-600 bg-slate-800 text-white" autoComplete="off" /><div className="flex gap-2"><button type="button" onClick={() => setMode('select')} className="flex-1 py-3 bg-slate-700 text-gray-300 rounded-lg font-bold hover:bg-slate-600">Cancel</button><button type="submit" className="flex-1 py-3 bg-blue-700 text-white rounded-lg font-bold hover:bg-blue-600">Save</button></div></form>)}
                </div>
            );
        }

        function App() {
            const [isDataLoaded, setIsDataLoaded] = useState(false); 
            const [showSplash, setShowSplash] = useState(true);
            const [currentDate, setCurrentDate] = useState(new Date());
            const [view, setView] = useState('menu'); 
            const [history, setHistory] = useState([]);
            const [manualRoutine, setManualRoutine] = useState(null);
            const [todaysExercises, setTodaysExercises] = useState([]);
            const [customDb, setCustomDb] = useState({});
            const [editingId, setEditingId] = useState(null);
            const [announcement, setAnnouncement] = useState('');
            const [workoutEffort, setWorkoutEffort] = useState('5');
            const [targetCardio, setTargetCardio] = useState('');

            const announcementRef = useRef(null);
            const headerRef = useRef(null);
            const finishRef = useRef(null);

            useEffect(() => {
                try {
                    const savedHistory = localStorage.getItem('workout_history');
                    const savedCurrentSession = localStorage.getItem('current_session');
                    const savedSessionDate = localStorage.getItem('current_session_date');
                    const savedCustomDb = localStorage.getItem('custom_exercise_db');
                    const savedManualRoutine = localStorage.getItem('manual_routine');
                    const seenSplash = sessionStorage.getItem('seen_splash_v5');
                    if (savedHistory) setHistory(JSON.parse(savedHistory));
                    if (savedCustomDb) setCustomDb(JSON.parse(savedCustomDb));
                    const todayStr = new Date().toLocaleDateString();
                    if (savedSessionDate && savedSessionDate !== todayStr) { localStorage.removeItem('manual_routine'); setManualRoutine(null); } else { if (savedManualRoutine) setManualRoutine(savedManualRoutine); }
                    if (savedCurrentSession && savedSessionDate) { if (savedSessionDate === todayStr) { try { setTodaysExercises(JSON.parse(savedCurrentSession)); } catch(e) { console.error("Session corrupted", e); } } }
                    if (seenSplash) setShowSplash(false);
                } catch (err) { console.error("Critical Init Error", err); } finally { setTimeout(() => { const loader = document.getElementById('loading-screen'); if (loader) loader.style.display = 'none'; setIsDataLoaded(true); }, 800); }
            }, []);

            useEffect(() => { if(isDataLoaded) localStorage.setItem('current_session', JSON.stringify(todaysExercises)); }, [todaysExercises, isDataLoaded]);
            useEffect(() => { if(isDataLoaded) localStorage.setItem('current_session_date', new Date().toDateString()); }, [todaysExercises, isDataLoaded]);
            useEffect(() => { if(isDataLoaded) localStorage.setItem('workout_history', JSON.stringify(history)); }, [history, isDataLoaded]);
            useEffect(() => { if(isDataLoaded) localStorage.setItem('custom_exercise_db', JSON.stringify(customDb)); }, [customDb, isDataLoaded]);
            
            useEffect(() => { if (headerRef.current && !showSplash) { setTimeout(() => headerRef.current.focus(), 100); } }, [view, showSplash]);

            // --- ACTIVATE SCREEN LOCK FOR WEIGHTS ---
            // Only lock if we are in the 'weights' view
            useWakeLock(view === 'weights');

            const activeRoutine = manualRoutine || getRoutineForDay(currentDate);
            const announce = (message) => { setAnnouncement(message); setTimeout(() => setAnnouncement(''), 6000); };

            const goToMenu = () => { try { sessionStorage.setItem('seen_splash_v5', 'true'); } catch (e) {} setShowSplash(false); setView('menu'); };
            const switchToBonus = () => { try { sessionStorage.setItem('seen_splash_v5', 'true'); } catch (e) {} setShowSplash(false); setView('bonus'); };
            const changeRoutine = (newRoutine) => { if (todaysExercises.length > 0) { setTodaysExercises([]); } setManualRoutine(newRoutine); localStorage.setItem('manual_routine', newRoutine); };

            const handleBonusSave = (entry) => {
                const record = { id: Date.now(), date: new Date().toString(), isCardio: entry.type === 'Cardio', routine: 'Bonus Session', isBonus: true, activity: entry.type === 'Cardio' ? entry.name : undefined, metrics: entry.type === 'Cardio' ? { duration: entry.duration, notes: entry.notes, ...entry } : undefined, exercises: entry.type === 'Strength' ? [{ name: entry.name, weight: entry.weight, sets: entry.sets, reps: entry.reps }] : undefined };
                setHistory(prev => [...prev, record]);
                announce(`${entry.name} saved to Bonus Session.`);
            };

            const handleVitalsSave = (metrics) => { const record = { id: Date.now(), date: new Date().toString(), isVital: true, metrics: metrics }; setHistory(prev => [...prev, record]); setView('menu'); announce("Vitals Saved."); };
            
            const masterExerciseList = useMemo(() => { const standard = Object.values(DEFAULT_DB).flat(); const custom = Object.values(customDb).flat(); return [...new Set([...standard, ...custom])].sort(); }, [customDb]);

            const activeExercise = useMemo(() => {
                if (todaysExercises.length === 0) return null;
                if (editingId) { const found = todaysExercises.find(ex => ex.id === editingId); if (found) return found; }
                return todaysExercises.find(ex => !ex.isCompleted);
            }, [todaysExercises, editingId]);

            const upNextExercises = useMemo(() => { if (!activeExercise) return []; const activeIndex = todaysExercises.findIndex(ex => ex.id === activeExercise.id); return todaysExercises.slice(activeIndex + 1).filter(ex => !ex.isCompleted); }, [todaysExercises, activeExercise]);
            const completedExercises = useMemo(() => { return todaysExercises.filter(ex => ex.isCompleted); }, [todaysExercises]);

            const handleNextExercise = (currentExercise) => { 
                triggerHaptic(); playSound('success');
                if (currentExercise.weight && currentExercise.previousWeight) { const cleanWeight = parseFloat(currentExercise.weight.toString().replace(/[^0-9.]/g, '')); const cleanPrev = parseFloat(currentExercise.previousWeight.toString().replace(/[^0-9.]/g, '')); if (!isNaN(cleanWeight) && !isNaN(cleanPrev) && cleanWeight > cleanPrev) { announce(`New PR on ${currentExercise.name}!`); } }
                setTodaysExercises(prev => prev.map(e => e.id === currentExercise.id ? { ...e, isCompleted: true } : e));
                setEditingId(null); announce("Saved. Loading next.");
            };

            const handleSkipExercise = (currentExercise) => { 
                triggerHaptic(); playSound('skip');
                const currentIndex = todaysExercises.findIndex(ex => ex.id === currentExercise.id); 
                const newSession = [...todaysExercises]; newSession.splice(currentIndex, 1); newSession.push(currentExercise); 
                setTodaysExercises(newSession); setEditingId(null); announce(`Skipped. Now: ${newSession[currentIndex].name}.`); 
            };

            const handleLoadLastWorkout = () => { 
                triggerHaptic(); const lastWorkout = history.slice().reverse().find(w => !w.isCardio && w.routine === activeRoutine); 
                if (!lastWorkout) { announce("No history."); return; } 
                const newSession = lastWorkout.exercises.map(ex => ({ ...ex, id: Date.now() + Math.random(), previousWeight: ex.weight, isCompleted: false })); 
                if (todaysExercises.length > 0) { const existingNames = new Set(todaysExercises.map(ex => ex.name)); const uniqueNew = newSession.filter(ex => !existingNames.has(ex.name)); if (uniqueNew.length === 0) { announce("All exercises already in list."); return; } setTodaysExercises(prev => [...prev, ...uniqueNew]); announce(`Merged ${uniqueNew.length} exercises.`); } else { setTodaysExercises(newSession); if(newSession.length) setEditingId(newSession[0].id); announce("Loaded."); }
            };

            const handleAddExercise = (exerciseName, isNewCustom) => { 
                triggerHaptic(); if(isNewCustom) setCustomDb(prev => { const list = prev[activeRoutine] || []; if (!list.includes(exerciseName)) return { ...prev, [activeRoutine]: [...list, exerciseName] }; return prev; }); 
                let lastData = { sets: '', reps: '', weight: '', time: '', notes: '' };
                for (let i = history.length - 1; i >= 0; i--) { if (history[i].isCardio) continue; if (history[i].isBonus) continue; const pastExercise = history[i].exercises.find(e => e.name.toLowerCase() === exerciseName.toLowerCase()); if (pastExercise) { lastData = { ...pastExercise }; break; } }
                const newExercise = { id: Date.now(), name: exerciseName, sets: lastData.sets || '', reps: lastData.reps || '', weight: lastData.weight || '', time: lastData.time || '', notes: '', previousWeight: lastData.weight || '', isCompleted: false }; 
                setTodaysExercises([...todaysExercises, newExercise]); setEditingId(newExercise.id); announce("Added."); 
            };

            const updateExercise = (id, field, value) => { setTodaysExercises(prev => prev.map(ex => ex.id === id ? { ...ex, [field]: value } : ex)); };
            const removeExercise = (id, name) => { setTodaysExercises(prev => prev.filter(ex => ex.id !== id)); if (editingId === id) setEditingId(null); announce("Removed."); };
            
            const finishWorkout = () => { triggerHaptic(); if (!todaysExercises.length) return; setEditingId(null); const record = { id: Date.now(), date: new Date().toString(), routine: activeRoutine, isCardio: false, exercises: todaysExercises, overallEffort: workoutEffort }; setHistory([...history, record]); setTodaysExercises([]); localStorage.removeItem('current_session'); setManualRoutine(null); setView('menu'); announce("Saved."); };
            
            const handleSaveCardio = (activity, metrics) => { const record = { id: Date.now(), date: new Date().toString(), isCardio: true, activity, metrics }; setHistory([...history, record]); announce("Saved."); setTargetCardio(''); setView('menu'); };

            const backupData = () => { triggerHaptic(); const data = { history, currentSession: todaysExercises, customDb, exportDate: new Date().toString() }; const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); const now = new Date(); const pad = (n) => n.toString().padStart(2, '0'); const timestamp = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}`; a.href = url; a.download = `KineticCompass_Backup_${timestamp}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); };
            const restoreData = (event) => { triggerHaptic(); const file = event.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); if(data.history) setHistory(data.history); if(data.currentSession) setTodaysExercises(data.currentSession); if(data.customDb) setCustomDb(data.customDb); announce("Restored."); playSound('success'); } catch(err) { playSound('skip'); alert("Invalid Backup File."); } }; reader.readAsText(file); };
            
            const availableExercises = [...(DEFAULT_DB[activeRoutine] || []), ...(customDb[activeRoutine] || [])].sort();
            const lastEntry = history.length > 0 ? history[history.length - 1] : null;
            const dbStatus = lastEntry ? `Database Active. Last activity: ${lastEntry.isCardio ? lastEntry.activity : (lastEntry.routine || 'Workout')} (${getTimeAgo(lastEntry.date)})` : "‚ö†Ô∏è Database Empty. No history found.";

            if (!isDataLoaded) return null; 

            if (showSplash) { return <SplashScreen onGoToMenu={goToMenu} onBonus={switchToBonus} routine={activeRoutine} history={history} currentSession={todaysExercises} onJumpToCardio={(act) => { if (act === 'ETP Run') { goToMenu(); setView('etp-menu'); } else { goToMenu(); setTargetCardio(act); setView('cardio'); } }} onJumpToWeights={(rt) => { goToMenu(); changeRoutine(rt); setView('weights'); }} onChangeRoutine={changeRoutine} />; }

            return (
                <div className="min-h-screen bg-slate-900 text-gray-100 font-sans pb-20">
                    <div role="status" aria-live="polite" className="sr-only" ref={announcementRef}>{announcement}</div>
                    <header role="presentation" className="bg-slate-900 text-white p-4 shadow-md sticky top-0 z-20 border-b border-slate-700">
                        <div className="max-w-3xl mx-auto flex justify-between items-center">
                            <div className="flex gap-2">{view !== 'menu' ? (<button ref={headerRef} onClick={() => {triggerHaptic(); setView('menu');}} className="p-3 bg-slate-800 rounded hover:bg-slate-700 flex items-center gap-2 font-bold" aria-label="Go to Main Menu"><Icons.ArrowLeft size={20} /> Main Menu</button>) : (<button ref={headerRef} onClick={() => { triggerHaptic(); setShowSplash(true); }} className="p-3 bg-slate-800 rounded hover:bg-slate-700 flex items-center gap-2 font-bold" aria-label="Back to Progress Page"><Icons.ArrowLeft size={20} /> Back to Progress Page</button>)}</div>
                            <button onClick={() => {triggerHaptic(); setView(view === 'settings' ? 'menu' : 'settings');}} className="p-3 bg-slate-800 rounded hover:bg-slate-700 flex items-center gap-2 font-bold" aria-label="Data Management"><Icons.Database size={20} /> Data</button>
                        </div>
                    </header>
                    <main role="presentation" className="max-w-3xl mx-auto p-4">
                        {view === 'menu' && (
                            <div className="space-y-6 mt-4">
                                <div className="text-center mb-4"><p className="text-slate-400 font-medium">{formatDate(currentDate)}</p></div>
                                <div className={`p-3 rounded-lg border-2 mb-4 text-sm font-bold text-center ${lastEntry ? 'bg-green-950 border-green-700 text-green-300' : 'bg-red-950 border-red-700 text-red-300'}`}>{dbStatus}</div>
                                {currentDate.getDay() === 5 && <div className="bg-yellow-950 border-l-8 border-yellow-700 text-yellow-300 p-4 rounded-lg flex items-center gap-3" role="alert"><Icons.AlertTriangle size={28} /><span className="font-bold text-lg">It's Friday. Don't forget to backup!</span></div>}
                                <button onClick={() => {triggerHaptic(); setView('weights');}} className="w-full p-8 bg-blue-700 text-white rounded-xl shadow-lg hover:bg-blue-800 focus:ring-4 focus:ring-blue-400 text-left"><div className="flex items-center gap-4 mb-2"><Icons.Dumbbell size={40} /><span className="text-3xl font-extrabold">{activeRoutine}</span></div></button>
                                <button onClick={() => {triggerHaptic(); setTargetCardio(''); setView('cardio');}} className="w-full p-8 bg-indigo-700 text-white rounded-xl shadow-lg hover:bg-indigo-800 focus:ring-4 focus:ring-indigo-400 text-left"><div className="flex items-center gap-4 mb-2"><Icons.Activity size={40} /><span className="text-3xl font-extrabold">Cardio</span></div></button>
                                <button onClick={() => {triggerHaptic(); setView('vitals');}} className="w-full p-6 bg-teal-600 text-white rounded-xl shadow border border-teal-500 hover:bg-teal-700 text-left flex items-center gap-4"><Icons.Heart size={32} /><span className="text-2xl font-bold">Vitals & BMI</span></button>
                                <button onClick={() => {triggerHaptic(); setView('reports');}} className="w-full p-6 bg-slate-800 text-gray-100 rounded-xl shadow border border-slate-700 hover:bg-slate-700 text-left flex items-center gap-4"><Icons.List size={32} className="text-slate-400" /><span className="text-xl font-bold">Reports</span></button>
                            </div>
                        )}
                        {view === 'bonus' && <BonusView onBack={() => {triggerHaptic(); setView('menu');}} onSaveBonus={handleBonusSave} availableExercises={masterExerciseList} history={history} onStartLucky={() => setView('lucky')} />}
                        {view === 'lucky' && <LuckyView onBack={() => {triggerHaptic(); setView('bonus');}} onSave={handleBonusSave} availableExercises={masterExerciseList} history={history} />}
                        {view === 'cardio' && <CardioForm history={history} onSave={handleSaveCardio} onCancel={() => setView('menu')} initialActivity={targetCardio} />}
                        {view === 'vitals' && <VitalsView history={history} onSave={handleVitalsSave} />}
                        {view === 'etp-menu' && <ETPMenuView onBack={() => setView('menu')} onSelect={(act) => { setTargetCardio(act); setView('cardio'); }} />}
                        
                        {view === 'weights' && (
                            <div className="space-y-6">
                                <h2 role="presentation" className="text-2xl font-bold text-blue-400 border-b-4 border-blue-600 pb-2 mb-4">{activeRoutine}</h2>
                                {todaysExercises.length === 0 && (
                                    <div className="mb-6">
                                        {history.some(w => !w.isCardio && w.routine === activeRoutine) ? (<button onClick={handleLoadLastWorkout} className="w-full bg-blue-950 text-blue-300 border-2 border-blue-800 py-6 px-6 rounded-lg font-bold text-xl shadow flex items-center justify-center gap-3 hover:bg-blue-900"><Icons.RefreshCw size={28} /> Load Last {activeRoutine}</button>) : (<div className="p-4 bg-yellow-950 border border-yellow-700 rounded-lg text-yellow-300 text-center font-medium">No history found for {activeRoutine}. Start adding exercises below!</div>)}
                                    </div>
                                )}
                                <h2 role="presentation" className="text-lg font-bold text-gray-400 uppercase tracking-wide mb-2 pl-1 border-b border-slate-700 pb-1">Current Exercise</h2>
                                {activeExercise ? (
                                    <div aria-live="polite">
                                        <ExerciseItem key={activeExercise.id} exercise={activeExercise} isEditing={true} isLast={false} onEdit={setEditingId} onDelete={removeExercise} onUpdate={updateExercise} onNext={handleNextExercise} onSkip={handleSkipExercise} previousBest={activeExercise.previousWeight} 
                                            previousData={{ weight: activeExercise.previousWeight, sets: activeExercise.sets || (history.slice().reverse().find(h => !h.isCardio && h.exercises.some(e => e.name === activeExercise.name))?.exercises.find(e => e.name === activeExercise.name)?.sets), reps: activeExercise.reps || (history.slice().reverse().find(h => !h.isCardio && h.exercises.some(e => e.name === activeExercise.name))?.exercises.find(e => e.name === activeExercise.name)?.reps), notes: (history.slice().reverse().find(h => !h.isCardio && h.exercises.some(e => e.name === activeExercise.name))?.exercises.find(e => e.name === activeExercise.name)?.notes), time: (history.slice().reverse().find(h => !h.isCardio && h.exercises.some(e => e.name === activeExercise.name))?.exercises.find(e => e.name === activeExercise.name)?.time) }}
                                        />
                                    </div>
                                ) : (
                                    todaysExercises.length > 0 && (
                                        <div className="p-6 bg-green-950 border-4 border-green-700 rounded-xl shadow-inner text-center space-y-4" role="alert">
                                            <h2 role="presentation" className="text-2xl font-bold text-green-300">‚úÖ Workout Complete!</h2><p className="text-green-400">Up next queue is empty.</p>
                                            <div className="bg-slate-800 p-4 rounded-lg border border-green-700 text-left"><NumericStepperInput id="w-effort" label="Overall Workout Effort (1-10)" value={workoutEffort} onChange={setWorkoutEffort} step={1} unit="" min={1} max={10} /></div>
                                            <div className="flex flex-col gap-3 mt-4"><button ref={finishRef} onClick={finishWorkout} className="w-full bg-green-700 text-white text-2xl font-bold py-5 px-6 rounded-lg shadow-lg flex items-center justify-center gap-3 hover:bg-green-600"><Icons.Save size={32} /> Finish Workout Now</button><div className="mt-4 pt-4 border-t border-green-700 text-left"><p className="font-bold text-green-300 mb-2">Forgot an exercise? Add it here:</p><AddExerciseForm onAdd={handleAddExercise} routine={activeRoutine} availableExercises={availableExercises} /></div></div>
                                        </div>
                                    )
                                )}
                                <div>
                                    <div className="flex justify-between items-center mb-2 border-b border-slate-700 pb-1"><h2 role="presentation" className="text-lg font-bold text-gray-400 uppercase tracking-wide pl-1">Up Next Queue</h2><button onClick={() => handleAddExercise("New Exercise", false)} className="text-blue-400 font-bold text-sm bg-blue-900 px-3 py-1 rounded hover:bg-blue-800 border border-blue-700">+ Add New</button></div>
                                    {upNextExercises.length > 0 ? (<ul className="space-y-2 list-none p-0 opacity-70">{upNextExercises.map((ex, index) => (<li key={ex.id} className="bg-slate-800 p-4 rounded-lg border border-slate-700 flex justify-between"><span className="font-bold text-gray-300">{ex.name}</span><span className="text-xs bg-slate-700 px-2 py-1 rounded text-gray-400">Waiting</span></li>))}</ul>) : (<p className="text-gray-500 italic pl-1">Queue is empty.</p>)}
                                </div>
                                <div><h2 role="presentation" className="text-lg font-bold text-gray-400 uppercase tracking-wide mb-2 pl-1 border-b border-slate-700 pb-1">Completed Log</h2>{completedExercises.length > 0 ? (<ul className="space-y-2 list-none p-0">{completedExercises.map((ex, index) => (<ExerciseItem key={ex.id} exercise={ex} isEditing={false} isLast={false} onEdit={setEditingId} onDelete={removeExercise} onUpdate={updateExercise} onNext={handleNextExercise} onSkip={handleSkipExercise} previousBest={ex.previousWeight} />))}</ul>) : (<p className="text-gray-500 italic pl-1">Nothing completed yet.</p>)}</div>
                                {activeExercise && (<div className="mt-8 border-t border-slate-700 pt-6"><h2 role="presentation" className="text-lg font-bold text-gray-400 uppercase tracking-wide mb-2 pl-1">Add New Exercise</h2><AddExerciseForm onAdd={handleAddExercise} routine={activeRoutine} availableExercises={availableExercises} /></div>)}
                            </div>
                        )}
                        {view === 'reports' && <ReportsView history={history} onBack={() => setView('menu')} />}
                        {view === 'settings' && (
                            <div className="space-y-8 bg-slate-800 p-6 rounded-lg shadow border border-slate-700">
                                <section><h2 role="presentation" className="text-2xl font-bold text-gray-200 mb-4 border-b-2 border-slate-700 pb-2">Backup & Restore</h2><div className="space-y-4"><button onClick={backupData} className="w-full flex items-center justify-center gap-3 bg-slate-700 text-white p-5 rounded-lg font-bold text-lg hover:bg-slate-600"><Icons.Download size={24} /> Backup Data</button><div className="relative"><input type="file" accept=".json" onChange={restoreData} className="opacity-0 absolute inset-0 w-full h-full cursor-pointer" id="restore-input" /><label htmlFor="restore-input" className="w-full flex items-center justify-center gap-3 bg-blue-700 text-white p-5 rounded-lg font-bold text-lg cursor-pointer hover:bg-blue-600"><Icons.Upload size={24} /> Restore Data</label></div></div></section>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

