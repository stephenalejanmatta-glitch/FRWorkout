<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Easy Log v25.33</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Engines (Using cdnjs for better stability) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
        /* Dark Mode Global Styles */
        body { 
            overscroll-behavior-y: contain; 
            -webkit-tap-highlight-color: transparent; 
            background-color: #111827; /* Tailwind gray-900 */
            color: #f3f4f6; /* Tailwind gray-100 */
        }
        button { touch-action: manipulation; }
        
        /* Loading/Error Screen for Dark Mode */
        #loading-screen {
            background-color: #1f2937; /* Tailwind gray-800 */
            color: #f3f4f6;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 9999;
            font-family: sans-serif; transition: opacity 0.5s;
        }
        
        #error-message {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #7f1d1d; /* Tailwind red-900 */
            color: #fca5a5; /* Tailwind red-300 */
            padding: 20px; z-index: 10000;
            font-family: monospace; white-space: pre-wrap; overflow: auto;
            display: none; /* Initially hidden */
        }

        .spinner {
            width: 50px; height: 50px; border: 5px solid #4b5563; /* Tailwind gray-600 */
            border-top: 5px solid #60a5fa; /* Tailwind blue-400 */
            border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Input Overrides for Dark Mode */
        input:not([type="checkbox"]):not([type="radio"]), textarea, select {
            background-color: #1f2937 !important; /* gray-800 */
            color: #f3f4f6 !important; /* gray-100 */
            border-color: #4b5563 !important; /* gray-600 */
        }
        
        /* Adjustable Input Active State in Dark Mode */
        .adjustable-input:active {
            background-color: #374151 !important; /* gray-700 */
        }

        /* Screen Reader Only Class */
        .sr-only {
            position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
            overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans pb-20">
    
    <div id="loading-screen" role="alert" aria-live="assertive">
        <div class="spinner" aria-hidden="true"></div>
        <h1 class="text-xl font-bold text-gray-300">Loading Easy Log...</h1>
    </div>

    <div id="error-message"></div>
    <div id="root"></div>

    <!-- FAILSAFE: If React fails to load, remove spinner and show error -->
    <script>
        window.onerror = function(msg, url, line) {
            const loader = document.getElementById('loading-screen');
            const errDiv = document.getElementById('error-message');
            if (loader) loader.style.display = 'none';
            if (errDiv) {
                errDiv.style.display = 'block';
                errDiv.innerHTML = "<strong>Error Loading App:</strong>\n" + msg + "\nLine: " + line;
            }
        };
        
        // Timeout check
        setTimeout(function() {
            const root = document.getElementById('root');
            if (!root || root.innerHTML.trim() === '') {
                const loader = document.getElementById('loading-screen');
                if (loader && loader.style.display !== 'none') {
                    // Try to hide it anyway so user isn't stuck
                    loader.style.display = 'none';
                    const errDiv = document.getElementById('error-message');
                    if (errDiv && errDiv.style.display === 'none') {
                        errDiv.style.display = 'block';
                        errDiv.innerHTML = "<strong>Timeout:</strong> The app is taking too long to start. Please try refreshing.";
                    }
                }
            }
        }, 5000);
    </script>

    <script type="text/babel">
        // Use a safer way to get React hooks in case destructuring fails
        const useState = React.useState;
        const useEffect = React.useEffect;
        const useRef = React.useRef;
        const useMemo = React.useMemo;

        // --- AUDIO ENGINE ---
        const audioCtxRef = { current: null };
        const playSound = (type) => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                if (!audioCtxRef.current) audioCtxRef.current = new AudioContext();
                if (audioCtxRef.current.state === 'suspended') audioCtxRef.current.resume().catch(e => console.log(e));
                const ctx = audioCtxRef.current;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                const now = ctx.currentTime;
                if (type === 'success') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(880, now); 
                    osc.frequency.exponentialRampToValueAtTime(1760, now + 0.1); 
                    gain.gain.setValueAtTime(0.3, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                    osc.start(now); osc.stop(now + 0.5);
                } else if (type === 'skip') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(300, now);
                    osc.frequency.linearRampToValueAtTime(50, now + 0.2);
                    gain.gain.setValueAtTime(0.2, now);
                    gain.gain.linearRampToValueAtTime(0.01, now + 0.2);
                    osc.start(now); osc.stop(now + 0.2);
                }
            } catch (e) { console.error("Audio error", e); }
        };

        // --- Icon Set (Minimal Functional Icons) ---
        // Icons colors are managed by the parent container's text color
        const IconWrapper = ({ children }) => <span aria-hidden="true" focusable="false" className="pointer-events-none">{children}</span>;

        const Icons = {
            Activity: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></IconWrapper>,
            AlertTriangle: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg></IconWrapper>,
            ArrowRight: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg></IconWrapper>,
            ArrowLeft: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg></IconWrapper>,
            Check: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="20 6 9 17 4 12"/></svg></IconWrapper>,
            Clipboard: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></svg></IconWrapper>,
            Database: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg></IconWrapper>,
            Download: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg></IconWrapper>,
            Dumbbell: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m2 6 4-4"/><path d="m3 10 7-7"/><path d="m14 21 7-7"/></svg></IconWrapper>,
            Edit2: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5L2 22l1.5-5.5L17 3z"/></svg></IconWrapper>,
            FileText: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg></IconWrapper>,
            List: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg></IconWrapper>,
            RefreshCw: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg></IconWrapper>,
            Save: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg></IconWrapper>,
            SkipForward: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="5 4 15 12 5 20 5 4"/><line x1="19" x2="19" y1="5" y2="19"/></svg></IconWrapper>,
            Trash2: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg></IconWrapper>,
            Upload: (props) => <IconWrapper><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg></IconWrapper>,
        };

        // --- Default Database ---
        const DEFAULT_DB = {
            'Upper Body': ['Bench Press', 'Overhead Press', 'Pull Ups', 'Dumbbell Rows', 'Bicep Curls', 'Tricep Dips', 'Lat Pulldown', 'Chest Fly', 'Face Pulls', 'Push Ups'],
            'Lower Body': ['Squats', 'Deadlifts', 'Lunges', 'Leg Press', 'Romanian Deadlifts', 'Calf Raises', 'Leg Extensions', 'Hamstring Curls', 'Goblet Squats'],
            'Core': ['Plank', 'Crunches', 'Leg Raises', 'Russian Twists', 'Ab Wheel', 'Bicycle Crunches', 'Hanging Leg Raises', 'Side Plank']
        };

        // --- Utility Functions ---
        const getRoutineForDay = (date) => {
            const day = date.getDay(); 
            if (day === 1 || day === 4) return 'Lower Body';
            if (day === 2 || day === 5) return 'Upper Body';
            return 'Core';
        };

        const getETPRunForDay = (date, manualOverride) => {
            if (manualOverride && manualOverride !== 'Scheduled') return manualOverride; 
            const day = date.getDay(); // 0=Sun, 1=Mon, 2=Tue, 3=Wed, 4=Thu, 5=Fri, 6=Sat
            if (day === 6 || day === 0 || day === 1) return 'Endurance Run';
            if (day === 3 || day === 5) return 'Tempo Run';
            if (day === 2 || day === 4) return 'Progressive Run';
            return 'Rest Day / N/A';
        };
        
        // FIX: Replaced simple format with verbose, accessible format
        const formatReportDate = (dateString) => {
            if (!dateString) return 'N/A Date';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        };
        
        const formatDate = (date) => {
            return new Intl.DateTimeFormat('en-US', { weekday: 'long', month: 'long', day: 'numeric' }).format(date);
        };

        const getGreeting = () => {
            const hour = new Date().getHours();
            if (hour < 12) return "Good Morning";
            if (hour < 17) return "Good Afternoon";
            return "Good Evening";
        };

        const triggerHaptic = () => {
            if (window.navigator && window.navigator.vibrate) {
                window.navigator.vibrate(50);
            }
        };

        const calculateBMI = (weight, height) => {
            if (!weight || !height) return { val: '--', status: 'Unknown' };
            const w = parseFloat(weight);
            const h = parseFloat(height);
            if (w <= 0 || h <= 0) return { val: '--', status: 'Unknown' };
            
            const bmi = (703 * w) / (h * h);
            const val = bmi.toFixed(1);
            let status = 'Normal';
            if (bmi < 18.5) status = 'Underweight';
            else if (bmi >= 25 && bmi < 29.9) status = 'Overweight';
            else if (bmi >= 30) status = 'Obese';
            
            return { val, status };
        };

        const calculateMHR = (age) => {
            if (!age || age <= 0) return { fox: '--', tanaka: '--' };
            const fox = Math.round(220 - age);
            const tanaka = Math.round(208 - (0.7 * age));
            return { fox, tanaka };
        };

        const getTimeAgo = (dateString) => {
            if (!dateString) return '';
            const diff = new Date() - new Date(dateString);
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            if (days === 0) return "Today";
            if (days === 1) return "Yesterday";
            return `${days} days ago`;
        };
        
        // --- TIMER COMPONENT (For use in ExerciseItem) ---
        function Timer({ initialSeconds = 60, onFinish, isRunning, onToggle, id }) {
            const [seconds, setSeconds] = useState(initialSeconds);
            const timerIdRef = useRef(null);

            // Resets timer when initialSeconds prop changes
            useEffect(() => {
                setSeconds(initialSeconds);
            }, [initialSeconds]);

            // Main timer logic
            useEffect(() => {
                if (isRunning && seconds > 0) {
                    timerIdRef.current = setInterval(() => {
                        setSeconds(prev => prev - 1);
                    }, 1000);
                } else if (seconds === 0 && isRunning) {
                    // Timer finished
                    clearInterval(timerIdRef.current);
                    onFinish(id, 'timer_finished');
                } else if (!isRunning) {
                    // Paused or reset
                    clearInterval(timerIdRef.current);
                }
                return () => clearInterval(timerIdRef.current);
            }, [isRunning, seconds, id, onFinish]);

            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;

            const displayTime = `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
            const buttonLabel = isRunning ? `Pause rest timer. Current time: ${displayTime}` : `Start rest timer. Current time: ${displayTime}`;

            return (
                <button
                    onClick={onToggle}
                    aria-label={buttonLabel}
                    className={`flex items-center justify-center p-3 rounded-xl font-bold transition-colors ${
                        isRunning ? 'bg-red-600 text-white shadow-lg' : seconds === 0 ? 'bg-green-600 text-white shadow-lg' : 'bg-gray-700 text-gray-100 hover:bg-gray-600'
                    }`}
                >
                    <svg className="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d={isRunning ? "M10 9l5 3-5 3V9z" : "M8 7v10M16 7v10"} />
                    </svg>
                    <span className="text-xl tracking-widest">{displayTime}</span>
                </button>
            );
        }

        // --- EXERCISE ITEM COMPONENT ---
        function ExerciseItem({ exercise, isEditing, onDelete, onUpdate, onNext, onSkip, previousBest, previousData }) {
            const [localExercise, setLocalExercise] = useState(exercise);
            const [isTimerRunning, setIsTimerRunning] = useState(false);
            const [showControls, setShowControls] = useState(false);
            const [isManualEdit, setIsManualEdit] = useState(false);

            useEffect(() => {
                setLocalExercise(exercise);
            }, [exercise]);
            
            // Recalculate Timer Duration: Use existing notes.time or default 60
            const timerDuration = parseInt(localExercise.time) > 0 ? parseInt(localExercise.time) : 60;
            
            const handleUpdate = (field, value) => {
                // If weight is updated, capture that locally immediately
                setLocalExercise(prev => ({ ...prev, [field]: value }));
                // Also update the parent state immediately
                onUpdate(exercise.id, field, value);
            };

            const handleToggleTimer = () => {
                triggerHaptic();
                // If timer has run out, clicking again resets it to the initial duration and starts it
                if (isTimerRunning === false && localExercise.time === '0') {
                    // Reset to initial (e.g., 60s)
                    handleUpdate('time', '60');
                }
                setIsTimerRunning(prev => !prev);
            };

            // Handles timer finish event
            const handleTimerFinish = (id, event) => {
                 if (event === 'timer_finished') {
                    handleUpdate('time', '0'); // Mark as 0 to show it's done
                    setIsTimerRunning(false);
                    playSound('skip'); // Use skip sound for timer finish
                    // Optionally alert user or trigger haptic
                 }
            };
            
            const handleNext = () => {
                 // Stop the timer before moving on
                if(isTimerRunning) setIsTimerRunning(false);
                // Ensure the final state (localExercise) is passed for completion status check
                onNext(localExercise); 
            };
            
            const handleDelete = () => {
                triggerHaptic();
                onDelete(exercise.id, exercise.name);
            };

            const handleManualSwitch = () => {
                triggerHaptic();
                setIsManualEdit(true);
            };
            
            // --- Component Parts ---
            
            // Render adjustable or static input based on context
            const WeightInput = () => {
                if (isEditing) {
                    if (isManualEdit) {
                        // Manual input mode (StaticInput for keyboard access)
                        return (
                            <div className="mb-4">
                                <label htmlFor={`w-${exercise.id}`} className="block text-sm font-bold text-gray-300 mb-1">Weight (Manual)</label>
                                <input 
                                    id={`w-${exercise.id}`} 
                                    type="text" 
                                    inputMode="decimal" 
                                    value={localExercise.weight} 
                                    onChange={(e) => handleUpdate('weight', e.target.value)}
                                    className="w-full p-4 text-xl border-2 border-red-500 rounded bg-gray-800 text-white"
                                    aria-label={`Manual weight entry for ${localExercise.name}`}
                                    placeholder="Enter Weight in LBS"
                                    onBlur={() => setIsManualEdit(false)} // Exit manual mode on blur
                                />
                            </div>
                        );
                    } else {
                        // Standard adjustable input mode (Swipe/Spin button)
                        return (
                            <AdjustableInput 
                                id={`w-${exercise.id}`} 
                                label="Weight" 
                                value={localExercise.weight} 
                                onChange={v => handleUpdate('weight', v)} 
                                step={2.5} 
                                unit="pounds" 
                                min={0} 
                                max={1000}
                            />
                        );
                    }
                }
                // Completed/Static view
                return (
                    <div className="text-lg">
                        <span className="font-bold text-gray-300">Weight:</span> {localExercise.weight || '--'} lbs
                    </div>
                );
            };

            const SetsRepsInput = ({ field, label, step, max }) => {
                if (isEditing) {
                    return (
                        <AdjustableInput 
                            id={`${field}-${exercise.id}`} 
                            label={label} 
                            value={localExercise[field]} 
                            onChange={v => handleUpdate(field, v)} 
                            step={step} 
                            unit="" 
                            min={1} 
                            max={50}
                        />
                    );
                }
                 return (
                    <div className="text-lg">
                        <span className="font-bold text-gray-300">{label}:</span> {localExercise[field] || '--'}
                    </div>
                );
            };

            // --- Main Render ---

            if (!isEditing && !showControls) {
                // Completed/Static View
                const isPR = localExercise.weight && localExercise.previousWeight && parseFloat(localExercise.weight) > parseFloat(localExercise.previousWeight);
                
                return (
                    <li 
                        tabIndex="0" 
                        // Combined ARIA Label for screen readers: Name, Sets, Reps, Weight, and PR status
                        aria-label={`Completed exercise: ${localExercise.name}. ${localExercise.sets} sets, ${localExercise.reps} reps, ${localExercise.weight} pounds. ${isPR ? 'New personal record achieved.' : ''}`}
                        onClick={() => setShowControls(true)} // Tap to reveal details/edit
                        className="bg-gray-800 p-4 rounded-xl shadow border border-gray-700 hover:shadow-lg transition-shadow active:scale-[.99] cursor-pointer"
                    >
                        <div className="flex justify-between items-center">
                            <h3 className="text-xl font-bold text-gray-100 flex items-center gap-2">
                                <Icons.Check size={20} className="text-green-400" /> {localExercise.name}
                            </h3>
                            <span className={`text-xs font-bold px-2 py-1 rounded ${isPR ? 'bg-yellow-800 text-yellow-200' : 'bg-green-800 text-green-200'}`}>
                                {isPR ? 'NEW PR' : 'DONE'}
                            </span>
                        </div>
                        <div className="flex justify-between mt-2 text-sm text-gray-400">
                             <div>{localExercise.sets} sets x {localExercise.reps} reps</div>
                             <div><span className="font-bold text-gray-200">{localExercise.weight}</span> lbs</div>
                        </div>
                    </li>
                );
            }
            
            // Editing/Active View
            return (
                <div className="bg-gray-800 p-6 rounded-xl shadow-2xl border-t-8 border-blue-500 space-y-6">
                    
                    {/* Header, Name, and Delete */}
                    <div className="flex justify-between items-center border-b border-gray-700 pb-3">
                        <h3 className="text-2xl font-extrabold text-blue-400" tabIndex="-1" ref={isEditing ? null : focusRef}>
                            {localExercise.name}
                        </h3>
                        {/* Only show delete button if not the active, currently working exercise */}
                        <button onClick={handleDelete} className="text-red-400 p-2 rounded-full hover:bg-gray-700 transition-colors" aria-label={`Delete exercise: ${localExercise.name}`}>
                            <Icons.Trash2 size={24} />
                        </button>
                    </div>
                    
                    {/* Contextual Recap (Only for the active exercise, provided via previousData prop) */}
                    {isEditing && previousData && (
                        <div className="bg-blue-900/50 p-3 rounded-lg border border-blue-700 text-sm text-blue-200" aria-live="polite">
                            <strong className="block mb-1">Last Session Recap:</strong>
                            <span className="block">Sets/Reps: {previousData.sets || '?'} x {previousData.reps || '?'}</span>
                            <span className="block">Max Weight: {previousData.weight || '?'} lbs</span>
                            {previousData.notes && <span className="block italic mt-1">Note: "{previousData.notes}"</span>}
                        </div>
                    )}

                    {/* SETS/REPS/WEIGHT GRID */}
                    <div className="grid grid-cols-2 gap-4">
                        <SetsRepsInput field="sets" label="Sets" step={1} max={50} />
                        <SetsRepsInput field="reps" label="Reps" step={1} max={50} />
                        <div className="col-span-2">
                            <WeightInput />
                            {/* Manual entry button */}
                            {isEditing && !isManualEdit && (
                                <button 
                                    onClick={handleManualSwitch} 
                                    className="w-full text-xs font-bold text-gray-500 hover:text-blue-400 mt-[-10px] py-1 transition-colors"
                                    aria-label="Switch to manual weight entry"
                                >
                                    Or, Manually Enter Weight
                                </button>
                            )}
                        </div>
                    </div>
                    
                    {/* NOTES & TIMER */}
                    <div className="space-y-4 pt-4 border-t border-gray-700">
                        {/* Notes Input */}
                        <div>
                            <label htmlFor={`notes-${exercise.id}`} className="block text-sm font-bold text-gray-300 mb-1">Notes</label>
                            <textarea 
                                id={`notes-${exercise.id}`} 
                                value={localExercise.notes} 
                                onChange={e => handleUpdate('notes', e.target.value)} 
                                className="w-full p-3 text-lg border border-gray-600 rounded bg-gray-800 text-gray-100" 
                                rows="2" 
                                aria-label={`Notes for ${localExercise.name}`}
                            />
                        </div>

                        {/* Timer Controls */}
                        <div className="bg-gray-700 p-4 rounded-lg">
                             <div className="flex justify-between items-center mb-2">
                                <h4 className="text-sm font-bold text-gray-300 uppercase">Rest Timer</h4>
                                {/* Timer Duration Input (Hidden if manual edit mode is active on weight) */}
                                {!isManualEdit && (
                                    <div className="w-1/3">
                                        <AdjustableInput 
                                            id={`time-set-${exercise.id}`} 
                                            label="Set Duration" 
                                            value={localExercise.time} 
                                            onChange={v => handleUpdate('time', v)} 
                                            step={15} 
                                            unit="sec" 
                                            min={0} 
                                            max={300}
                                        />
                                    </div>
                                )}
                            </div>
                            <Timer 
                                id={exercise.id} 
                                initialSeconds={timerDuration} 
                                onFinish={handleTimerFinish}
                                isRunning={isTimerRunning}
                                onToggle={handleToggleTimer}
                            />
                        </div>
                    </div>

                    {/* ACTION BUTTONS (Only for active/editing exercise) */}
                    {isEditing && (
                        <div className="flex flex-col gap-3 pt-4 border-t border-blue-700">
                            <button onClick={handleNext} className="w-full py-5 bg-blue-600 text-white font-bold text-xl rounded-lg shadow-lg hover:bg-blue-500 active:scale-[.99] transition-transform flex items-center justify-center gap-2" aria-label={`Complete ${localExercise.name} and move to next exercise`}>
                                <Icons.ArrowRight size={28} /> Save & Next Exercise
                            </button>
                            <button onClick={() => onSkip(localExercise)} className="w-full py-3 bg-gray-700 text-gray-100 font-bold rounded-lg hover:bg-gray-600 active:scale-[.99] transition-transform" aria-label={`Skip ${localExercise.name} for now`}>
                                Skip to End of Queue
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        // --- VITALS INPUT VIEW ---
        function VitalsView({ history, onSave }) {
            
            // Find the last recorded vitals entry to pre-fill
            const lastVitals = useMemo(() => {
                return history.slice().reverse().find(h => h.isVital);
            }, [history]);
            
            // Initial state based on last entry or defaults
            const [formData, setFormData] = useState({
                weight: lastVitals?.metrics?.weight || '',
                height: lastVitals?.metrics?.height || '',
                age: lastVitals?.metrics?.age || '',
                waist: lastVitals?.metrics?.waist || '',
                biceps: lastVitals?.metrics?.biceps || '',
                chest: lastVitals?.metrics?.chest || '',
                thigh: lastVitals?.metrics?.thigh || '',
            });
            
            const handleChange = (field, value) => setFormData(prev => ({ ...prev, [field]: value }));
            
            const handleSubmit = (e) => {
                e.preventDefault();
                triggerHaptic();
                
                // Get snapshots of height and age since these usually don't change
                const heightSnapshot = formData.height || lastVitals?.metrics?.height || '';
                const ageSnapshot = formData.age || lastVitals?.metrics?.age || '';
                
                // Construct the final metrics object
                const metrics = {
                    ...formData,
                    heightSnapshot: heightSnapshot,
                    ageSnapshot: ageSnapshot,
                    // Ensure weight and height are present for BMI calculation to be meaningful in the log
                    weight: formData.weight,
                    height: formData.height,
                    age: formData.age
                };
                
                onSave(metrics);
            };

            const { val: bmiVal, status: bmiStatus } = calculateBMI(formData.weight, formData.height);
            const { fox: mhrFox, tanaka: mhrTanaka } = calculateMHR(formData.age);

            return (
                <form onSubmit={handleSubmit} className="bg-gray-800 p-6 rounded-xl shadow-xl border-t-8 border-teal-500 space-y-8">
                    <h2 className="text-2xl font-bold text-teal-400 mb-4">Vitals Tracking</h2>
                    
                    {/* Section 1: Core Metrics (Weight, Height, Age) */}
                    <section className="bg-gray-900 p-4 rounded-lg border border-gray-700 space-y-4">
                        <h3 className="font-bold text-gray-300 uppercase text-lg border-b border-gray-700 pb-2">Core Vitals</h3>
                        
                        <div className="grid grid-cols-2 gap-4">
                            {/* Weight uses ADJUSTABLE INPUT for easy swipe logging */}
                            <AdjustableInput 
                                id="v-weight" 
                                label="Weight" 
                                value={formData.weight} 
                                onChange={v => handleChange('weight', v)} 
                                step={0.5} 
                                unit="pounds" 
                                min={0} 
                            />
                            {/* Height and Age use STATIC INPUT for initial, less frequent change */}
                            <StaticInput 
                                id="v-height" 
                                label="Height" 
                                value={formData.height} 
                                onChange={v => handleChange('height', v)} 
                                inputMode="numeric" 
                                unit="inches" 
                            />
                        </div>
                        <StaticInput 
                            id="v-age" 
                            label="Age" 
                            value={formData.age} 
                            onChange={v => handleChange('age', v)} 
                            inputMode="numeric" 
                            unit="years" 
                        />
                    </section>
                    
                    {/* Section 2: Calculated Metrics Display */}
                    <section className="bg-teal-900/50 p-4 rounded-lg border border-teal-700 space-y-3" aria-live="polite">
                        <h3 className="font-bold text-teal-300 uppercase text-lg border-b border-teal-700 pb-2">Calculated Health Data</h3>
                        
                        <div className="flex justify-between items-center p-2 bg-gray-700 rounded-lg shadow-sm">
                            <span className="font-bold text-gray-300">BMI (Body Mass Index):</span>
                            <span className={`text-xl font-black ${bmiStatus === 'Obese' ? 'text-red-400' : bmiStatus === 'Overweight' ? 'text-orange-400' : 'text-green-400'}`}>
                                {bmiVal} <span className="text-sm text-gray-400">({bmiStatus})</span>
                            </span>
                        </div>
                        
                        <div className="flex justify-between items-center p-2 bg-gray-700 rounded-lg shadow-sm">
                            <span className="font-bold text-gray-300">Max Heart Rate (MHR):</span>
                            <span className="text-xl font-black text-indigo-400">
                                {mhrFox}/{mhrTanaka} <span className="text-sm text-gray-400">bpm (Fox/Tanaka)</span>
                            </span>
                        </div>
                    </section>

                    {/* Section 3: Optional Measurements */}
                    <section className="bg-gray-900 p-4 rounded-lg border border-gray-700 space-y-4">
                        <h3 className="font-bold text-gray-300 uppercase text-lg border-b border-gray-700 pb-2">Body Measurements (Optional)</h3>
                        
                        <div className="grid grid-cols-2 gap-4">
                            <StaticInput id="v-waist" label="Waist" value={formData.waist} onChange={v => handleChange('waist', v)} inputMode="decimal" unit="inches" />
                            <StaticInput id="v-biceps" label="Biceps" value={formData.biceps} onChange={v => handleChange('biceps', v)} inputMode="decimal" unit="inches" />
                            <StaticInput id="v-chest" label="Chest" value={formData.chest} onChange={v => handleChange('chest', v)} inputMode="decimal" unit="inches" />
                            <StaticInput id="v-thigh" label="Thigh" value={formData.thigh} onChange={v => handleChange('thigh', v)} inputMode="decimal" unit="inches" />
                        </div>
                    </section>

                    <button type="submit" className="w-full py-4 bg-teal-600 text-white rounded-lg font-bold text-xl shadow flex items-center justify-center gap-2 hover:bg-teal-500">
                        <Icons.Check size={24} /> Log Vitals
                    </button>
                    
                    {/* REMOVED: Redundant Cancel Button */}
                </form>
            );
        }

        // --- STATIC INPUT COMPONENT (Dark Mode) ---
        function StaticInput({ id, label, value, onChange, unit="", inputMode="numeric" }) {
            
            const displayValue = value || '';
            
            // FIX: Round decimal values for clean ARIA announcement.
            const numericalValue = parseFloat(displayValue);
            const ariaValueNow = isNaN(numericalValue) ? 0 : numericalValue;
            
            // If inputMode is decimal, show one decimal place. Otherwise, show as integer.
            let formattedAriaValue = displayValue;
            if (displayValue !== '') {
                const decimals = inputMode === 'decimal' || unit.includes('%') || unit.toLowerCase().includes('per hour') ? 1 : 0;
                formattedAriaValue = numericalValue.toFixed(decimals).toString();
                if (decimals === 0 && formattedAriaValue.endsWith('.0')) {
                    formattedAriaValue = formattedAriaValue.slice(0, -2);
                }
            }

            let ariaValueText = `${formattedAriaValue}`;
            if (unit) ariaValueText += ` ${unit}`;

            return (
                <div className="mb-4">
                     <label htmlFor={id} className="block text-sm font-bold text-gray-300 mb-1 capitalize">{label}</label>
                    <input 
                        id={id} 
                        type="text" 
                        inputMode={inputMode} 
                        value={value} 
                        onChange={(e) => onChange(e.target.value)}
                        // Dark Mode Styles applied via CSS block and direct classes if needed
                        className="w-full p-4 text-xl border border-gray-600 rounded bg-gray-800 text-gray-100"
                        aria-label={label}
                        aria-valuenow={ariaValueNow} 
                        aria-valuetext={ariaValueText} 
                        placeholder={inputMode === 'numeric' ? '0' : '0.0'}
                    />
                </div>
            );
        }

        // --- ADJUSTABLE INPUT COMPONENT (Dark Mode) ---
        function AdjustableInput({ id, label, value, onChange, step, unit, min=0, max=9999 }) {
            const [isManual, setIsManual] = useState(false);
            const inputRef = useRef(null);
            const spinRef = useRef(null);

            const currentVal = value === '' ? min : parseFloat(value);
            
            // NOTE: displayValue is intentionally designed to be clean, which makes the unit critical.
            const isInteger = (step === 1 && unit === '' || unit === 'RPE');
            const displayValue = isInteger ? (value ? parseInt(value) : min) : (value || min);
            
            const decimalPlaces = step < 1 ? 1 : 0;
            const numericalValue = parseFloat(value);
            const ariaValueNow = isNaN(numericalValue) ? 0 : numericalValue;

            let formattedAriaValue = value;
            if (value !== '') {
                formattedAriaValue = numericalValue.toFixed(decimalPlaces).toString();
                if (decimalPlaces === 0 && formattedAriaValue.endsWith('.0')) {
                    formattedAriaValue = formattedAriaValue.slice(0, -2);
                }
            }

            let ariaValueText = `${formattedAriaValue}`;
            if (unit) ariaValueText += ` ${unit}`;


            const adjust = (direction) => {
                triggerHaptic();
                playSound(direction === 'up' ? 'success' : 'skip'); 
                
                const factor = step < 1 ? 100 : 1; 
                
                const cleanCurrentVal = Math.round(currentVal * factor);
                const cleanStep = Math.round(step * factor);

                let newVal;
                if (direction === 'up') newVal = (cleanCurrentVal + cleanStep) / factor;
                else newVal = (cleanCurrentVal - cleanStep) / factor;
                
                const formattedNewVal = newVal.toFixed(decimalPlaces);
                
                if (newVal < min) newVal = min;
                if (newVal > max) newVal = max;
                
                onChange(newVal.toString()); 
            };

            const handleKeyDown = (e) => {
                if (e.key === 'ArrowUp') { e.preventDefault(); adjust('up'); }
                if (e.key === 'ArrowDown') { e.preventDefault(); adjust('down'); }
            };

            useEffect(() => {
                if (isManual && inputRef.current) inputRef.current.focus();
                if (!isManual && spinRef.current) spinRef.current.focus();
            }, [isManual]);

            if (isManual) {
                return (
                    <div className="mb-4">
                         <label htmlFor={id} className="block text-sm font-bold text-gray-300 mb-1 capitalize" aria-hidden="true">{label}</label>
                        <div className="flex gap-2">
                            <input 
                                ref={inputRef} id={id} type="text" inputMode={step < 1 ? "decimal" : "numeric"}
                                value={value} onChange={(e) => onChange(e.target.value)}
                                onBlur={() => setIsManual(false)}
                                className="w-full p-4 text-xl border-2 border-blue-400 rounded bg-gray-800 text-gray-100"
                                aria-label={label} 
                            />
                             <button onClick={() => setIsManual(false)} className="bg-gray-700 text-gray-100 p-3 rounded font-bold text-sm hover:bg-gray-600">Done</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="mb-4">
                    <div className="block text-sm font-bold text-gray-300 mb-1 capitalize" aria-hidden="true">{label}</div>
                    
                    <div 
                        ref={spinRef} role="spinbutton" tabIndex="0"
                        aria-label={label} 
                        aria-valuenow={ariaValueNow} 
                        aria-valuetext={ariaValueText}
                        aria-valuemin={min} aria-valuemax={max} 
                        onKeyDown={handleKeyDown} onClick={() => setIsManual(true)}
                        // Dark Mode Style for button-like control
                        className="adjustable-input w-full p-4 text-xl border border-gray-600 rounded bg-gray-800 text-gray-100 flex justify-between items-center cursor-pointer active:bg-gray-700"
                    >
                        {/* Use gray-200 for high contrast display value */}
                        <span className="font-bold text-2xl text-gray-200">{displayValue} <span className="text-sm text-gray-400">{unit}</span></span>
                        <span aria-hidden="true" className="text-gray-400 text-sm font-medium uppercase">Swipe Up/Down</span>
                    </div>
                </div>
            );
        }

        // --- SPLASH SCREEN (SCHEDULE) COMPONENT (Dark Mode) ---
        function SplashScreen({ onGoToMenu, routine, history, currentSession, onBonus, onJumpToCardio, onJumpToWeights, onChangeRoutine, todaysETPFocus, manualETPFocus, changeETPFocus }) {
            
            useEffect(() => {
                const loader = document.getElementById('loading-screen');
                if(loader) loader.style.display = 'none';
            }, []);
            
            const { progress, allDone, completedCount, isStrengthDoneToday } = useMemo(() => {
                const todayStr = new Date().toLocaleDateString();
                const todayEntries = history.filter(h => new Date(h.date).toLocaleDateString() === todayStr);
                
                const isWeightsSaved = todayEntries.some(h => !h.isCardio && !h.isBonus && !h.isVital);
                const isWeightsInProgress = !isWeightsSaved && (currentSession && currentSession.length > 0);

                const getCardioStatus = (activityNames) => 
                    todayEntries.some(h => h.isCardio && activityNames.includes(h.activity)) ? 'done' : 'todo';
                    
                const p = {
                    hiit: getCardioStatus(['HIIT Run']),
                    cycle: getCardioStatus(['Indoor Cycle']),
                    endurance: getCardioStatus(['Endurance Run', 'Tempo Run', 'Progressive Run', 'ETP Run']),
                    incline: getCardioStatus(['Incline Walk']),
                    weights: isWeightsSaved ? 'done' : (isWeightsInProgress ? 'progress' : 'todo')
                };

                const statuses = [p.hiit, p.cycle, p.endurance, p.incline, p.weights];
                const count = statuses.filter(s => s === 'done').length;

                return { progress: p, allDone: count === statuses.length, completedCount: count, isStrengthDoneToday: isWeightsSaved };
            }, [history, currentSession]); 

            const getButtonText = () => {
                if (allDone) return "I'm feeling extra good today! ðŸŽ‰";
                if (completedCount === 0) return "Let's get this day going";
                const percentage = Math.round((completedCount / 5) * 100);
                if (percentage < 40) return `Off to a good start! (${percentage}% Done)`;
                if (percentage < 60) return `Building momentum... (${percentage}% Done)`;
                if (percentage < 80) return `Over the hump! (${percentage}% Done)`;
                return `Home stretch! (${percentage}% Done)`;
            };

            const StatusIcon = ({ status }) => {
                const text = status === 'done' ? 'Completed' : (status === 'progress' ? 'In Progress' : 'Not Started');
                const color = status === 'done' ? 'text-green-400' : (status === 'progress' ? 'text-orange-400' : 'text-gray-600');
                
                return <span className={`text-sm font-bold ${color}`} aria-label={text}>{text}</span>;
            };
            
            const getButtonAriaLabel = (label, status) => {
                let baseLabel;
                
                if (label.includes('Focus')) {
                    baseLabel = `Log Today's ${label}`;
                } else {
                    if (['HIIT Run', 'Indoor Cycle', 'Incline Walk'].includes(label)) {
                        baseLabel = `Log ${label}`;
                    } else if (label.startsWith('Rest Day')) {
                        baseLabel = label;
                    } else {
                        baseLabel = label;
                    }
                }

                if (status === 'done') {
                    return `${label}, Completed`;
                }
                if (status === 'progress') {
                    return `${baseLabel}, In Progress. Tap to continue.`;
                }
                if (status === 'todo') { 
                    return `${baseLabel}, Not Completed`;
                }
                
                return baseLabel;
            };
            
            const InteractiveRow = ({ label, status, onClick }) => {
                
                let displayLabel = label;
                let ariaLabel = getButtonAriaLabel(label, status);

                if (label.includes('Focus') || label.includes('Rest Day')) {
                } else {
                    displayLabel = `Log ${label}`;
                    ariaLabel = `Log ${label}`;
                }
                
                return (
                    <button 
                        onClick={() => { triggerHaptic(); onClick(); }} 
                        className="w-full flex items-center justify-between p-2 rounded hover:bg-slate-700 text-left active:bg-slate-600 transition-colors"
                        aria-label={ariaLabel} 
                    >
                        <span className="flex items-center gap-2 text-base text-gray-100">
                            {displayLabel} 
                        </span>
                        <StatusIcon status={status} />
                    </button>
                );
            };

            // SAFE CLICK HANDLER
            const handleMainClick = () => {
                triggerHaptic();
                playSound('success');
                try {
                    if (allDone) {
                        onBonus();
                    } else {
                        onGoToMenu();
                    }
                } catch (e) {
                    console.error("Navigation safety catch", e);
                    onGoToMenu(); // Fallback
                }
            };

            return (
                <div className="fixed inset-0 bg-gray-900 text-white z-50 flex flex-col p-6 overflow-y-auto">
                    {/* TOP LEFT: SKIP TO MAIN MENU */}
                    <div className="flex justify-between w-full mb-6">
                        <button 
                            onClick={() => { triggerHaptic(); onGoToMenu(); }}
                            className="p-3 bg-gray-700 rounded text-gray-100 hover:bg-gray-600 flex items-center gap-2 font-bold"
                            aria-label="Skip to Main Menu"
                        >
                            <Icons.SkipForward size={20} /> Skip to Main Menu
                        </button>
                    </div>

                    <div className="flex-1 flex flex-col justify-center space-y-8">
                        <div>
                            <h1 className="text-4xl font-bold mb-2 text-gray-100">Welcome!</h1>
                            <p className="text-slate-400 text-xl font-medium" aria-label={`Today's Date is ${formatDate(new Date())}`}>
                                Today: {formatDate(new Date())}
                            </p>
                            
                            {/* DYNAMIC FOCUS HEADERS & DROPDOWNS - COMBINED SECTION */}
                            <div className="space-y-4 mt-4 p-4 bg-gray-800 rounded-xl border border-gray-700">
                                
                                {/* 1. STRENGTH FOCUS SECTION */}
                                <div className="space-y-2">
                                    <div className="flex items-center justify-between gap-3">
                                        <p className="text-blue-400 text-2xl font-extrabold uppercase tracking-wide" aria-live="polite">
                                            Strength Focus: {routine}
                                        </p>
                                        
                                        {/* STRENGTH DROPDOWN (Direct Switch) */}
                                        {isStrengthDoneToday ? (
                                            <span 
                                                className="bg-green-900 text-green-200 border border-green-700 rounded px-3 py-1 text-sm font-bold inline-block"
                                                aria-live="polite"
                                            >
                                                 Logged
                                            </span>
                                        ) : (
                                            <>
                                                <label htmlFor="change-focus" className="sr-only">Switch Strength Focus Selector</label>
                                                <select 
                                                    id="change-focus"
                                                    onChange={(e) => { triggerHaptic(); onChangeRoutine(e.target.value); }}
                                                    value={routine}
                                                    className="bg-blue-600 hover:bg-blue-500 active:bg-blue-700 text-white border border-blue-800 rounded-lg px-4 py-2 text-sm font-bold inline-block w-auto cursor-pointer appearance-none"
                                                    aria-label="Switch Strength Focus"
                                                >
                                                    <option value="Upper Body">Upper Body</option>
                                                    <option value="Lower Body">Lower Body</option>
                                                    <option value="Core">Core</option>
                                                </select>
                                            </>
                                        )}
                                    </div>
                                    
                                </div>
                                
                                {/* 2. ETP FOCUS SECTION */}
                                <div className="space-y-2 pt-4 border-t border-gray-700">
                                    <div className="flex items-center justify-between gap-3">
                                        <p className="text-yellow-400 text-xl font-extrabold uppercase tracking-wide" aria-live="polite">
                                            ETP Run Focus: {todaysETPFocus}
                                        </p>
                                        
                                        {/* ETP DROPDOWN (Direct Switch) */}
                                        <div className="mt-2">
                                            <label htmlFor="change-etp-focus" className="sr-only">Switch ETP Run Focus Selector</label>
                                            <select 
                                                id="change-etp-focus"
                                                onChange={(e) => { triggerHaptic(); changeETPFocus(e.target.value); }}
                                                value={manualETPFocus || 'Scheduled'}
                                                className="bg-yellow-600 hover:bg-yellow-500 active:bg-yellow-700 text-white border border-yellow-800 rounded-lg px-4 py-2 text-sm font-bold inline-block w-auto cursor-pointer appearance-none"
                                                    aria-label="Switch ETP Run Focus"
                                            >
                                                {/* Changed 'Scheduled' option to show today's auto-scheduled focus */}
                                                <option value="Scheduled">Scheduled ({getETPRunForDay(new Date(), null)})</option>
                                                <option value="Endurance Run">Endurance Run</option>
                                                <option value="Tempo Run">Tempo Run</option>
                                                <option value="Progressive Run">Progressive Run</option>
                                                <option value="Rest Day / N/A">Rest Day / N/A</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {/* End DYNAMIC FOCUS HEADERS & DROPDOWNS */}

                        </div>

                        <div className="space-y-6">
                            <div className="bg-gray-800 p-5 rounded-xl border border-gray-700">
                                {/* REQUESTED HEADER: Morning Session */}
                                <h2 className="text-slate-400 text-sm font-bold uppercase tracking-wider mb-4">Morning Session</h2>
                                <div className="space-y-3 text-lg font-medium">
                                    <InteractiveRow label="HIIT Run" status={progress.hiit} onClick={() => onJumpToCardio('HIIT Run')} />
                                    <InteractiveRow label="Indoor Cycle" status={progress.cycle} onClick={() => onJumpToCardio('Indoor Cycle')} />
                                </div>
                            </div>

                            <div className="bg-gray-800 p-5 rounded-xl border border-gray-700">
                                {/* REQUESTED HEADER: Afternoon Session */}
                                <h2 className="text-slate-400 text-sm font-bold uppercase tracking-wider mb-4">Afternoon Session</h2>
                                <div className="space-y-3 font-medium">
                                    {/* STRENGTH FOCUS ROW */}
                                    <InteractiveRow label={`${routine} Focus`} status={progress.weights} onClick={() => onJumpToWeights(routine)} />
                                    
                                    {/* ETP RUN ROW - Use todaysETPFocus directly as label */}
                                    <InteractiveRow 
                                        label={todaysETPFocus} // Use focus name directly (e.g., "Tempo Run" or "Rest Day / N/A")
                                        status={progress.endurance} 
                                        onClick={() => { 
                                            // Only jump to cardio if it's an actual run type
                                            if (todaysETPFocus.includes('Run')) {
                                                onJumpToCardio(todaysETPFocus); 
                                            } else {
                                                onGoToMenu(); // Navigate to main menu as there's no log action
                                            }
                                        }} 
                                    />
                                    <InteractiveRow label="Incline Walk" status={progress.incline} onClick={() => onJumpToCardio('Incline Walk')} />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="mt-6 space-y-3">
                         <button 
                            onClick={handleMainClick}
                            className={`w-full text-white font-bold text-xl py-6 rounded-xl shadow-lg active:scale-95 transition-transform ${allDone ? 'bg-green-600 hover:bg-green-500' : 'bg-blue-600 hover:bg-blue-500'}`}
                        >
                            {getButtonText()}
                        </button>
                    </div>
                </div>
            );
        }

        // --- LUCKY GAME VIEW (Dark Mode) ---
        function LuckyView({ onBack, onSave, availableExercises, history }) {
            const [exercise, setExercise] = useState(null);
            const [sets, setSets] = useState('');
            const [reps, setReps] = useState('');
            const [weight, setWeight] = useState('');
            const mysteryRef = useRef(null);

            const pickRandom = () => {
                const randomName = availableExercises[Math.floor(Math.random() * availableExercises.length)];
                
                let lastData = { sets: '', reps: '', weight: '' };
                for (let i = history.length - 1; i >= 0; i--) {
                    if (history[i].isCardio) continue;
                    const pastExercise = history[i].exercises.find(e => e.name.toLowerCase() === randomName.toLowerCase());
                    if (pastExercise) { lastData = { ...pastExercise }; break; }
                }

                setExercise(randomName);
                setSets(lastData.sets || '3');
                setReps(lastData.reps || '10');
                setWeight(lastData.weight || '');
                
                setTimeout(() => {
                    if(mysteryRef.current) mysteryRef.current.focus();
                }, 100);
            };

            useEffect(() => {
                pickRandom();
            }, []);

            const handleSpin = (isExit) => {
                triggerHaptic();
                playSound('success');
                // Save data
                onSave({ type: 'Strength', name: exercise, sets, reps, weight });
                
                if (isExit) {
                    onBack();
                } else {
                    pickRandom(); // Re-roll
                }
            };

            if (!exercise) return <div className="p-8 text-center font-bold text-gray-400">Spinning...</div>;

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center mb-4">
                        <button onClick={onBack} className="text-gray-100 font-bold flex items-center gap-1 p-2 bg-gray-700 rounded hover:bg-gray-600">
                            <Icons.ArrowLeft size={20} /> Back
                        </button>
                        <h2 className="text-2xl font-bold text-purple-400">Bonus Workout</h2>
                    </div>

                    <div className="bg-purple-900 text-white p-6 rounded-lg shadow-lg text-center border-4 border-purple-700">
                        <h2 ref={mysteryRef} tabIndex="-1" className="text-2xl font-extrabold uppercase mb-1 focus:outline-none">Mystery Exercise</h2>
                        <p className="text-3xl font-black text-yellow-300">{exercise}</p>
                    </div>

                    <div className="bg-gray-800 p-6 rounded-lg shadow-xl border-t-8 border-purple-600 space-y-6">
                        <div className="grid grid-cols-2 gap-4">
                            <div><AdjustableInput id="l-sets" label="Sets" value={sets} onChange={setSets} step={1} unit="" /></div>
                            <div><AdjustableInput id="l-reps" label="Reps" value={reps} onChange={setReps} step={1} unit="" /></div>
                            <div className="col-span-2"><AdjustableInput id="l-weight" label="Weight" value={weight} onChange={setWeight} step={1} unit="pounds" /></div>
                        </div>

                        <div className="flex flex-col gap-3 pt-2">
                            <button onClick={() => handleSpin(false)} className="w-full py-5 bg-purple-600 text-white font-bold text-xl rounded-lg shadow-lg hover:bg-purple-500 border-b-4 border-purple-800 active:border-b-0 active:mt-1">
                                ðŸŽ² Spin Again (Save & Next)
                            </button>
                            <button onClick={() => handleSpin(true)} className="w-full py-4 bg-gray-700 text-gray-100 font-bold text-lg rounded-lg hover:bg-gray-600">
                                ðŸ Cash Out (Save & Exit)
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- NEW ETP MENU VIEW (Dark Mode) ---
        function ETPMenuView({ onBack, onSelect }) {
            return (
                <div className="space-y-6">
                    <div className="flex items-center gap-2 mb-4">
                        <button onClick={onBack} className="text-gray-100 font-bold flex items-center gap-1 p-2 bg-gray-700 rounded hover:bg-gray-600">
                            <Icons.ArrowLeft size={20} /> Back to Menu
                        </button>
                        <h2 className="text-2xl font-bold text-blue-400">ETP Run Type</h2>
                    </div>
                    
                    <div className="space-y-4">
                        <button onClick={() => { triggerHaptic(); onSelect('Endurance Run'); }} className="w-full p-8 bg-blue-700 text-white rounded-xl shadow-lg font-bold text-2xl flex flex-col items-start active:scale-[.99] transition-transform hover:bg-blue-600">
                            <span className="flex items-center justify-between w-full">Endurance Run <Icons.ArrowRight size={28} /></span>
                            <span className="text-sm font-medium text-blue-300 mt-1">Memo: Saturday, Sunday, and Monday</span>
                        </button>
                        <button onClick={() => { triggerHaptic(); onSelect('Tempo Run'); }} className="w-full p-8 bg-indigo-700 text-white rounded-xl shadow-lg font-bold text-2xl flex flex-col items-start active:scale-[.99] transition-transform hover:bg-indigo-600">
                            <span className="flex items-center justify-between w-full">Tempo Run <Icons.ArrowRight size={28} /></span>
                            <span className="text-sm font-medium text-indigo-300 mt-1">Memo: Wednesday and Friday</span>
                        </button>
                        <button onClick={() => { triggerHaptic(); onSelect('Progressive Run'); }} className="w-full p-8 bg-purple-700 text-white rounded-xl shadow-lg font-bold text-2xl flex flex-col items-start active:scale-[.99] transition-transform hover:bg-purple-600">
                            <span className="flex items-center justify-between w-full">Progressive Run <Icons.ArrowRight size={28} /></span>
                            <span className="text-sm font-medium text-purple-300 mt-1">Memo: Tuesday and Thursday</span>
                        </button>
                    </div>
                </div>
            );
        }

        // --- ANALYSIS RESULTS VIEW (NEW DEDICATED PAGE) ---
        function AnalysisResultsView({ analysisData, onBack }) {
            
            // --- Component Rendering Helpers ---
            const PRList = ({ prs }) => {
                const exercises = Object.keys(prs);
                if (exercises.length === 0) return <p className="text-gray-500 italic ml-4">No strength data available to calculate PRs.</p>;

                return (
                    <ul className="space-y-1 list-none p-0 ml-4" role="list">
                        {exercises.map(name => (
                            <li key={name} className="p-2 border-b border-gray-700 focus:outline-none focus:ring-2 focus:ring-yellow-500 rounded-md" tabIndex="0" aria-label={`Personal record for ${name} is ${prs[name].weight} pounds, achieved on ${formatReportDate(prs[name].date)}`}>
                                <span className="font-bold text-yellow-500">{name}:</span> {prs[name].weight} lbs ({formatReportDate(prs[name].date)})
                            </li>
                        ))}
                    </ul>
                );
            };

            const TonnageTrend = ({ trend }) => {
                if (trend.length < 2) return <p className="text-gray-500 italic ml-4">Need at least two weeks of strength data to show trends.</p>;
                
                const latest = trend[trend.length - 1];
                const heaviest = trend.reduce((max, current) => current.tonnage > max.tonnage ? current : max, trend[0]);

                return (
                    <ul className="space-y-2 ml-4 list-none p-0" role="list">
                        <li tabIndex="0" className="p-1 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md" aria-label={`Total Logged Weeks: ${trend.length}`}>
                            <span className="font-bold text-gray-300">Total Logged Weeks: </span><span className="text-lg text-blue-400">{trend.length}</span>
                        </li>
                        <li tabIndex="0" className="p-1 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md" aria-label={`Heaviest Week: ${heaviest.tonnage} thousand pounds of tonnage in week ${heaviest.week}`}>
                            <span className="text-base text-gray-300">Heaviest Week: </span><span className="font-extrabold text-green-400">{heaviest.tonnage}</span> (Thousand lbs Tonnage) in {heaviest.week}
                        </li>
                        <li tabIndex="0" className="p-1 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md" aria-label={`Latest Week, ${latest.week} tonnage is ${latest.tonnage} thousand pounds`}>
                            <span className="text-base text-gray-300">Latest Week ({latest.week}): </span><span className="font-extrabold text-blue-400">{latest.tonnage}</span> (Thousand lbs Tonnage)
                        </li>
                        <li className="text-xs text-gray-500 italic mt-3 p-1" tabIndex="0">Tonnage is calculated as (Weight x Sets x Reps) and reported in thousands of pounds per week.</li>
                    </ul>
                );
            };

            const VitalsSummary = ({ vitals }) => {
                if (!vitals) return <p className="text-gray-500 italic ml-4">Need Vitals data logged at least twice to show trends.</p>;

                const changeText = vitals.weightChange === '0.0' ? 'Weight remained stable.' : `You have ${vitals.weightDirection} ${vitals.weightChange} lbs!`;
                
                return (
                    <ul className="space-y-2 ml-4 list-none p-0" role="list">
                         <li tabIndex="0" className="p-1 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md" aria-label={`Tracking period from ${vitals.startDate} to ${vitals.endDate}`}>
                            <span className="font-bold text-gray-300">Tracking Period: </span><span className="text-lg text-blue-400">{vitals.startDate} to {vitals.endDate}</span>
                        </li>
                        <li tabIndex="0" className="p-1 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md" aria-label={`Weight change: ${changeText}`}>
                            <span className="text-lg font-extrabold text-red-400">{changeText}</span>
                        </li>
                        <li tabIndex="0" className="p-1 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md" aria-label={`Start Weight was ${vitals.startWeight} pounds`}>
                            <span className="text-base text-gray-300">Start Weight:</span> {vitals.startWeight} lbs
                        </li>
                        <li tabIndex="0" className="p-1 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md" aria-label={`End Weight is ${vitals.endWeight} pounds`}>
                            <span className="text-base text-gray-300">End Weight:</span> {vitals.endWeight} lbs
                        </li>
                        {vitals.bicepsChange !== '0.0' && (
                            <li tabIndex="0" className="p-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md" aria-label={`Bicep circumference changed by ${vitals.bicepsChange} inches`}>
                                <span className="text-sm text-gray-300">Bicep Change:</span> {vitals.bicepsChange} inches
                            </li>
                        )}
                    </ul>
                );
            };
            
            if (!analysisData) {
                // This state should ideally not be reached if navigation is done correctly
                return <div className="p-6 text-center text-red-400">Error: No analysis data found.</div>;
            }

            return (
                <div className="space-y-6">
                    <div className="bg-gray-800 p-4 rounded-lg shadow text-center">
                        <h2 className="font-extrabold text-2xl text-yellow-400 uppercase">Analysis Results</h2>
                        <p className="text-gray-400">Review your lifetime performance metrics.</p>
                    </div>
                    
                    <div className="bg-gray-800 p-6 rounded-lg shadow-xl border-t-8 border-yellow-600 space-y-8">
                        
                        <section>
                            <h3 className="text-xl font-extrabold text-blue-400 border-b border-gray-700 pb-1 mb-3">Personal Records (Max Weight)</h3>
                            <PRList prs={analysisData.prs} />
                        </section>

                        <section>
                            <h3 className="text-xl font-extrabold text-blue-400 border-b border-gray-700 pb-1 mb-3">Tonnage Trend (Weekly Volume)</h3>
                            <TonnageTrend trend={analysisData.tonnageTrend} />
                        </section>

                        <section>
                            <h3 className="text-xl font-extrabold text-blue-400 border-b border-gray-700 pb-1 mb-3">Vitals Change (Start to Finish)</h3>
                            <VitalsSummary vitals={analysisData.vitalsTrend} />
                        </section>

                        <button onClick={onBack} className="w-full py-4 bg-gray-700 text-gray-100 font-bold rounded-lg hover:bg-gray-600 flex items-center justify-center gap-2 mt-6">
                            <Icons.ArrowLeft size={20} /> Back to Hall of Fame
                        </button>
                    </div>
                </div>
            );
        }

        // --- HALL OF FAME VIEW (UPDATED TO BE JUST THE TRIGGER) ---
        function HallOfFameView({ history, onResults }) {
            const [isGenerating, setIsGenerating] = useState(false);
            
            // Helper function definitions (kept here but called via runAnalysis)
            const findPersonalRecords = (history) => {
                const prs = {};
                history.forEach(entry => {
                    if (entry.isCardio || entry.isVital || !entry.exercises) return;
                    entry.exercises.forEach(ex => {
                        const weight = parseFloat(ex.weight);
                        if (isNaN(weight) || weight <= 0) return;
                        const name = ex.name.toUpperCase();
                        if (!prs[name] || weight > prs[name].weight) {
                            prs[name] = { weight: weight, date: new Date(entry.date).toLocaleDateString() };
                        }
                    });
                });
                return prs;
            };

            const calculateTonnageTrend = (history) => {
                const tonnageByWeek = {};
                history.forEach(entry => {
                    if (entry.isCardio || entry.isVital || !entry.exercises) return;
                    const date = new Date(entry.date);
                    if (!date.getDayOfYear) {
                         Date.prototype.getDayOfYear = function() {
                            const start = new Date(this.getFullYear(), 0, 0);
                            const diff = (this - start) + ((start.getTimezoneOffset() - this.getTimezoneOffset()) * 60 * 1000);
                            const oneDay = 1000 * 60 * 60 * 24;
                            return Math.floor(diff / oneDay);
                        };
                    }
                    const week = Math.ceil((date.getDayOfYear() + 1) / 7);
                    const weekKey = `${date.getFullYear()}-W${String(week).padStart(2, '0')}`;
                    
                    let sessionVolume = 0;
                    entry.exercises.forEach(ex => {
                        const weight = parseFloat(ex.weight) || 0;
                        const sets = parseInt(ex.sets) || 0;
                        const reps = parseInt(ex.reps) || 0;
                        sessionVolume += weight * sets * reps;
                    });
                    
                    if (sessionVolume > 0) {
                        tonnageByWeek[weekKey] = (tonnageByWeek[weekKey] || 0) + sessionVolume;
                    }
                });
                return Object.keys(tonnageByWeek).sort().map(week => ({
                    week: week,
                    tonnage: Math.round(tonnageByWeek[week] / 1000) 
                }));
            };

            const analyzeVitalsTrend = (history) => {
                const vitalsLogs = history.filter(h => h.isVital).sort((a, b) => new Date(a.date) - new Date(b.date));
                if (vitalsLogs.length < 2) return null;

                const first = vitalsLogs[0].metrics;
                const last = vitalsLogs[vitalsLogs.length - 1].metrics;

                const startWeight = parseFloat(first.weight) || 0;
                const endWeight = parseFloat(last.weight) || 0;
                const change = endWeight - startWeight;
                const direction = change > 0 ? 'gained' : (change < 0 ? 'lost' : 'no change');

                const startBiceps = parseFloat(first.biceps) || 0;
                const endBiceps = parseFloat(last.biceps) || 0;
                const bicepsChange = endBiceps - startBiceps;
                
                return {
                    startDate: formatReportDate(vitalsLogs[0].date),
                    endDate: formatReportDate(vitalsLogs[vitalsLogs.length - 1].date),
                    startWeight: startWeight.toFixed(1),
                    endWeight: endWeight.toFixed(1),
                    weightChange: Math.abs(change).toFixed(1),
                    weightDirection: direction,
                    bicepsChange: bicepsChange.toFixed(1)
                };
            };
            
            // Failsafe for Date prototype if not present
            Date.prototype.getDayOfYear = Date.prototype.getDayOfYear || function() {
                const start = new Date(this.getFullYear(), 0, 0);
                const diff = (this - start) + ((start.getTimezoneOffset() - this.getTimezoneOffset()) * 60 * 1000);
                const oneDay = 1000 * 60 * 60 * 24;
                return Math.floor(diff / oneDay);
            };

            const runAnalysis = () => {
                triggerHaptic();
                setIsGenerating(true);
                
                // Heavy computation runs outside of render
                setTimeout(() => {
                    const prs = findPersonalRecords(history);
                    const tonnage = calculateTonnageTrend(history);
                    const vitals = analyzeVitalsTrend(history);

                    const analysisData = {
                        prs: prs,
                        tonnageTrend: tonnage,
                        vitalsTrend: vitals
                    };
                    
                    setIsGenerating(false);
                    // Pass results to parent component to switch view
                    onResults(analysisData);
                }, 300); // Small delay to simulate heavy work
            };

            return (
                <div className="space-y-6">
                    <div className="bg-gray-800 p-4 rounded-lg shadow text-center">
                        <h2 className="font-extrabold text-2xl text-yellow-400 uppercase">Hall of Fame</h2>
                        <p className="text-gray-400">Generate your comprehensive lifetime metrics report.</p>
                    </div>
                    
                    <div className="bg-gray-800 p-6 rounded-lg shadow-xl border-t-8 border-yellow-600 space-y-6">
                        
                        <p className="text-gray-300">The full analysis includes Personal Records, Weekly Tonnage Trends, and Vitals change comparisons. Press 'Run Analysis' to process your complete workout history.</p>

                        <button 
                            onClick={runAnalysis} 
                            className={`w-full py-6 rounded-xl font-bold text-2xl shadow-lg flex items-center justify-center gap-3 transition-colors ${isGenerating ? 'bg-gray-600 cursor-not-allowed text-gray-400' : 'bg-yellow-600 hover:bg-yellow-500 text-gray-900'}`}
                            disabled={isGenerating}
                            aria-busy={isGenerating}
                            aria-label={isGenerating ? "Running analysis, please wait" : "Run Full Hall of Fame Analysis"}
                        >
                            {isGenerating ? (
                                <>
                                    <div className="spinner w-5 h-5 border-gray-100" aria-hidden="true"></div> 
                                    Analyzing Data...
                                </>
                            ) : (
                                <>
                                    <span aria-hidden="true">ðŸ†</span> Run Full Analysis
                                </>
                            )}
                        </button>
                        
                        <div className="text-center mt-6">
                            <p className="text-xs text-gray-500">Analysis results will appear on a new page once generated.</p>
                        </div>
                    </div>
                </div>
            );
        }

        // --- Cardio Form (Unifed UI with Headers - Dark Mode) ---
        function CardioForm({ history, onSave, onCancel, initialActivity }) {
            const [activity, setActivity] = useState(initialActivity || '');
            const [showEtpMenu, setShowEtpMenu] = useState(false);
            
            const [formData, setFormData] = useState({ 
                duration: '20', 
                speedEasy: '', speedMod: '', speedHard: '', speedAllOut: '', 
                intensity: '', avgSpeed: '', minIncline: '', maxIncline: '', 
                notes: '', effort: '5', isGuided: false,
                warmupDur: '10', warmupSpd: '',
                tempoDur: '20', tempoSpd: '',
                cooldownDur: '10', cooldownSpd: '',
                inclinePct: '', avgHR: '', maxHR: '',
                progBaseDur: '10', progBaseSpd: '',
                progBuildDur: '10', progBuildSpd: '',
                progFinishDur: '10', progFinishSpd: ''
            });
            const durationRef = useRef(null);

            // Derived Calculation for Tempo Run
            const tempoStats = useMemo(() => {
                if (activity !== 'Tempo Run') return null;
                const wD = parseFloat(formData.warmupDur) || 0;
                const tD = parseFloat(formData.tempoDur) || 0;
                const cD = parseFloat(formData.cooldownDur) || 0;
                const totalDur = wD + tD + cD;
                const wS = parseFloat(formData.warmupSpd) || 0;
                const tS = parseFloat(formData.tempoSpd) || 0;
                const cS = parseFloat(formData.cooldownSpd) || 0;
                let totalDist = 0;
                if (totalDur > 0) {
                    totalDist = (wD/60 * wS) + (tD/60 * tS) + (cD/60 * cS);
                }
                const avgSpd = totalDur > 0 ? (totalDist / (totalDur/60)).toFixed(1) : 0;
                return { totalDur, avgSpd };
            }, [activity, formData.warmupDur, formData.tempoDur, formData.cooldownDur, formData.warmupSpd, formData.tempoSpd, formData.cooldownSpd]);

            // Derived Calculation for Progressive Run
            const progStats = useMemo(() => {
                if (activity !== 'Progressive Run') return null;
                const bD = parseFloat(formData.progBaseDur) || 0;
                const buD = parseFloat(formData.progBuildDur) || 0;
                const fD = parseFloat(formData.progFinishDur) || 0;
                const totalDur = bD + buD + fD;
                const bS = parseFloat(formData.progBaseSpd) || 0;
                const buS = parseFloat(formData.progBuildSpd) || 0;
                const fS = parseFloat(formData.progFinishSpd) || 0;
                let totalDist = 0;
                if (totalDur > 0) {
                    totalDist = (bD/60 * bS) + (buD/60 * buS) + (fD/60 * fS);
                }
                const avgSpd = totalDur > 0 ? (totalDist / (totalDur/60)).toFixed(1) : 0;
                return { totalDur, avgSpd };
            }, [activity, formData.progBaseDur, formData.progBuildDur, formData.progFinishDur, formData.progBaseSpd, formData.progBuildSpd, formData.progFinishSpd]);


            // QUICK LOG BUTTON LOGIC
            const lastSession = useMemo(() => {
                if (!activity) return null;
                return history.slice().reverse().find(h => h.isCardio && h.activity === activity);
            }, [activity, history]);

            const handleQuickLog = () => {
                 if (!lastSession || !lastSession.metrics) return;
                 const payload = { ...lastSession.metrics, notes: '', effort: '5' };
                 triggerHaptic();
                 playSound('success');
                 onSave(activity, payload);
            };

            useEffect(() => {
                if (activity) {
                    if (lastSession && lastSession.metrics) {
                        setFormData(prev => ({ ...prev, ...lastSession.metrics, notes: '', effort: '5' }));
                    } else {
                        setFormData(prev => ({ ...prev, duration: '20', notes: '', effort: '5', isGuided: false }));
                    }
                    setTimeout(() => durationRef.current?.focus(), 100);
                }
            }, [activity, lastSession]);

            const handleChange = (field, value) => setFormData(prev => ({ ...prev, [field]: value }));
            const handleSubmit = (e) => { 
                e.preventDefault(); 
                if (!activity) return; 
                triggerHaptic(); 
                playSound('success'); 
                
                let finalData = { ...formData };
                if (activity === 'Tempo Run' && tempoStats) {
                    finalData.duration = tempoStats.totalDur.toString();
                    finalData.avgSpeed = tempoStats.avgSpd.toString();
                }
                if (activity === 'Progressive Run' && progStats) {
                    finalData.duration = progStats.totalDur.toString();
                    finalData.avgSpeed = progStats.avgSpd.toString();
                }
                
                onSave(activity, finalData); 
            };

            if (showEtpMenu) {
                return <ETPMenuView onBack={() => { setActivity(''); setShowEtpMenu(false); }} onSelect={(act) => { setActivity(act); setShowEtpMenu(false); }} />;
            }

            if (!activity) {
                // Cardio Selection UI
                return (
                    <div className="bg-gray-800 p-6 rounded-lg shadow-lg border border-blue-900">
                        <div className="text-center mb-6">
                            <h2 className="text-2xl font-bold text-blue-400 mb-1" tabIndex="-1">Cardio Selection</h2>
                        </div>
                        <div className="grid grid-cols-1 gap-4">
                            {['HIIT Run', 'Indoor Cycle', 'ETP Run', 'Incline Walk'].map(type => (
                                <button 
                                    key={type} 
                                    onClick={() => { 
                                        triggerHaptic(); 
                                        if (type === 'ETP Run') {
                                            setShowEtpMenu(true);
                                        } else {
                                            setActivity(type); 
                                        }
                                    }} 
                                    className="p-5 bg-gray-700 text-blue-400 font-bold text-xl rounded-lg border-2 border-gray-600 hover:bg-gray-600 hover:border-blue-500 text-left flex justify-between items-center"
                                >
                                    {type} <Icons.ArrowRight size={24} />
                                </button>
                            ))}
                        </div>
                        {/* Removed: Back to Menu button here, relying on universal header button */}
                    </div>
                );
            }
            
            return (
                <form onSubmit={handleSubmit} className="bg-gray-800 p-6 rounded-lg shadow-xl border-t-8 border-indigo-500 space-y-8">
                    
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-2xl font-bold text-indigo-400">{activity} Log</h2>
                        {lastSession && (
                            <button type="button" onClick={handleQuickLog} className="bg-green-900/50 text-green-200 px-4 py-2 rounded-lg font-bold text-sm border border-green-700 shadow-sm hover:bg-green-900">
                                âš¡ Quick Log: Same as Last Time
                            </button>
                        )}
                    </div>
                    
                    {/* History Recap Box */}
                    {lastSession && (
                        <div className="bg-yellow-900/50 p-3 rounded mb-4 border border-yellow-700 text-sm text-yellow-200">
                            <strong>Last Time:</strong> {lastSession.metrics.duration} minutes
                            {lastSession.metrics.avgSpeed && ` @ ${lastSession.metrics.avgSpeed} miles per hour`}
                            {lastSession.metrics.intensity && ` (${lastSession.metrics.intensity})`}
                            {lastSession.metrics.notes && <div className="italic mt-1">"{lastSession.metrics.notes}"</div>}
                        </div>
                    )}

                    {/* SECTION 1: ACTIVITY METRICS (Dynamic Content) */}
                    <section className="bg-gray-900 p-4 rounded-lg border border-gray-700 space-y-6">
                        <h3 className="font-bold text-gray-300 uppercase text-lg border-b border-gray-700 pb-2">Activity Metrics</h3>
                        
                        {activity === 'Tempo Run' && (
                            <div className="space-y-6" ref={durationRef} tabIndex="-1">
                                <div className="bg-blue-900/50 p-4 rounded-lg border border-blue-700 text-center mb-4">
                                    <p className="text-sm font-bold text-blue-300 uppercase">Calculated Totals</p>
                                    <div className="flex justify-around mt-2">
                                        <div><span className="block text-2xl font-black">{tempoStats.totalDur}</span><span className="text-xs text-gray-400">Minutes</span></div>
                                        <div><span className="block text-2xl font-black">{tempoStats.avgSpd}</span><span className="text-xs text-gray-400">Average Miles per Hour</span></div>
                                    </div>
                                </div>
                                
                                <h4 className="font-bold text-gray-500 uppercase text-sm border-b border-gray-700 pb-1">1. Warm Up Segment</h4>
                                <div className="grid grid-cols-2 gap-4">
                                    <AdjustableInput id="tm-w-dur" label="Duration" value={formData.warmupDur} onChange={v => handleChange('warmupDur', v)} step={1} unit="minutes" />
                                    <AdjustableInput id="tm-w-spd" label="Speed" value={formData.warmupSpd} onChange={v => handleChange('warmupSpd', v)} step={0.1} unit="miles per hour" />
                                </div>

                                <h4 className="font-bold text-gray-500 uppercase text-sm border-b border-gray-700 pb-1">2. Tempo Segment</h4>
                                <div className="grid grid-cols-2 gap-4">
                                    <AdjustableInput id="tm-t-dur" label="Duration" value={formData.tempoDur} onChange={v => handleChange('tempoDur', v)} step={1} unit="minutes" />
                                    <AdjustableInput id="tm-t-spd" label="Speed" value={formData.tempoSpd} onChange={v => handleChange('tempoSpd', v)} step={0.1} unit="miles per hour" />
                                </div>

                                <h4 className="font-bold text-gray-500 uppercase text-sm border-b border-gray-700 pb-1">3. Cool Down Segment</h4>
                                <div className="grid grid-cols-2 gap-4">
                                    <AdjustableInput id="tm-c-dur" label="Duration" value={formData.cooldownDur} onChange={v => handleChange('cooldownDur', v)} step={1} unit="minutes" />
                                    <AdjustableInput id="tm-c-spd" label="Speed" value={formData.cooldownSpd} onChange={v => handleChange('cooldownSpd', v)} step={0.1} unit="miles per hour" />
                                </div>
                                <AdjustableInput id="tm-inc" label="Incline" value={formData.inclinePct} onChange={v => handleChange('inclinePct', v)} step={1} unit="%" />
                            </div>
                        )}

                        {activity === 'Progressive Run' && (
                             <div className="space-y-6" ref={durationRef} tabIndex="-1">
                                <div className="bg-purple-900/50 p-4 rounded-lg border border-purple-700 text-center mb-4">
                                    <p className="text-sm font-bold text-purple-300 uppercase">Calculated Totals</p>
                                    <div className="flex justify-around mt-2">
                                        <div><span className="block text-2xl font-black">{progStats.totalDur}</span><span className="text-xs text-gray-400">Minutes</span></div>
                                        <div><span className="block text-2xl font-black">{progStats.avgSpd}</span><span className="text-xs text-gray-400">Average Miles per Hour</span></div>
                                    </div>
                                </div>
                                
                                <h4 className="font-bold text-gray-500 uppercase text-sm border-b border-gray-700 pb-1">1. Base Segment</h4>
                                <div className="grid grid-cols-2 gap-4">
                                    <AdjustableInput id="pg-b-dur" label="Duration" value={formData.progBaseDur} onChange={v => handleChange('progBaseDur', v)} step={1} unit="minutes" />
                                    <AdjustableInput id="pg-b-spd" label="Speed" value={formData.progBaseSpd} onChange={v => handleChange('progBaseSpd', v)} step={0.1} unit="miles per hour" />
                                </div>

                                <h4 className="font-bold text-gray-500 uppercase text-sm border-b border-gray-700 pb-1">2. Build Segment</h4>
                                <div className="grid grid-cols-2 gap-4">
                                    <AdjustableInput id="pg-bu-dur" label="Duration" value={formData.progBuildDur} onChange={v => handleChange('progBuildDur', v)} step={1} unit="minutes" />
                                    <AdjustableInput id="pg-bu-spd" label="Speed" value={formData.progBuildSpd} onChange={v => handleChange('progBuildSpd', v)} step={0.1} unit="miles per hour" />
                                </div>

                                <h4 className="font-bold text-gray-500 uppercase text-sm border-b border-gray-700 pb-1">3. Finish Segment</h4>
                                <div className="grid grid-cols-2 gap-4">
                                    <AdjustableInput id="pg-f-dur" label="Duration" value={formData.progFinishDur} onChange={v => handleChange('progFinishDur', v)} step={1} unit="minutes" />
                                    <AdjustableInput id="pg-f-spd" label="Speed" value={formData.progFinishSpd} onChange={v => handleChange('progFinishSpd', v)} step={0.1} unit="miles per hour" />
                                </div>
                                <AdjustableInput id="pg-inc" label="Incline" value={formData.inclinePct} onChange={v => handleChange('inclinePct', v)} step={1} unit="%" />
                            </div>
                        )}
                        
                        {/* HIIT Run Specific Fields (Uses Adjustable Input for swiping speed/duration) */}
                        {activity === 'HIIT Run' && (
                            <div className="space-y-4" ref={durationRef} tabIndex="-1">
                                <AdjustableInput id="c-duration" label="Total Duration" value={formData.duration} onChange={v => handleChange('duration', v)} step={1} unit="minutes" />
                                <h4 className="font-bold text-gray-500 uppercase text-sm border-b border-gray-700 pb-1">Speed Zones (Miles per Hour)</h4>
                                <div className="grid grid-cols-2 gap-4">
                                    <div><AdjustableInput id="c-easy" label="Easy Speed" value={formData.speedEasy} onChange={v => handleChange('speedEasy', v)} step={0.1} unit="mph" /></div>
                                    <div><AdjustableInput id="c-mod" label="Moderate Speed" value={formData.speedMod} onChange={v => handleChange('speedMod', v)} step={0.1} unit="mph" /></div>
                                    <div><AdjustableInput id="c-hard" label="Hard Speed" value={formData.speedHard} onChange={v => handleChange('speedHard', v)} step={0.1} unit="mph" /></div>
                                    <div><AdjustableInput id="c-max" label="All Out Speed" value={formData.speedAllOut} onChange={v => handleChange('speedAllOut', v)} step={0.1} unit="mph" /></div>
                                </div>
                                <AdjustableInput id="c-inc" label="Incline" value={formData.inclinePct} onChange={v => handleChange('inclinePct', v)} step={1} unit="%" />
                            </div>
                        )}

                        {/* Indoor Cycle Specific Fields (Uses Adjustable Input for swiping duration) */}
                        {activity === 'Indoor Cycle' && (
                            <div className="space-y-4" ref={durationRef} tabIndex="-1">
                                <AdjustableInput id="c-duration" label="Total Duration" value={formData.duration} onChange={v => handleChange('duration', v)} step={1} unit="minutes" />
                                <h4 className="font-bold text-gray-500 uppercase text-sm border-b border-gray-700 pb-1">Intensity Level</h4>
                                <div>
                                    <label className="block text-sm font-bold text-gray-300 mb-3" id="intensity-label">Intensity</label>
                                    <div className="grid grid-cols-2 gap-3" role="radiogroup" aria-labelledby="intensity-label">
                                        {['Easy', 'Moderate', 'Hard', 'All Out'].map(level => (
                                            <label key={level} className={`p-4 border-2 rounded-lg flex items-center justify-center font-bold cursor-pointer ${formData.intensity === level ? 'bg-indigo-900 border-indigo-500 text-indigo-200' : 'border-gray-600 text-gray-300 hover:bg-gray-700'}`}>
                                                <input type="radio" name="intensity" value={level} checked={formData.intensity === level} onChange={e => handleChange('intensity', e.target.value)} className="sr-only" />
                                                {level}
                                            </label>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Endurance Run Specific Fields (Uses Adjustable Input for swiping duration/speed) */}
                        {activity === 'Endurance Run' && (
                            <div className="space-y-4" ref={durationRef} tabIndex="-1">
                                <AdjustableInput id="c-duration" label="Total Duration" value={formData.duration} onChange={v => handleChange('duration', v)} step={1} unit="minutes" />
                                <AdjustableInput id="c-avg" label="Average Speed" value={formData.avgSpeed} onChange={v => handleChange('avgSpeed', v)} step={0.1} unit="miles per hour" />
                                <AdjustableInput id="c-inc" label="Incline" value={formData.inclinePct} onChange={v => handleChange('inclinePct', v)} step={1} unit="%" />
                            </div>
                        )}
                                
                        /* Incline Walk Specific Fields (Uses Adjustable Input for swiping duration/speed/incline) */
                        {activity === 'Incline Walk' && (
                            <div className="space-y-4" ref={durationRef} tabIndex="-1">
                                <AdjustableInput id="c-duration" label="Total Duration" value={formData.duration} onChange={v => handleChange('duration', v)} step={1} unit="minutes" />
                                <AdjustableInput id="c-w-avg" label="Average Speed" value={formData.avgSpeed} onChange={v => handleChange('avgSpeed', v)} step={0.1} unit="miles per hour" />
                                <div className="grid grid-cols-2 gap-4">
                                    <div><AdjustableInput id="c-min" label="Minimum Incline" value={formData.minIncline} onChange={v => handleChange('minIncline', v)} step={1} unit="%" /></div>
                                    <div><AdjustableInput id="c-max" label="Maximum Incline" value={formData.maxIncline} onChange={v => handleChange('maxIncline', v)} step={1} unit="%" /></div>
                                </div>
                            </div>
                        )}
                    </section>
                    
                    {/* SECTION 2: HEART RATE STATS (CONVERTED TO STATIC INPUTS) */}
                    <section className="bg-gray-900 p-4 rounded-lg border border-gray-700 space-y-4">
                        <h3 className="font-bold text-gray-300 uppercase text-lg border-b border-gray-700 pb-2">Heart Rate Statistics</h3>
                        <div className="grid grid-cols-2 gap-4">
                            <StaticInput id="std-hr-avg" label="Average Heart Rate" value={formData.avgHR} onChange={v => handleChange('avgHR', v)} inputMode="numeric" unit="beats per minute" />
                            <StaticInput id="std-hr-max" label="Maximum Heart Rate" value={formData.maxHR} onChange={v => handleChange('maxHR', v)} inputMode="numeric" unit="beats per minute" />
                        </div>
                    </section>

                    {/* SECTION 3: SESSION DETAILS */}
                    <section className="bg-gray-900 p-4 rounded-lg border border-gray-700 space-y-6">
                        <h3 className="font-bold text-gray-300 uppercase text-lg border-b border-gray-700 pb-2">Session Details</h3>
                        
                        <div className="flex items-center gap-3">
                            <input 
                                id="c-guided" 
                                type="checkbox" 
                                checked={formData.isGuided} 
                                onChange={e => handleChange('isGuided', e.target.checked)} 
                                className="w-6 h-6 text-blue-500 rounded focus:ring-blue-500 border-gray-600 bg-gray-800"
                            />
                            <label htmlFor="c-guided" className="text-lg font-bold text-gray-300">
                                Guided Routine (Fitness+)
                            </label>
                        </div>

                        <div>
                            <label htmlFor="cardio-notes" className="block text-sm font-bold text-gray-300 mb-1">Notes</label>
                            <textarea id="cardio-notes" aria-label="Notes on Cardio" value={formData.notes} onChange={e => handleChange('notes', e.target.value)} className="w-full p-3 text-lg border border-gray-600 rounded bg-gray-800 text-gray-100" placeholder="" rows="3" />
                        </div>
                        
                        <div className="bg-indigo-900/50 p-4 rounded-lg border border-indigo-700">
                             {/* FIX: Add unit="RPE" to avoid % display issue */}
                            <AdjustableInput id="c-effort" label="Effort Score (1-10)" value={formData.effort} onChange={v => handleChange('effort', v)} step={1} unit="RPE" min={1} max={10} />
                        </div>
                    </section>

                    <div className="flex gap-3 pt-4">
                        <button type="submit" className="w-full py-4 bg-indigo-600 text-white rounded-lg font-bold text-xl shadow flex items-center justify-center gap-2 hover:bg-indigo-500">
                            <Icons.Check size={24} /> Save Log Entry
                        </button>
                    </div>
                    {/* REMOVED: Redundant Cancel Button */}
                </form>
            );
        }

        // --- Reports Generation Logic (Unchanged) ---
        const generateReportData = (entries, filterType) => {
            const data = [];

            if (entries.length === 0) {
                data.push({ type: 'empty', text: "No workouts found for this period." });
                return data;
            }

            entries.forEach(entry => {
                const dateStr = formatReportDate(entry.date);
                const timeStr = new Date(entry.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                data.push({ type: 'header', text: `${dateStr} at ${timeStr}` });

                if (entry.isCardio) {
                    data.push({ type: 'title', text: `Cardio: ${entry.activity}` });
                    if (entry.metrics) {
                         if (entry.metrics.isGuided) data.push({ type: 'detail', label: 'Style', value: 'Guided (Fitness+)' });
                         if (entry.metrics.duration) data.push({ type: 'detail', label: 'Duration', value: `${entry.metrics.duration} minutes` });
                         if (entry.metrics.effort) data.push({ type: 'detail', label: 'Effort', value: `${entry.metrics.effort}/10 RPE` });
                         if (entry.metrics.avgSpeed) data.push({ type: 'detail', label: 'Avg Speed', value: `${entry.metrics.avgSpeed} miles per hour` });
                         
                         // TEMPO SPECIFIC REPORTING
                         if (entry.activity === 'Tempo Run') {
                             if (entry.metrics.warmupDur) data.push({ type: 'subdetail', label: 'Warmup', value: `${entry.metrics.warmupDur} min @ ${entry.metrics.warmupSpd} mph` });
                             if (entry.metrics.tempoDur) data.push({ type: 'subdetail', label: 'Tempo', value: `${entry.metrics.tempoDur} min @ ${entry.metrics.tempoSpd} mph` });
                             if (entry.metrics.cooldownDur) data.push({ type: 'subdetail', label: 'Cooldown', value: `${entry.metrics.cooldownDur} min @ ${entry.metrics.cooldownSpd} mph` });
                         }

                         // PROGRESSIVE SPECIFIC REPORTING
                         if (entry.activity === 'Progressive Run') {
                             if (entry.metrics.progBaseDur) data.push({ type: 'subdetail', label: 'Base', value: `${entry.metrics.progBaseDur} min @ ${entry.metrics.progBaseSpd} mph` });
                             if (entry.metrics.progBuildDur) data.push({ type: 'subdetail', label: 'Build', value: `${entry.metrics.progBuildDur} min @ ${entry.metrics.progBuildSpd} mph` });
                             if (entry.metrics.progFinishDur) data.push({ type: 'subdetail', label: 'Finish', value: `${entry.metrics.progFinishDur} min @ ${entry.metrics.progFinishSpd} mph` });
                         }

                         // Global Cardio metrics for report
                         if (entry.metrics.inclinePct) data.push({ type: 'detail', label: 'Incline', value: `${entry.metrics.inclinePct}%` });
                         
                         // HEART RATE CHECK
                         if (entry.metrics.avgHR || entry.metrics.maxHR) {
                             const avgHR = entry.metrics.avgHR || 'N/A';
                             const maxHR = entry.metrics.maxHR || 'N/A';
                             data.push({ type: 'detail', label: 'Heart Rate (Avg/Max)', value: `${avgHR} / ${maxHR} bpm` });
                         }

                         if (entry.metrics.intensity) data.push({ type: 'detail', label: 'Intensity', value: entry.metrics.intensity });
                         if (entry.metrics.minIncline) data.push({ type: 'detail', label: 'Incline Range', value: `${entry.metrics.minIncline}% - ${entry.metrics.maxIncline}%` });
                         if (entry.metrics.speedEasy) data.push({ type: 'detail', label: 'Speeds (E/M/H/O)', value: `E:${entry.metrics.speedEasy} / M:${entry.metrics.speedMod} / H:${entry.metrics.speedHard} / O:${entry.metrics.speedAllOut} mph` });
                         if (entry.metrics.notes) data.push({ type: 'note', text: `Note: ${entry.metrics.notes}` });
                    }
                } else if (entry.isVital) {
                    data.push({ type: 'title', text: `Vitals Log` });
                    if (entry.metrics.weight) data.push({ type: 'detail', label: 'Weight', value: `${entry.metrics.weight} pounds` });
                    
                    const bmiResult = calculateBMI(entry.metrics.weight, entry.metrics.heightSnapshot);
                    if (bmiResult.val !== '--') {
                        data.push({ type: 'detail', label: 'BMI', value: bmiResult.val });
                        const mhr = calculateMHR(entry.metrics.ageSnapshot);
                        if (mhr.fox !== '--') data.push({ type: 'detail', label: 'MHR (Fox/Tanaka)', value: `F:${mhr.fox} / T:${mhr.tanaka} bpm` });
                    }
                    
                    if(entry.metrics.waist) data.push({ type: 'detail', label: 'Waist', value: `${entry.metrics.waist} inches` });
                    if(entry.metrics.biceps) data.push({ type: 'detail', label: 'Biceps', value: `${entry.metrics.biceps} inches` });
                    if(entry.metrics.chest) data.push({ type: 'detail', label: 'Chest', value: `${entry.metrics.chest} inches` });
                    if(entry.metrics.thigh) data.push({ type: 'detail', label: 'Thigh', value: `${entry.metrics.thigh} inches` });
                } else {
                    data.push({ type: 'title', text: `Strength Training: ${entry.routine}` });
                    if (entry.overallEffort) data.push({ type: 'detail', label: 'Overall Effort', value: `${entry.overallEffort}/10 RPE` });
                    if (entry.exercises) {
                        
                        entry.exercises.forEach(ex => {
                            if (ex.sets || ex.weight) { 
                                const weightStr = ex.weight ? `${ex.weight} lbs` : 'N/A';
                                const setsStr = ex.sets ? `${ex.sets} sets x ${ex.reps || 'N/A'} reps` : 'N/A';
                                
                                data.push({ type: 'subhead', text: ex.name.toUpperCase() });
                                data.push({ type: 'subdetail', label: 'Weight', value: weightStr });
                                data.push({ type: 'subdetail', label: 'Sets/Reps', value: setsStr });
                                if (ex.time) data.push({ type: 'subdetail', label: 'Time', value: `${ex.time} seconds` });
                                if (ex.notes) data.push({ type: 'note', text: `Note: ${ex.notes}` });
                            }
                        });
                    }
                }
                data.push({ type: 'separator' });
            });

            return data;
        };

        // Helper function to generate the original plain text report (used for Copy/Save TXT exports)
        const generateReportPlainText = (entries, filterType) => {
            let text = `EASY LOG REPORT - ${filterType.toUpperCase()}\n`;
            text += `Generated: ${new Date().toLocaleString()}\n`;
            text += `----------------------------------------\n\n`;

            if (entries.length === 0) {
                text += "No workouts found for this period.\n";
                return text;
            }

            entries.forEach(entry => {
                const dateStr = formatReportDate(entry.date);
                const timeStr = new Date(entry.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                text += `DATE: ${dateStr} at ${timeStr}\n`;
                
                if (entry.isCardio) {
                    text += `TYPE: Cardio (${entry.activity})\n`;
                    if (entry.metrics) {
                         if (entry.metrics.isGuided) text += `STYLE: Guided (Fitness+)\n`;
                         if (entry.metrics.duration) text += `DURATION: ${entry.metrics.duration} minutes\n`;
                         if (entry.metrics.effort) text += `EFFORT: ${entry.metrics.effort}/10 RPE\n`; // Added RPE here
                         if (entry.metrics.avgSpeed) text += `AVERAGE SPEED: ${entry.metrics.avgSpeed} miles per hour\n`;
                         
                         if (entry.activity === 'Tempo Run') {
                             if (entry.metrics.warmupDur) text += `WARMUP: ${entry.metrics.warmupDur} min @ ${entry.metrics.warmupSpd} mph\n`;
                             if (entry.metrics.tempoDur) text += `TEMPO: ${entry.metrics.tempoDur} min @ ${entry.metrics.tempoSpd} mph\n`;
                             if (entry.metrics.cooldownDur) text += `COOLDOWN: ${entry.metrics.cooldownDur} min @ ${entry.metrics.cooldownSpd} mph\n`;
                         }

                         if (entry.activity === 'Progressive Run') {
                             if (entry.metrics.progBaseDur) text += `BASE DURATION: ${entry.metrics.progBaseDur} min @ ${entry.metrics.progBaseSpd} mph\n`;
                             if (entry.metrics.progBuildDur) text += `BUILD DURATION: ${entry.metrics.progBuildDur} min @ ${entry.metrics.progBuildSpd} mph\n`;
                             if (entry.metrics.progFinishDur) text += `FINISH DURATION: ${entry.metrics.progFinishDur} min @ ${entry.metrics.progFinishSpd} mph\n`;
                         }

                         if (entry.metrics.inclinePct) text += `INCLINE PERCENTAGE: ${entry.metrics.inclinePct}%\n`;
                         
                         if (entry.metrics.avgHR || entry.metrics.maxHR) {
                             const avgHR = entry.metrics.avgHR || 'N/A';
                             const maxHR = entry.metrics.maxHR || 'N/A';
                             text += `HEART RATE: Average ${avgHR} / Maximum ${maxHR} beats per minute\n`;
                         }

                         if (entry.metrics.intensity) text += `INTENSITY: ${entry.metrics.intensity}\n`;
                         if (entry.metrics.minIncline) text += `INCLINE RANGE: ${entry.metrics.minIncline}% - ${entry.metrics.maxIncline}%\n`;
                         if (entry.metrics.speedEasy) text += `SPEEDS: Easy:${entry.metrics.speedEasy} / Moderate:${entry.metrics.speedMod} / Hard:${entry.metrics.speedHard} / All Out:${entry.metrics.speedAllOut} miles per hour\n`;
                         if (entry.metrics.notes) text += `NOTE: ${entry.metrics.notes}\n`;
                    }
                } else if (entry.isVital) {
                    text += `TYPE: Vitals Log\n`;
                    if (entry.metrics.weight) text += `WEIGHT: ${entry.metrics.weight} pounds\n`;
                    
                    const bmiResult = calculateBMI(entry.metrics.weight, entry.metrics.heightSnapshot);
                    if (bmiResult.val !== '--') {
                        text += `BMI: ${bmiResult.val}\n`;
                        const mhr = calculateMHR(entry.metrics.ageSnapshot);
                        if (mhr.fox !== '--') text += `MAXIMUM HEART RATE (MHR): Fox ${mhr.fox} / Tanaka ${mhr.tanaka} beats per minute\n`;
                    }
                    
                    if(entry.metrics.waist) text += `WAIST CIRCUMFERENCE: ${entry.metrics.waist} inches\n`;
                    if(entry.metrics.biceps) text += `BICEPS CIRCUMFERENCE: ${entry.metrics.biceps} inches\n`;
                    if(entry.metrics.chest) text += `CHEST CIRCUMFERENCE: ${entry.metrics.chest} inches\n`;
                    if(entry.metrics.thigh) text += `THIGH CIRCUMFERENCE: ${entry.metrics.thigh} inches\n`;
                } else {
                    text += `TYPE: Weight Training (${entry.routine})\n`;
                    if (entry.overallEffort) text += `OVERALL EFFORT: ${entry.overallEffort}/10 RPE\n`; // Added RPE here
                    if (entry.exercises) {
                        
                        entry.exercises.forEach(ex => {
                            if (ex.sets || ex.weight) { 
                                const weightStr = ex.weight ? `${ex.weight} pounds` : 'N/A Weight';
                                const setsStr = ex.sets ? `${ex.sets} sets x ${ex.reps || 'N/A'} reps` : 'N/A Sets/Reps';
                                
                                text += ` - ${ex.name.toUpperCase()}: Weight: ${weightStr}, Sets/Reps: ${setsStr}`;
                                if (ex.time) text += ` [Time: ${ex.time} seconds]`;
                                if (ex.notes) text += `\n   Note: ${ex.notes}`;
                                text += `\n`;
                            }
                        });
                    }
                }
                text += `\n----------------------------------------\n\n`;
            });
            return text;
        };

        // --- CSV Generation Logic (Unchanged) ---
        const generateReportCSV = (entries) => {
            // Define all possible column headers in a guaranteed order
            const headers = [
                "Date", "Time", "Type", "Routine", "Activity", 
                "Exercise_Name", "Sets", "Reps", "Weight_LBS", "Duration_Mins", 
                "Effort_RPE", "Notes", 
                "Avg_Speed_MPH", "Intensity", 
                "Min_Incline_PCT", "Max_Incline_PCT", "Incline_PCT",
                "Speed_Easy_MPH", "Speed_Mod_MPH", "Speed_Hard_MPH", "Speed_AllOut_MPH",
                "HR_Avg_BPM", "HR_Max_BPM", "Guided_Routine",
                "TM_Warmup_Dur", "TM_Warmup_Spd", "TM_Tempo_Dur", "TM_Tempo_Spd", "TM_Cooldown_Dur", "TM_Cooldown_Spd",
                "Prog_Base_Dur", "Prog_Base_Spd", "Prog_Build_Dur", "Prog_Build_Spd", "Prog_Finish_Dur", "Prog_Finish_Spd",
                "V_Weight_LBS", "V_Height_Inches", "V_Age_Years", "V_BMI", "V_MHR_Fox", "V_MHR_Tanaka",
                "V_Waist_Inches", "V_Chest_Inches", "V_Biceps_Inches", "V_Thigh_Inches"
            ];

            const escapeCSV = (value) => {
                if (value === undefined || value === null || value === '') return '';
                let str = String(value);
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    str = str.replace(/"/g, '""');
                    return `"${str}"`;
                }
                return str;
            };

            let csv = headers.join(',') + '\n';

            entries.forEach(entry => {
                const dateObj = new Date(entry.date);
                const dateStr = dateObj.toLocaleDateString();
                const timeStr = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});
                
                if (entry.isVital) {
                    const metrics = entry.metrics || {};
                    const bmi = calculateBMI(metrics.weight, metrics.heightSnapshot).val;
                    const mhr = calculateMHR(metrics.ageSnapshot);
                    
                    const rowData = {
                        "Date": dateStr, 
                        "Time": timeStr, 
                        "Type": "Vitals", 
                        "Routine": "N/A", 
                        "Activity": "Vitals Log", 
                        "Exercise_Name": "", "Sets": "", "Reps": "", "Weight_LBS": "", "Duration_Mins": "", 
                        "Effort_RPE": "", "Notes": metrics.notes || "", 
                        "Avg_Speed_MPH": "", "Intensity": "", 
                        "Min_Incline_PCT": "", "Max_Incline_PCT": "", "Incline_PCT": "",
                        "Speed_Easy_MPH": "", "Speed_Mod_MPH": "", "Speed_Hard_MPH": "", "Speed_AllOut_MPH": "",
                        "HR_Avg_BPM": "", "HR_Max_BPM": "", "Guided_Routine": "",
                        "TM_Warmup_Dur": "", "TM_Warmup_Spd": "", "TM_Tempo_Dur": "", "TM_Tempo_Spd": "", "TM_Cooldown_Dur": "", "TM_Cooldown_Spd": "",
                        "Prog_Base_Dur": "", "Prog_Base_Spd": "", "Prog_Build_Dur": "", "Prog_Build_Spd": "", "Prog_Finish_Dur": "", "Prog_Finish_Spd": "",
                        "V_Weight_LBS": metrics.weight || "", 
                        "V_Height_Inches": metrics.height || "", 
                        "V_Age_Years": metrics.age || "", 
                        "V_BMI": bmi === '--' ? '' : bmi, 
                        "V_MHR_Fox": mhr.fox === '--' ? '' : mhr.fox, 
                        "V_MHR_Tanaka": mhr.tanaka === '--' ? '' : mhr.tanaka,
                        "V_Waist_Inches": metrics.waist || "", 
                        "V_Chest_Inches": metrics.chest || "", 
                        "V_Biceps_Inches": metrics.biceps || "", 
                        "V_Thigh_Inches": metrics.thigh || ""
                    };
                    
                    csv += headers.map(h => escapeCSV(rowData[h])).join(',') + '\n';

                } else if (entry.isCardio) {
                    const metrics = entry.metrics || {};
                    const rowData = {
                        "Date": dateStr, 
                        "Time": timeStr, 
                        "Type": "Cardio", 
                        "Routine": entry.routine || "N/A", 
                        "Activity": entry.activity || "", 
                        "Exercise_Name": "", "Sets": "", "Reps": "", "Weight_LBS": "", 
                        "Duration_Mins": metrics.duration || "", 
                        "Effort_RPE": metrics.effort || "", 
                        "Notes": metrics.notes || "", 
                        "Avg_Speed_MPH": metrics.avgSpeed || "", 
                        "Intensity": metrics.intensity || "", 
                        "Min_Incline_PCT": metrics.minIncline || "", 
                        "Max_Incline_PCT": metrics.maxIncline || "", 
                        "Incline_PCT": metrics.inclinePct || "",
                        "Speed_Easy_MPH": metrics.speedEasy || "", 
                        "Speed_Mod_MPH": metrics.speedMod || "", 
                        "Speed_Hard_MPH": metrics.speedHard || "", 
                        "Speed_AllOut_MPH": metrics.speedAllOut || "",
                        "HR_Avg_BPM": metrics.avgHR || "", 
                        "HR_Max_BPM": metrics.maxHR || "", 
                        "Guided_Routine": metrics.isGuided ? "TRUE" : "FALSE",
                        "TM_Warmup_Dur": metrics.warmupDur || "", 
                        "TM_Warmup_Spd": metrics.warmupSpd || "", 
                        "TM_Tempo_Dur": metrics.tempoDur || "", 
                        "TM_Tempo_Spd": metrics.tempoSpd || "", 
                        "TM_Cooldown_Dur": metrics.cooldownDur || "", 
                        "TM_Cooldown_Spd": metrics.cooldownSpd || "",
                        "Prog_Base_Dur": metrics.progBaseDur || "", 
                        "Prog_Base_Spd": metrics.progBaseSpd || "", 
                        "Prog_Build_Dur": metrics.progBuildDur || "", 
                        "Prog_Build_Spd": metrics.progBuildSpd || "", 
                        "Prog_Finish_Dur": metrics.progFinishDur || "", 
                        "Prog_Finish_Spd": metrics.progFinishSpd || "",
                        "V_Weight_LBS": "", "V_Height_Inches": "", "V_Age_Years": "", "V_BMI": "", "V_MHR_Fox": "", "V_MHR_Tanaka": "",
                        "V_Waist_Inches": "", "V_Chest_Inches": "", "V_Biceps_Inches": "", "V_Thigh_Inches": ""
                    };
                    csv += headers.map(h => escapeCSV(rowData[h])).join(',') + '\n';

                } else {
                    const baseRowData = {
                        "Date": dateStr, 
                        "Time": timeStr, 
                        "Type": "Strength", 
                        "Routine": entry.routine || "N/A", 
                        "Activity": "Weight Training", 
                        "Duration_Mins": "", 
                        "Effort_RPE": entry.overallEffort || "", 
                        "Notes": "", 
                        "Avg_Speed_MPH": "", "Intensity": "", 
                        "Min_Incline_PCT": "", "Max_Incline_PCT": "", "Incline_PCT": "",
                        "Speed_Easy_MPH": "", "Speed_Mod_MPH": "", "Speed_Hard_MPH": "", "Speed_AllOut_MPH": "",
                        "HR_Avg_BPM": "", "HR_Max_BPM": "", "Guided_Routine": "",
                        "TM_Warmup_Dur": "", "TM_Warmup_Spd": "", "TM_Tempo_Dur": "", "TM_Tempo_Spd": "", "TM_Cooldown_Dur": "", "TM_Cooldown_Spd": "",
                        "Prog_Base_Dur": "", "Prog_Base_Spd": "", "Prog_Build_Dur": "", "Prog_Build_Spd": "", "Prog_Finish_Dur": "", "Prog_Finish_Spd": "",
                        "V_Weight_LBS": "", "V_Height_Inches": "", "V_Age_Years": "", "V_BMI": "", "V_MHR_Fox": "", "V_MHR_Tanaka": "",
                        "V_Waist_Inches": "", "V_Chest_Inches": "", "V_Biceps_Inches": "", "V_Thigh_Inches": ""
                    };
                    
                    (entry.exercises || []).forEach(ex => {
                        if (ex.sets || ex.weight) {
                            const rowData = {
                                ...baseRowData,
                                "Exercise_Name": ex.name || "", 
                                "Sets": ex.sets || "", 
                                "Reps": ex.reps || "", 
                                "Weight_LBS": ex.weight || "",
                                "Duration_Mins": ex.time ? (parseFloat(ex.time) / 60).toFixed(2) : "", // Convert seconds to minutes for CSV
                                "Notes": ex.notes || "",
                            };
                            csv += headers.map(h => escapeCSV(rowData[h])).join(',') + '\n';
                        }
                    });
                }
            });
            return csv;
        };

        // --- Report Display Components for Accessibility (Dark Mode) ---
        const ReportDetail = ({ label, value, type = 'detail' }) => (
            <li 
                tabIndex="0" 
                className={`p-2 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md ${type === 'detail' ? 'text-gray-300 ml-4' : type === 'subdetail' ? 'text-gray-400 ml-8' : 'text-yellow-200 italic ml-4 bg-gray-900'}`}
                aria-label={`${label && `${label} is`} ${value}`}
            >
                {label && <span className="font-bold text-gray-100">{label}:</span>} {value}
            </li>
        );

        const ReportHeader = ({ text }) => (
            <li 
                tabIndex="0" 
                className="mt-4 mb-2 p-2 bg-gray-700 text-lg font-extrabold text-gray-100 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                aria-label={`Workout Entry. ${text}`}
            >
                {text}
            </li>
        );
        
        const ReportSubHeader = ({ text }) => (
            <li 
                tabIndex="0" 
                className="mt-2 mb-1 p-2 bg-gray-900 text-base font-bold text-gray-300 border-b border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-md ml-2"
                aria-label={`Section: ${text}`}
            >
                {text}
            </li>
        );

        // --- Reports, AddForm, and Main App (Dark Mode) ---
        function ReportsView({ history, onBack }) {
            const [filter, setFilter] = useState('day');
            const [reportData, setReportData] = useState([]); 
            const [isGenerating, setIsGenerating] = useState(false);
            
            const filterHistory = (history, currentFilter) => {
                const now = new Date();
                return history.filter(entry => {
                    const d = new Date(entry.date);
                    if (currentFilter === 'day') return d.toDateString() === now.toDateString();
                    if (currentFilter === 'week') { 
                        const oneWeekAgo = new Date(); oneWeekAgo.setDate(now.getDate() - 7); return d >= oneWeekAgo; 
                    }
                    if (currentFilter === 'month') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                    if (currentFilter === 'year') return d.getFullYear() === now.getFullYear();
                    if (currentFilter === 'all') return true;
                    return false;
                }).slice().reverse();
            };

            const handleGenerateReport = () => {
                triggerHaptic();
                setIsGenerating(true);
                setReportData([{ type: 'status', text: "Generating report..." }]);
                
                setTimeout(() => {
                    const filtered = filterHistory(history, filter);
                    const structuredData = generateReportData(filtered, filter);
                    setReportData(structuredData);
                    setIsGenerating(false);
                }, 100); 
            };
            
            const getExportData = () => {
                return filterHistory(history, filter);
            };
            
            const generateFilename = (ext = 'txt') => {
                const now = new Date();
                const pad = (n) => n.toString().padStart(2, '0');
                const timestamp = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}`;
                return `EasyLog_Report_${filter}_${timestamp}.${ext}`;
            };
            
            const isReportReady = reportData.length > 0 && reportData[0].type !== 'status' && reportData[0].type !== 'empty' && !isGenerating;

            const handleCopy = () => { 
                triggerHaptic(); 
                if (!isReportReady) return;
                const data = getExportData();
                const text = generateReportPlainText(data, filter); 
                const ta = document.createElement("textarea"); 
                ta.value = text; 
                document.body.appendChild(ta); 
                ta.select(); 
                document.execCommand('copy'); 
                document.body.removeChild(ta); 
            };
            
            const handleDownloadTXT = () => { 
                triggerHaptic(); 
                if (!isReportReady) return;
                const data = getExportData();
                const reportContent = generateReportPlainText(data, filter);
                
                const blob = new Blob([reportContent], { type: 'text/plain' }); 
                const url = URL.createObjectURL(blob); 
                const a = document.createElement('a'); 
                a.href = url; 
                a.download = generateFilename('txt'); 
                document.body.appendChild(a); 
                a.click(); 
                document.body.removeChild(a); 
                URL.revokeObjectURL(url); 
            };
            
            const handleDownloadCSV = () => { 
                triggerHaptic(); 
                if (!isReportReady) return;
                const data = getExportData();
                const csvData = generateReportCSV(data);
                
                const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' }); 
                const url = URL.createObjectURL(blob); 
                const a = document.createElement('a'); 
                a.href = url; 
                a.download = generateFilename('csv'); 
                document.body.appendChild(a); 
                a.click(); 
                document.body.removeChild(a); 
                URL.revokeObjectURL(url); 
            };

            useEffect(() => {
                setReportData([{ type: 'status', text: "Select a period and press 'Generate Report' to view results." }]);
            }, [filter]);


            const renderReportEntry = (entry, index) => {
                switch (entry.type) {
                    case 'header':
                        return <ReportHeader key={index} text={`Entry: ${entry.text}`} />;
                    case 'title':
                        return <ReportSubHeader key={index} text={entry.text} />;
                    case 'subhead':
                        return <ReportSubHeader key={index} text={entry.text} />;
                    case 'detail':
                    case 'subdetail':
                        return <ReportDetail key={index} label={entry.label} value={entry.value} type={entry.type} />;
                    case 'note':
                        return <ReportDetail key={index} label="Note" value={entry.text.replace('Note: ', '')} type="note" />;
                    case 'separator':
                        return <li key={index} className="h-1 my-4 bg-gray-700 rounded" aria-hidden="true"></li>;
                    case 'status':
                    case 'empty':
                        return <li key={index} className="p-4 text-center text-lg font-medium text-gray-500">{entry.text}</li>;
                    default:
                        return null;
                }
            };

            return (
                <div className="space-y-6">
                    <div className="bg-gray-800 p-4 rounded-lg shadow text-center">
                        <h2 className="text-xl font-bold text-gray-100">Reports</h2>
                    </div>
                    
                    <div className="bg-gray-800 p-4 rounded-lg shadow">
                         <div className="grid grid-cols-5 gap-1">
                            {['day', 'week', 'month', 'year', 'all'].map(f => (
                                <button key={f} onClick={() => { triggerHaptic(); setFilter(f); }} className={`py-3 px-1 rounded text-sm font-bold uppercase ${filter === f ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}>
                                    {f}
                                </button>
                            ))}
                        </div>
                    </div>
                    
                    {/* GENERATE BUTTON */}
                    <button 
                        onClick={handleGenerateReport} 
                        className={`w-full py-4 rounded-lg font-bold text-xl shadow-md flex items-center justify-center gap-3 transition-colors ${isGenerating ? 'bg-gray-600 cursor-not-allowed text-gray-400' : 'bg-green-600 hover:bg-green-500 text-white'}`}
                        disabled={isGenerating}
                        aria-busy={isGenerating}
                        aria-label={isGenerating ? "Generating report, please wait" : `Generate Report for ${filter} data`}
                    >
                        {isGenerating ? (
                            <>
                                <div className="spinner w-5 h-5 border-white" aria-hidden="true"></div> 
                                Generating...
                            </>
                        ) : (
                            <>
                                <Icons.RefreshCw size={24} /> 
                                Generate Report Preview ({filter.charAt(0).toUpperCase() + filter.slice(1)})
                            </>
                        )}
                    </button>


                    {/* REPORT PREVIEW: RENDERED AS NAVIGABLE LIST */}
                    <div className="space-y-4">
                        <h3 className="text-lg font-bold text-gray-300 border-b border-gray-700 pb-2">Report Preview ({filter.charAt(0).toUpperCase() + filter.slice(1)})</h3>
                        <div className="bg-gray-800 p-4 rounded-lg shadow-inner max-h-[50vh] overflow-y-auto border border-gray-700">
                            <ul role="feed" aria-label={`Workout Report for ${filter}`}>
                                {reportData.map(renderReportEntry)}
                            </ul>
                        </div>
                    </div>
                    
                    {/* EXPORT BUTTONS */}
                    <div className="flex gap-2 pt-4 border-t border-gray-700">
                        <button 
                            onClick={handleCopy} 
                            className={`flex-1 py-4 text-sm font-bold rounded-lg flex items-center justify-center gap-2 ${isReportReady ? 'bg-indigo-900 text-indigo-200 border-2 border-indigo-700 hover:bg-indigo-800' : 'bg-gray-700 text-gray-500 cursor-not-allowed'}`}
                            disabled={!isReportReady}
                        >
                            <Icons.Clipboard size={20} /> Copy for AI
                        </button>
                        <button 
                            onClick={handleDownloadTXT} 
                            className={`flex-1 py-4 text-sm font-bold rounded-lg flex items-center justify-center gap-2 ${isReportReady ? 'bg-green-900 text-green-200 border-2 border-green-700 hover:bg-green-800' : 'bg-gray-700 text-gray-500 cursor-not-allowed'}`}
                            disabled={!isReportReady}
                        >
                            <Icons.FileText size={20} /> Save TXT
                        </button>
                        <button 
                            onClick={handleDownloadCSV} 
                            className={`flex-1 py-4 text-sm font-bold rounded-lg flex items-center justify-center gap-2 ${isReportReady ? 'bg-yellow-900 text-yellow-200 border-2 border-yellow-700 hover:bg-yellow-800' : 'bg-gray-700 text-gray-500 cursor-not-allowed'}`}
                            disabled={!isReportReady}
                        >
                            <Icons.Download size={20} /> Export as CSV
                        </button>
                    </div>
                </div>
            );
        }

        function AddExerciseForm({ onAdd, routine, availableExercises }) {
            const [mode, setMode] = useState('select');
            const [customInput, setCustomInput] = useState('');
            const selectRef = useRef(null);
            const inputRef = useRef(null);
            const handleSelectChange = (e) => { const val = e.target.value; if (val === 'TYPE_NEW') { setMode('type'); setTimeout(() => inputRef.current?.focus(), 100); } else if (val !== '') { onAdd(val, false); e.target.value = ''; } };
            const handleCustomSubmit = (e) => { e.preventDefault(); if (customInput.trim()) { onAdd(customInput.trim(), true); setCustomInput(''); setMode('select'); setTimeout(() => selectRef.current?.focus(), 100); } };
            return (
                <div className="bg-blue-900/50 p-4 rounded-lg border-2 border-blue-800 mt-6">
                    <div className="flex justify-between items-center mb-2">
                        <h2 className="text-lg font-bold text-gray-300 uppercase tracking-wide mb-2 pl-1">Add New Exercise</h2>
                         <a href="#" onClick={(e) => { e.preventDefault(); inputRef.current && inputRef.current.focus(); }} className="sr-only">Jump to Add Form</a>
                    </div>
                    {mode === 'select' ? (<div className="relative"><select ref={selectRef} onChange={handleSelectChange} defaultValue="" className="block w-full p-4 text-lg border border-blue-700 rounded shadow-sm focus:ring-4 focus:ring-blue-600 appearance-none bg-gray-800 text-gray-100"><option value="" disabled>Select exercise...</option>{availableExercises.map((ex) => (<option key={ex} value={ex}>{ex}</option>))}<option value="TYPE_NEW" className="font-bold text-blue-400">+ Type New...</option></select><div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-400"><Icons.ArrowRight size={24} /></div></div>) : (<form onSubmit={handleCustomSubmit} className="flex flex-col gap-3"><input ref={inputRef} type="text" value={customInput} onChange={(e) => setCustomInput(e.target.value)} placeholder={`New ${routine} Exercise Name`} className="w-full p-4 border border-blue-700 rounded shadow-sm text-lg focus:ring-4 focus:ring-blue-600 bg-gray-800 text-gray-100" autoComplete="off" /><div className="flex gap-2"><button type="button" onClick={() => setMode('select')} className="flex-1 py-3 bg-gray-700 text-gray-100 rounded-lg font-bold hover:bg-gray-600">Cancel</button><button type="submit" className="flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-500">Save</button></div></form>)}
                </div>
            );
        }

        // --- MAIN APP (Dark Mode) ---
        function App() {
            const [isDataLoaded, setIsDataLoaded] = useState(false); 
            const [showSchedule, setShowSchedule] = useState(true);
            const [currentDate, setCurrentDate] = useState(new Date());
            const [view, setView] = useState('menu'); 
            const [history, setHistory] = useState([]);
            const [manualRoutine, setManualRoutine] = useState(null);
            const [manualETPFocus, setManualETPFocus] = useState(null); 
            const [todaysExercises, setTodaysExercises] = useState([]);
            const [customDb, setCustomDb] = useState({});
            const [editingId, setEditingId] = useState(null);
            const [announcement, setAnnouncement] = useState('');
            const [workoutEffort, setWorkoutEffort] = useState('5');
            const [analysisResults, setAnalysisResults] = useState(null); // State to hold analysis results
            
            const [targetCardio, setTargetCardio] = useState(''); 

            
            const announcementRef = useRef(null);
            const headerRef = useRef(null);
            const finishRef = useRef(null);

            // INIT EFFECT
            useEffect(() => {
                try {
                    const savedHistory = localStorage.getItem('workout_history');
                    const savedCurrentSession = localStorage.getItem('current_session');
                    const savedSessionDate = localStorage.getItem('current_session_date');
                    const savedCustomDb = localStorage.getItem('custom_exercise_db');
                    const savedManualRoutine = localStorage.getItem('manual_routine');
                    const savedManualETPFocus = localStorage.getItem('manual_etp_focus'); 
                    const seenSchedule = sessionStorage.getItem('seen_schedule_v5'); 
                    
                    if (savedHistory) setHistory(JSON.parse(savedHistory));
                    if (savedCustomDb) setCustomDb(JSON.parse(savedCustomDb));
                    
                    const todayStr = new Date().toLocaleDateString();
                    
                    if (savedSessionDate && savedSessionDate !== todayStr) {
                         localStorage.removeItem('manual_routine');
                         setManualRoutine(null);
                         localStorage.removeItem('manual_etp_focus'); 
                         setManualETPFocus(null); 
                    } else {
                         if (savedManualRoutine) setManualRoutine(savedManualRoutine);
                         if (savedManualETPFocus) setManualETPFocus(savedManualETPFocus); 
                    }

                    if (savedCurrentSession && savedSessionDate) {
                        if (savedSessionDate === todayStr) {
                            try { setTodaysExercises(JSON.parse(savedCurrentSession)); } catch(e) { console.error("Session corrupted", e); }
                        }
                    }
                    if (seenSchedule) setShowSchedule(false); 
                } catch (err) {
                    console.error("Critical Init Error", err);
                } finally {
                    setTimeout(() => {
                        const loader = document.getElementById('loading-screen');
                        if (loader) loader.style.display = 'none';
                        setIsDataLoaded(true);
                    }, 800);
                }
            }, []);

            // PERSISTENCE
            useEffect(() => { if(isDataLoaded) localStorage.setItem('current_session', JSON.stringify(todaysExercises)); }, [todaysExercises, isDataLoaded]);
            useEffect(() => { if(isDataLoaded) localStorage.setItem('current_session_date', new Date().toDateString()); }, [todaysExercises, isDataLoaded]);
            useEffect(() => { if(isDataLoaded) localStorage.setItem('workout_history', JSON.stringify(history)); }, [history, isDataLoaded]);
            useEffect(() => { if(isDataLoaded) localStorage.setItem('custom_exercise_db', JSON.stringify(customDb)); }, [customDb, isDataLoaded]);
            useEffect(() => { if(isDataLoaded) localStorage.setItem('manual_etp_focus', manualETPFocus); }, [manualETPFocus, isDataLoaded]); 
            
            // Focus Management
            useEffect(() => { 
                if (headerRef.current && !showSchedule) {
                    setTimeout(() => headerRef.current.focus(), 100);
                }
            }, [view, showSchedule]);

            const activeRoutine = manualRoutine || getRoutineForDay(currentDate);
            const todaysETPFocus = getETPRunForDay(currentDate, manualETPFocus);

            const announce = (message) => { setAnnouncement(message); setTimeout(() => setAnnouncement(''), 6000); };

            const goToMenu = () => {
                try {
                    sessionStorage.setItem('seen_schedule_v5', 'true');
                } catch (e) { console.error("Storage error", e); }
                setShowSchedule(false);
                setView('menu');
            };

            const switchToBonus = () => {
                try { sessionStorage.setItem('seen_schedule_v5', 'true'); } catch (e) {}
                setShowSchedule(false);
                setView('lucky'); 
            };
            
            const changeRoutine = (newRoutine) => {
                if (todaysExercises.length > 0) {
                    setTodaysExercises([]);
                }
                setManualRoutine(newRoutine);
                localStorage.setItem('manual_routine', newRoutine);
            };

            const changeETPFocus = (newFocus) => { 
                const focusToSet = newFocus === 'Scheduled' ? null : newFocus;
                setManualETPFocus(focusToSet);
                announce(`ETP Focus set to ${focusToSet || 'Scheduled'}.`);
            };

            const handleBonusSave = (entry) => {
                const record = {
                    id: Date.now(),
                    date: new Date().toString(),
                    isCardio: entry.type === 'Cardio',
                    routine: 'Bonus Session', 
                    isBonus: true, 
                    activity: entry.type === 'Cardio' ? entry.name : undefined,
                    metrics: entry.type === 'Cardio' ? { duration: entry.duration, notes: entry.notes, ...entry } : undefined,
                    exercises: entry.type === 'Strength' ? [{ name: entry.name, weight: entry.weight, sets: entry.sets, reps: entry.reps }] : undefined
                };
                setHistory(prev => [...prev, record]);
                announce(`${entry.name} saved to Bonus Session.`);
            };

            const handleVitalsSave = (metrics) => {
                const record = {
                    id: Date.now(),
                    date: new Date().toString(),
                    isVital: true,
                    metrics: metrics
                };
                setHistory(prev => [...prev, record]);
                setView('menu');
                announce("Vitals Saved.");
            };
            
            const handleUpdateHistoryEntry = (id, updatedEntry) => {
                setHistory(prev => prev.map(entry => entry.id === id ? updatedEntry : entry));
                announce("Entry updated successfully.");
            };

            const handleDeleteHistoryEntry = (id) => {
                setHistory(prev => prev.filter(entry => entry.id !== id));
                announce("Entry deleted successfully.");
            };

            // NEW: Handler for Hall of Fame Results
            const handleAnalysisResults = (results) => {
                setAnalysisResults(results);
                setView('analysis-results');
                announce("Analysis complete. Results are now available.");
            };

            const masterExerciseList = useMemo(() => {
                const standard = Object.values(DEFAULT_DB).flat();
                const custom = Object.values(customDb).flat();
                return [...new Set([...standard, ...custom])].sort();
            }, [customDb]);

            const activeExercise = useMemo(() => {
                if (todaysExercises.length === 0) return null;
                if (editingId) {
                    const found = todaysExercises.find(ex => ex.id === editingId);
                    if (found) return found;
                }
                return todaysExercises.find(ex => !ex.isCompleted);
            }, [todaysExercises, editingId]);

            const upNextExercises = useMemo(() => {
                if (!activeExercise) return [];
                const activeIndex = todaysExercises.findIndex(ex => ex.id === activeExercise.id);
                return todaysExercises.slice(activeIndex + 1).filter(ex => !ex.isCompleted);
            }, [todaysExercises, activeExercise]);

            const completedExercises = useMemo(() => {
                return todaysExercises.filter(ex => ex.isCompleted);
            }, [todaysExercises]);

            const handleNextExercise = (currentExercise) => { 
                triggerHaptic(); 
                playSound('success');
                if (currentExercise.weight && currentExercise.previousWeight) {
                    const cleanWeight = parseFloat(currentExercise.weight.toString().replace(/[^0-9.]/g, ''));
                    const cleanPrev = parseFloat(currentExercise.previousWeight.toString().replace(/[^0-9.]/g, ''));
                    if (!isNaN(cleanWeight) && !isNaN(cleanPrev) && cleanWeight > cleanPrev) {
                        announce(`New PR on ${currentExercise.name}!`);
                    }
                }
                setTodaysExercises(prev => prev.map(e => e.id === currentExercise.id ? { ...e, isCompleted: true } : e));
                setEditingId(null);
                announce("Saved. Loading next.");
            };

            const handleSkipExercise = (currentExercise) => { 
                triggerHaptic(); 
                playSound('skip');
                const currentIndex = todaysExercises.findIndex(ex => ex.id === currentExercise.id); 
                const newSession = [...todaysExercises]; 
                newSession.splice(currentIndex, 1); 
                newSession.push(currentExercise); 
                setTodaysExercises(newSession); 
                setEditingId(null);
                announce(`Skipped. Now: ${newSession[currentIndex].name}.`); 
            };

            const handleLoadLastWorkout = () => { 
                triggerHaptic(); 
                const lastWorkout = history.slice().reverse().find(w => !w.isCardio && w.routine === activeRoutine); 
                if (!lastWorkout) { announce("No history."); return; } 
                const newSession = lastWorkout.exercises.map(ex => ({ 
                    ...ex, id: Date.now() + Math.random(), previousWeight: ex.weight, isCompleted: false 
                })); 
                if (todaysExercises.length > 0) {
                    const existingNames = new Set(todaysExercises.map(ex => ex.name));
                    const uniqueNew = newSession.filter(ex => !existingNames.has(ex.name));
                    if (uniqueNew.length === 0) { announce("All exercises already in list."); return; }
                    setTodaysExercises(prev => [...prev, ...uniqueNew]);
                    announce(`Merged ${uniqueNew.length} exercises.`);
                } else {
                    setTodaysExercises(newSession); 
                    if(newSession.length) setEditingId(newSession[0].id); 
                    announce("Loaded."); 
                }
            };

            const handleAddExercise = (exerciseName, isNewCustom) => { 
                triggerHaptic(); 
                if(isNewCustom) setCustomDb(prev => { const list = prev[activeRoutine] || []; if (!list.includes(exerciseName)) return { ...prev, [activeRoutine]: [...list, exerciseName] }; return prev; }); 
                let lastData = { sets: '', reps: '', weight: '', time: '', notes: '' };
                for (let i = history.length - 1; i >= 0; i--) {
                    if (history[i].isCardio) continue;
                    if (history[i].isBonus) continue;
                    
                    const pastExercise = history[i].exercises.find(e => e.name.toLowerCase() === exerciseName.toLowerCase());
                    if (pastExercise) { lastData = { ...pastExercise }; break; }
                }
                const newExercise = { 
                    id: Date.now(), name: exerciseName, sets: lastData.sets || '', reps: lastData.reps || '', weight: lastData.weight || '', 
                    time: lastData.time || '', notes: '', previousWeight: lastData.weight || '', isCompleted: false 
                }; 
                setTodaysExercises([...todaysExercises, newExercise]); 
                setEditingId(newExercise.id); 
                announce("Added."); 
            };

            const updateExercise = (id, field, value) => { if (field === 'timer_finished') { announce("Rest finished!"); return; } setTodaysExercises(prev => prev.map(ex => ex.id === id ? { ...ex, [field]: value } : ex)); };
            const removeExercise = (id, name) => { setTodaysExercises(prev => prev.filter(ex => ex.id !== id)); if (editingId === id) setEditingId(null); announce("Removed."); };
            
            const finishWorkout = () => { 
                triggerHaptic(); 
                if (!todaysExercises.length) return; 
                setEditingId(null); 
                const record = { 
                    id: Date.now(), 
                    date: new Date().toString(), 
                    routine: activeRoutine, 
                    isCardio: false, 
                    exercises: todaysExercises,
                    overallEffort: workoutEffort 
                }; 
                setHistory([...history, record]); 
                setTodaysExercises([]); 
                localStorage.removeItem('current_session'); 
                setManualRoutine(null); 
                setManualETPFocus(null); 
                setView('menu'); 
                announce("Saved."); 
            };
            
            const handleSaveCardio = (activity, metrics) => { 
                const record = { id: Date.now(), date: new Date().toString(), isCardio: true, activity, metrics }; 
                setHistory([...history, record]); 
                announce("Saved."); 
                setTargetCardio(''); 
                setView('menu'); 
            };

            const backupData = () => { 
                triggerHaptic(); 
                const data = { history, currentSession: todaysExercises, customDb, exportDate: new Date().toString() }; 
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); 
                const url = URL.createObjectURL(blob); 
                const a = document.createElement('a'); 
                
                const now = new Date();
                const pad = (n) => n.toString().padStart(2, '0');
                const timestamp = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}`;
                
                a.href = url; 
                a.download = `EasyLog_Backup_${timestamp}.json`; 
                document.body.appendChild(a); 
                a.click(); 
                document.body.removeChild(a); 
            };

            const restoreData = (event) => { 
                triggerHaptic(); 
                const file = event.target.files[0]; 
                if(!file) return; 
                const reader = new FileReader(); 
                reader.onload = (e) => { 
                    try {
                        const data = JSON.parse(e.target.result); 
                        if(data.history) setHistory(data.history); 
                        if(data.currentSession) setTodaysExercises(data.currentSession); 
                        if(data.customDb) setCustomDb(data.customDb); 
                        announce("Restored."); 
                        playSound('success');
                    } catch(err) {
                        playSound('skip');
                    }
                }; 
                reader.readAsText(file); 
            };

            const getTimeAgo = (dateString) => {
                if (!dateString) return '';
                const diff = new Date() - new Date(dateString);
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                if (days === 0) return "Today";
                if (days === 1) return "Yesterday";
                return `${days} days ago`;
            };
            
            const availableExercises = [...(DEFAULT_DB[activeRoutine] || []), ...(customDb[activeRoutine] || [])].sort();
            
            const lastEntry = history.length > 0 ? history[history.length - 1] : null;
            const dbStatus = lastEntry 
                ? `Database Active. Last activity: ${lastEntry.isCardio ? lastEntry.activity : (lastEntry.routine || 'Workout')} (${getTimeAgo(lastEntry.date)})`
                : "Database Empty. No history found.";

            // RENDER
            if (!isDataLoaded) return null; 

            if (showSchedule) {
                return <SplashScreen 
                    onGoToMenu={goToMenu} 
                    onBonus={switchToBonus} 
                    routine={activeRoutine} 
                    history={history} 
                    currentSession={todaysExercises} 
                    todaysETPFocus={todaysETPFocus} 
                    manualETPFocus={manualETPFocus} 
                    changeETPFocus={changeETPFocus} 
                    onJumpToCardio={(act) => { 
                        if (act === 'ETP Run') {
                            goToMenu();
                            setView('etp-menu');
                        } else {
                            goToMenu(); 
                            setTargetCardio(act); 
                            setView('cardio'); 
                        }
                    }} 
                    onJumpToWeights={(rt) => { goToMenu(); changeRoutine(rt); setView('weights'); }} 
                    onChangeRoutine={changeRoutine}
                />;
            }

            return (
                <div className="min-h-screen bg-gray-900 text-gray-100 font-sans pb-20">
                    <div role="status" aria-live="polite" className="sr-only" ref={announcementRef}>{announcement}</div>
                    <header className="bg-gray-800 text-white p-4 shadow-md sticky top-0 z-20 border-b border-gray-700">
                        <div className="max-w-3xl mx-auto flex justify-between items-center">
                            
                            {/* TOP LEFT NAVIGATION LOGIC (Back to Menu / Back to Schedule) */}
                            <div className="flex gap-2">
                                {view !== 'menu' ? (
                                    // Back to Menu button for all non-menu views
                                    // This button also serves as the implicit "Cancel" function for data entry pages.
                                    <button 
                                        ref={headerRef} 
                                        onClick={() => {triggerHaptic(); setView('menu');}} 
                                        className="p-3 bg-gray-700 rounded text-gray-100 hover:bg-gray-600 flex items-center gap-2 font-bold"
                                        aria-label={view === 'analysis-results' ? "Go back to Hall of Fame" : "Go to Main Menu (Cancel current entry)"}
                                    >
                                        <Icons.ArrowLeft size={20} /> {view === 'analysis-results' ? 'Hall of Fame' : 'Main Menu'}
                                    </button>
                                ) : (
                                    // Back to Schedule button when on the main menu
                                    <button
                                        ref={headerRef}
                                        onClick={() => { triggerHaptic(); setShowSchedule(true); }} 
                                        className="p-3 bg-gray-700 rounded text-gray-100 hover:bg-gray-600 flex items-center gap-2 font-bold"
                                        aria-label="Go back to Today's Schedule" 
                                    >
                                        <Icons.ArrowLeft size={20} /> Today's Schedule
                                    </button>
                                )}
                            </div>
                        </div>
                    </header>
                    <main className="max-w-3xl mx-auto p-4">
                        {view === 'menu' && (
                            <div className="space-y-6 mt-4">
                                <div className="text-center mb-4"><p className="text-gray-400 font-medium">{formatDate(currentDate)}</p></div>
                                
                                {/* DATABASE STATUS MONITOR */}
                                <div className={`p-3 rounded-lg border-2 mb-4 text-sm font-bold text-center ${lastEntry ? 'bg-green-900/50 border-green-800 text-green-200' : 'bg-red-900/50 border-red-800 text-red-200'}`}>
                                    {dbStatus}
                                </div>
                                
                                {currentDate.getDay() === 5 && <div className="bg-yellow-900/50 border-l-8 border-yellow-700 text-yellow-200 p-4 rounded-lg flex items-center gap-3" role="alert"><span className="font-bold text-lg">âš ï¸ It's Friday. Don't forget to backup!</span></div>}

                                {/* SECTION 1: DAILY WORKOUTS */}
                                <h2 className="text-2xl font-extrabold text-gray-100 border-b-2 border-blue-900 pb-2 mb-4">Today's Workouts</h2>
                                <div className="space-y-4">
                                    <button onClick={() => {triggerHaptic(); setView('weights');}} className="w-full p-8 bg-blue-700 text-white rounded-xl shadow-lg hover:bg-blue-600 focus:ring-4 focus:ring-blue-400 text-left">
                                        <div className="flex items-center gap-4 mb-2"><span aria-hidden="true">ðŸ‹ï¸</span><span className="text-3xl font-extrabold">{activeRoutine}</span></div>
                                    </button>
                                    <button onClick={() => {triggerHaptic(); setTargetCardio(''); setView('cardio');}} className="w-full p-8 bg-indigo-700 text-white rounded-xl shadow-lg hover:bg-indigo-600 focus:ring-4 focus:ring-indigo-400 text-left">
                                        <div className="flex items-center gap-4 mb-2"><span aria-hidden="true">ðŸƒ</span><span className="text-3xl font-extrabold">Cardio</span></div>
                                    </button>
                                    <button onClick={() => {triggerHaptic(); setView('lucky');}} className="w-full p-8 bg-purple-700 text-white rounded-xl shadow-lg hover:bg-purple-600 focus:ring-4 focus:ring-purple-400 text-left">
                                        <div className="flex items-center gap-4 mb-2"><span aria-hidden="true">ðŸŽ²</span><span className="text-3xl font-extrabold">Bonus Session</span></div>
                                    </button>
                                </div>

                                {/* SECTION 2: BODY & HEALTH METRICS */}
                                <h2 className="text-2xl font-extrabold text-gray-100 border-b-2 border-teal-900 pb-2 pt-4 mb-4">Body & Health Metrics</h2>
                                <div className="space-y-4">
                                    <button onClick={() => {triggerHaptic(); setView('vitals');}} className="w-full p-6 bg-teal-600 text-white rounded-xl shadow border border-teal-500 hover:bg-teal-700 text-left flex items-center gap-4">
                                        <span aria-hidden="true">â¤ï¸</span><span className="text-2xl font-bold">Vitals & BMI</span>
                                    </button>
                                </div>
                                
                                {/* SECTION 3: DATA & PROGRESS */}
                                <h2 className="text-2xl font-extrabold text-gray-100 border-b-2 border-gray-700 pb-2 pt-4 mb-4">Data & Progress</h2>
                                <div className="space-y-4">
                                    <button onClick={() => {triggerHaptic(); setView('reports');}} className="w-full p-6 bg-gray-800 text-gray-100 rounded-xl shadow border border-gray-700 hover:bg-gray-700 text-left flex items-center gap-4">
                                        <span aria-hidden="true">ðŸ“œ</span><span className="text-xl font-bold">Reports</span>
                                    </button>
                                    
                                    {/* HALL OF FAME LINK */}
                                    <button onClick={() => {triggerHaptic(); setView('hall-of-fame');}} className="w-full p-6 bg-gray-800 text-gray-100 rounded-xl shadow border border-gray-700 hover:bg-gray-700 text-left flex items-center gap-4">
                                        <span aria-hidden="true">ðŸ†</span><span className="text-xl font-bold text-yellow-500">Hall of Fame</span>
                                    </button>
                                    
                                    {/* INTEGRATED BACKUP/RESTORE CONTROLS */}
                                    <div className="bg-gray-800 p-6 rounded-lg shadow border border-gray-700 space-y-4">
                                        <h3 className="text-lg font-bold text-gray-300 border-b border-gray-700 pb-2 flex items-center gap-2">Database Management</h3>
                                        <button onClick={backupData} className="w-full flex items-center justify-center gap-3 bg-gray-700 text-white p-4 rounded-lg font-bold text-lg hover:bg-gray-600">
                                            <Icons.Download size={20} /> Backup Data
                                        </button>
                                        <div className="relative">
                                            <input type="file" accept=".json" onChange={restoreData} className="opacity-0 absolute inset-0 w-full h-full cursor-pointer" id="restore-input" />
                                            <label htmlFor="restore-input" className="w-full flex items-center justify-center gap-3 bg-blue-600 text-white p-4 rounded-lg font-bold text-lg cursor-pointer hover:bg-blue-500">
                                                <Icons.Upload size={20} /> Restore Data
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        {view === 'reports' && <ReportsView history={history} onBack={() => setView('menu')} />}
                        {view === 'hall-of-fame' && <HallOfFameView history={history} onResults={handleAnalysisResults} />}
                        {view === 'analysis-results' && <AnalysisResultsView analysisData={analysisResults} onBack={() => setView('hall-of-fame')} />}
                        {view === 'cardio' && <CardioForm history={history} onSave={handleSaveCardio} onCancel={() => setView('menu')} initialActivity={targetCardio} />}
                        {view === 'vitals' && <VitalsView history={history} onSave={handleVitalsSave} />}
                        {view === 'etp-menu' && <ETPMenuView onBack={() => setView('menu')} onSelect={(act) => { setTargetCardio(act); setView('cardio'); }} />}
                        {view === 'lucky' && (
                            <LuckyView
                                onBack={() => setView('menu')}
                                onSave={handleBonusSave}
                                availableExercises={masterExerciseList}
                                history={history}
                            />
                        )}
                        
                        {view === 'weights' && (
                            <div className="space-y-6">
                                <h2 className="text-2xl font-bold text-blue-400 border-b-4 border-blue-500 pb-2 mb-4">{activeRoutine}</h2>
                                
                                {todaysExercises.length === 0 && (
                                    <div className="mb-6">
                                        {history.some(w => !w.isCardio && w.routine === activeRoutine) ? (
                                            <button onClick={handleLoadLastWorkout} className="w-full bg-blue-900/50 text-blue-200 border-2 border-blue-800 py-6 px-6 rounded-lg font-bold text-xl shadow flex items-center justify-center gap-3 hover:bg-blue-900">
                                                <Icons.RefreshCw size={28} /> Load Last {activeRoutine}
                                            </button>
                                        ) : (
                                            <div className="p-4 bg-yellow-900/50 border border-yellow-700 rounded-lg text-yellow-200 text-center font-medium">
                                                No history found for {activeRoutine}. Start adding exercises below!
                                            </div>
                                        )}
                                    </div>
                                )}
                                
                                {/* ZONE 1: CURRENT EXERCISE */}
                                <h2 className="text-lg font-bold text-gray-300 uppercase tracking-wide mb-2 pl-1 border-b border-gray-700 pb-1">Current Exercise</h2>
                                {activeExercise ? (
                                    <div aria-live="polite">
                                        <ExerciseItem 
                                            key={activeExercise.id} 
                                            exercise={activeExercise} 
                                            isEditing={true} 
                                            isLast={false} 
                                            onEdit={setEditingId} 
                                            onDelete={removeExercise} 
                                            onUpdate={updateExercise} 
                                            onNext={handleNextExercise} 
                                            onSkip={handleSkipExercise} 
                                            previousBest={activeExercise.previousWeight} 
                                            previousData={{
                                                weight: activeExercise.previousWeight,
                                                sets: activeExercise.sets || (history.slice().reverse().find(h => !h.isCardio && h.exercises.some(e => e.name === activeExercise.name))?.exercises.find(e => e.name === activeExercise.name)?.sets),
                                                reps: activeExercise.reps || (history.slice().reverse().find(h => !h.isCardio && h.exercises.some(e => e.name === activeExercise.name))?.exercises.find(e => e.name === activeExercise.name)?.reps),
                                                notes: (history.slice().reverse().find(h => !h.isCardio && h.exercises.some(e => e.name === activeExercise.name))?.exercises.find(e => e.name === activeExercise.name)?.notes)
                                            }}
                                        />
                                    </div>
                                ) : (
                                    // SMART CONTROL CENTER
                                    todaysExercises.length > 0 && (
                                        <div className="p-6 bg-green-900/50 border-4 border-green-700 rounded-xl shadow-inner text-center space-y-4" role="alert">
                                            <h2 className="text-2xl font-bold text-green-300">âœ… Workout Complete!</h2>
                                            <p className="text-green-400">Up next queue is empty.</p>
                                            
                                            {/* NEW: EFFORT SCORE FOR WORKOUT */}
                                            <div className="bg-gray-800 p-4 rounded-lg border border-green-700 text-left">
                                                {/* FIX: Added unit="RPE" to avoid % display issue */}
                                                <AdjustableInput id="w-effort" label="Overall Workout Effort (1-10)" value={workoutEffort} onChange={setWorkoutEffort} step={1} unit="RPE" min={1} max={10} />
                                            </div>

                                            <div className="flex flex-col gap-3 mt-4">
                                                 <button ref={finishRef} onClick={finishWorkout} className="w-full py-5 bg-green-600 text-white text-2xl font-bold rounded-lg shadow-lg flex items-center justify-center gap-3 hover:bg-green-500"><Icons.Save size={32} /> Finish Workout Now</button>
                                                 
                                                 {/* REPLACED BUTTON WITH FORM */}
                                                 <div className="mt-4 pt-4 border-t border-green-700 text-left">
                                                    <p className="font-bold text-green-300 mb-2">Forgot an exercise? Add it here:</p>
                                                    <AddExerciseForm 
                                                        onAdd={handleAddExercise} 
                                                        routine={activeRoutine} 
                                                        availableExercises={availableExercises} 
                                                    />
                                                 </div>
                                            </div>
                                        </div>
                                    )
                                )}

                                {/* ZONE 2: UP NEXT QUEUE */}
                                <div>
                                    <div className="flex justify-between items-center mb-2 border-b border-gray-700 pb-1">
                                        <h2 className="text-lg font-bold text-gray-300 uppercase tracking-wide pl-1">Up Next Queue</h2>
                                        {/* JUMP TO ADD BUTTON */}
                                        <button onClick={() => handleAddExercise("New Exercise", false)} className="text-blue-400 font-bold text-sm bg-blue-900/50 px-3 py-1 rounded hover:bg-blue-900 border border-blue-700">
                                            + Add New
                                        </button>
                                    </div>
                                    {upNextExercises.length > 0 ? (
                                        <ul className="space-y-2 list-none p-0 opacity-70">
                                            {upNextExercises.map((ex, index) => (
                                                <li key={ex.id} className="bg-gray-800 p-4 rounded-lg border border-gray-700 flex justify-between">
                                                    <span className="font-bold text-gray-300">{ex.name}</span>
                                                    <span className="text-xs bg-gray-700 px-2 py-1 rounded text-gray-400">Waiting</span>
                                                </li>
                                            ))}
                                        </ul>
                                    ) : (
                                        <p className="text-gray-500 italic pl-1">Queue is empty.</p>
                                    )}
                                </div>

                                {/* ZONE 3: COMPLETED LOG */}
                                <div>
                                    <h2 className="text-lg font-bold text-gray-300 uppercase tracking-wide mb-2 pl-1 border-b border-gray-700 pb-1">Completed Log</h2>
                                    {completedExercises.length > 0 ? (
                                        <ul className="space-y-2 list-none p-0">
                                            {completedExercises.map((ex, index) => (
                                                <ExerciseItem 
                                                    key={ex.id} 
                                                    exercise={ex} 
                                                    isEditing={false} 
                                                    isLast={false} 
                                                    onEdit={setEditingId} 
                                                    onDelete={removeExercise} 
                                                    onUpdate={updateExercise} 
                                                    onNext={handleNextExercise} 
                                                    onSkip={handleSkipExercise} 
                                                    previousBest={ex.previousWeight} 
                                                />
                                            ))}
                                        </ul>
                                    ) : (
                                        <p className="text-gray-500 italic pl-1">Nothing completed yet.</p>
                                    )}
                                </div>

                                {/* ZONE 4: ADD NEW - ONLY SHOW IF NOT IN END GAME STATE */}
                                {activeExercise && (
                                    <div className="mt-8 border-t border-gray-700 pt-6">
                                        <h2 className="text-lg font-bold text-gray-300 uppercase tracking-wide mb-2 pl-1">Add New Exercise</h2>
                                        <AddExerciseForm onAdd={handleAddExercise} routine={activeRoutine} availableExercises={availableExercises} />
                                    </div>
                                )}
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
